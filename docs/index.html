<html lang="de">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Arbeitszeiten & Ferien ‚Äì Projekt-Charly</title>

    <!-- üî≤ App-Icon einf√ºgen -->
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">

    <!-- Optional: Theme-Farbe f√ºr Mobile -->
    <meta name="theme-color" content="#0f172a">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Arbeitszeit">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, sans-serif;
            background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%);
            min-height: 100vh;
            padding: 1.5rem;
        }

        body.dark {
            background: #111827;
            color: #E5E7EB;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        body.dark .card {
            background: #1F2937;
        }

        .kachel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .arbeitszeit-kachel {
            width: 100%;
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        body.dark .arbeitszeit-kachel {
            background: #374151;
            border-color: #4B5563;
        }

        .arbeitszeit-kachel-title {
            margin: 0 0 1.25rem 0;
            font-size: 1.125rem;
            color: #374151;
        }

        body.dark .arbeitszeit-kachel-title {
            color: #E5E7EB;
        }

        .card-sm {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }

        body.dark .card-sm {
            background: #374151;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 1.875rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: transform 0.2s;
            line-height: 1.5;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: #6366F1;
            color: white;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-sec {
            background: #F3F4F6;
            color: #1F2937;
        }

        body.dark .btn-sec {
            background: #374151;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 150px;
        }

        .tab.active {
            background: #6366F1;
            color: white;
        }

        .grad-blue {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .grad-purple {
            background: linear-gradient(135deg, #A855F7, #9333EA);
            color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .grad-green {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .grad-orange {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .grad-gray {
            background: linear-gradient(135deg, #9CA3AF, #6B7280);
            color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .grid2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .grid3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        input[type="time"],
        input[type="date"] {
            padding: 0.75rem 1.25rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            background: white;
            font-size: 1.125rem;
            cursor: pointer;
            min-width: 180px;
            box-sizing: border-box;
        }

        body.dark input[type="time"] label {
            color: #9CA3AF !important;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 0.75rem 1.25rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            background: white;
            font-size: 1rem;
            width: 100%;
            color: #1F2937;
        }

        body.dark input[type="time"],
        body.dark input[type="date"],
        body.dark input[type="text"],
        body.dark input[type="number"],
        body.dark select {
            background: #4B5563;
            border-color: #6B7280;
            color: white !important;
            color-scheme: dark;
        }

        .input-error {
            border: 2px solid #EF4444 !important;
            background: #FEE2E2 !important;
            color: #991B1B !important;
        }

        body.dark .input-error {
            background: #7F1D1D !important;
            color: #FEE2E2 !important;
            border-color: #EF4444 !important;
        }

        label {
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #6B7280;
            font-weight: 500;
        }

        body.dark label {
            color: #9CA3AF;
        }

        .time-label {
            font-size: 0.75rem;
            color: #6B7280;
            margin: 0;
            font-weight: 500;
        }

        body.dark .time-label {
            color: #D1D5DB;
        }

        .user-info-name {
            font-weight: 600;
            color: #374151;
        }

        body.dark .user-info-name {
            color: #E5E7EB;
        }

        #user-info {
            display: flex !important;
            flex-shrink: 0 !important;
            min-width: auto !important;
            flex-direction: column;
            align-items: flex-end;
            margin-left: 1rem;
        }

        body.dark .user-info-persnr {
            color: #9CA3AF;
        }

        .hidden {
            display: none !important;
        }



        .message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            text-align: center;
        }

        .msg-ok {
            background: #D1FAE5;
            color: #065F46;
        }

        .msg-err {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* WICHTIG: Verstecke Nachricht IMMER wenn sie leer ist */
        #msg:empty {
            display: none !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
        }

        .del-btn {
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 0.25rem;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0;
        }

        .cal {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .cal-day {
            min-height: 80px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .info-box {
            background: #EEF2FF;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        body.dark .info-box {
            background: #374151;
        }

        .clear-btn {
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            width: 40px;
            height: 38px;
            opacity: 1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .clear-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .clear-btn.on {
            opacity: 1;
        }

        /* Make clear button always visible but transparent when empty */
        .clear-btn {
            visibility: visible !important;
            opacity: 0;
            /* Hidden by default */
            pointer-events: none;
        }

        .clear-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .month-card {
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .feiertag {
            background: linear-gradient(135deg, #93C5FD 0%, #60A5FA 100%) !important;
            border-left: 4px solid #3B82F6 !important;
            color: #1F2937 !important;
        }

        body.dark .feiertag {
            background: linear-gradient(135deg, #1E3A8A 0%, #1E40AF 100%);
            border-left: 4px solid #60A5FA !important;
            color: white !important;
        }

        .feiertag-unbezahlt {
            background: linear-gradient(135deg, #F97316 0%, #EA580C 100%) !important;
            border-left: 4px solid #F97316 !important;
            color: #1F2937 !important;
        }

        body.dark .feiertag-unbezahlt {
            background: linear-gradient(135deg, #9A3412 0%, #C2410C 100%);
            border-left: 4px solid #FB923C !important;
            color: white !important;
        }

        div.card-sm.weekend {
            background: #D1D5DB !important;
            /* Dunkleres Grau f√ºr Light Mode - deutlich unterscheidbar */
            opacity: 1;
            color: #374151;
        }

        body.dark div.card-sm.weekend {
            background: #374151 !important;
            /* Gray 700 - Heller als Card, aber dunkler als Normal */
            opacity: 1;
            color: #D1D5DB;
        }

        /* ... */

        div.card-sm.tag-typ-normal {
            background: linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%) !important;
            border-left: 4px solid #9CA3AF !important;
            color: #1F2937;
        }

        label.tag-typ-label.tag-typ-normal {
            background: linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%) !important;
            border-left: 4px solid #9CA3AF !important;
            color: #1F2937 !important;
        }

        body.dark div.card-sm.tag-typ-normal {
            background: linear-gradient(135deg, #6B7280 0%, #9CA3AF 100%) !important;
            border-left: 4px solid #D1D5DB !important;
            color: white !important;
        }

        body.dark label.tag-typ-label.tag-typ-normal {
            background: linear-gradient(135deg, #6B7280 0%, #9CA3AF 100%) !important;
            border-left: 4px solid #D1D5DB !important;
            color: white !important;
        }

        div.card-sm.tag-urlaub,
        label.tag-typ-label.tag-urlaub {
            background: linear-gradient(135deg, #A7F3D0 0%, #6EE7B7 100%) !important;
            border-left: 4px solid #10B981 !important;
            color: #1F2937 !important;
        }

        body.dark div.card-sm.tag-urlaub,
        body.dark label.tag-typ-label.tag-urlaub {
            background: linear-gradient(135deg, #065F46 0%, #047857 100%) !important;
            border-left: 4px solid #34D399 !important;
            color: white !important;
        }

        div.card-sm.tag-krank,
        label.tag-typ-label.tag-krank {
            background: linear-gradient(135deg, #FDE68A 0%, #FCD34D 100%) !important;
            border-left: 4px solid #F59E0B !important;
            color: #1F2937 !important;
        }

        body.dark div.card-sm.tag-krank,
        body.dark label.tag-typ-label.tag-krank {
            background: linear-gradient(135deg, #92400E 0%, #B45309 100%) !important;
            border-left: 4px solid #FBBF24 !important;
            color: white !important;
        }

        div.card-sm.tag-unbezahlt,
        label.tag-typ-label.tag-unbezahlt {
            background: linear-gradient(135deg, #FECACA 0%, #FCA5A5 100%) !important;
            border-left: 4px solid #EF4444 !important;
            color: #1F2937 !important;
        }

        body.dark div.card-sm.tag-unbezahlt,
        body.dark label.tag-typ-label.tag-unbezahlt {
            background: linear-gradient(135deg, #991B1B 0%, #B91C1C 100%) !important;
            border-left: 4px solid #F87171 !important;
            color: white !important;
        }

        div.card-sm.tag-kompensation,
        label.tag-typ-label.tag-kompensation {
            background: linear-gradient(135deg, #D8B4FE 0%, #C4B5FD 100%) !important;
            border-left: 4px solid #A855F7 !important;
            color: #1F2937 !important;
        }

        body.dark div.card-sm.tag-kompensation,
        body.dark label.tag-typ-label.tag-kompensation {
            background: linear-gradient(135deg, #5B21B6 0%, #6D28D9 100%) !important;
            border-left: 4px solid #C084FC !important;
            color: white !important;
        }

        .emoji-large {
            font-size: 1.75rem !important;
            display: inline-block;
            line-height: 1;
        }

        .emoji-medium {
            font-size: 1.5rem !important;
            display: inline-block;
            line-height: 1;
        }

        .emoji-small {
            font-size: 1.25rem !important;
            display: inline-block;
            line-height: 1;
        }

        @media (max-width: 768px) {

            .nav-controls button {

                width: 44px;
                min-width: 44px;
                height: 44px !important;
                min-height: 44px !important;
                padding: 0 !important;

                line-height: 1 !important;

                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                flex-shrink: 0;
            }

            .nav-controls span {
                flex: 1 0 0% !important;
                min-width: 0;

            }

            .nav-controls button[onclick*="goToday"] {
                font-size: 0 !important;
            }

            .nav-controls button[onclick*="goToday"]::after {
                content: 'üìÖ';
                font-size: 1.2rem;
                font-weight: 600;

                display: flex !important;
                justify-content: center !important;
                align-items: center !important;

                margin-left: -6px;
            }
        }

        /* ‚úÖ √úberzeit-Eingabefelder - Textfarbe sichtbar halten */
        #settings-ueberzeit-datum,
        #settings-ueberzeit-start {
            color: #1F2937 !important;
            /* Dunkler Text f√ºr Light Mode */
        }

        /* √úberzeit-Eingabefelder - Dark Mode */
        body.dark #settings-ueberzeit-datum,
        body.dark #settings-ueberzeit-start {
            color: #1F2937 !important;
            /* Dunkler Text auch im Dark Mode (wegen gelbem Hintergrund) */
            background: #FEF3C7 !important;
            /* Heller gelber/beige Hintergrund */
            border-color: #F59E0B !important;
        }

        .tab {
            min-width: 120px;
            padding: 0.875rem 1rem;
            font-size: 1.05rem;
            font-weight: 600;
        }

        .grid2 {
            grid-template-columns: 1fr;
        }

        .grid3 {
            grid-template-columns: 1fr;
        }

        .grad-blue,
        .grad-purple,
        .grad-green,
        .grad-orange,
        .grad-gray {
            min-height: 100px;
            padding: 0.75rem;
        }

        .time-input-group {
            grid-template-columns: 1fr auto !important;
            gap: 0.5rem !important;
        }

        .time-input-group label {
            grid-column: 1 / -1;
            min-width: auto;
            margin-bottom: 0.25rem;
        }

        .time-input-group input[type="time"] {
            max-width: 100%;
            grid-column: 1;
        }

        .time-input-group .clear-btn {
            grid-column: 2;
        }

        .cal-day {
            min-height: 60px;
            font-size: 0.875rem;
        }

        .export-menu {
            position: absolute !important;
            top: 100% !important;
            right: 0 !important;
            left: auto !important;
            bottom: auto !important;
            margin-top: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 220px;
            display: block;
            padding: 0;
        }

        body.dark .export-menu {
            background: #1F2937;
            border: 1px solid #374151;
        }

        .export-btn {
            width: 100%;
            background: transparent;
            color: inherit;
            border: none;
            text-align: left;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.dark .export-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        body.export-open .export-menu {
            top: 60px !important;
        }

        /* üì± PORTRAIT MODE: Export-Men√º nach LINKS ausklappen (statt rechts) */
        @media (max-width: 480px) and (orientation: portrait) and (hover: none) and (pointer: coarse) {
            .export-menu {
                left: 0 !important;
                right: auto !important;
                max-width: calc(100vw - 1rem) !important;
                min-width: 200px !important;
            }
        }

        .view-navigation {
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 0.75rem !important;
        }

        .view-navigation h2 {
            text-align: center;
            font-size: 1.25rem;
            margin: 0;
        }

        .nav-controls {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 0.5rem !important;
            flex-wrap: nowrap !important;
            width: 100%;
        }

        .nav-controls button {
            flex-shrink: 0;
            min-width: 44px;
            padding: 0.75rem !important;
        }

        .nav-controls span {

            flex: 1 0 0% !important;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            font-size: 0.95rem;
        }

        /* üì± PORTRAIT MODE: SVG Icons f√ºr iPad Air */
        @media (max-width: 480px) and (orientation: portrait) and (hover: none) and (pointer: coarse) {

            /* Zeit-Input mit SVG Uhr-Icon und Placeholder */
            input[type="time"] {
                -webkit-appearance: none !important;
                appearance: none !important;
                background-image:
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239CA3AF' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' /%3E%3C/svg%3E"),
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='20' viewBox='0 0 60 20'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%239CA3AF' font-family='sans-serif' font-size='14'%3E-- : --%3C/text%3E%3C/svg%3E") !important;
                background-repeat: no-repeat, no-repeat !important;
                background-position: right 0.75rem center, center center !important;
                background-size: 1.25rem, 60px 20px !important;
            }

            /* Icon & Placeholder ausblenden wenn Wert vorhanden */
            input[type="time"].has-value {
                background-image: none !important;
            }

            /* Dark Mode: Hellere Icons/Text */
            body.dark input[type="time"] {
                background-image:
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23E5E7EB' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' /%3E%3C/svg%3E"),
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='20' viewBox='0 0 60 20'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23E5E7EB' font-family='sans-serif' font-size='14'%3E-- : --%3C/text%3E%3C/svg%3E") !important;
            }

            /* Clear-Button Visibility mit !important f√ºr iOS */
            .clear-btn {
                opacity: 0 !important;
                pointer-events: none !important;
            }

            .clear-btn.visible {
                opacity: 1 !important;
                pointer-events: auto !important;
            }
        }

        @media (max-width: 480px) and (hover: none) and (pointer: coarse) {
            body {
                padding: 0.75rem !important;
            }

            .container {
                max-width: 100% !important;
                overflow-x: hidden !important;
            }

            h1 {
                font-size: 1.25rem;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: auto;
            }

            /* Mobile Fixes f√ºr iPhone */
            .kachel-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .arbeitszeit-kachel {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                padding: 1rem !important;
            }

            /* Fix f√ºr Labels im Dark Mode - WEISS f√ºr Sichtbarkeit */
            label[for="mk"],
            label[for="mg"],
            label[for="mittk"],
            label[for="ag"] {
                color: #6B7280 !important;
                z-index: 10 !important;
                pointer-events: none !important;
                font-size: 0.875rem !important;
                transition: opacity 0.2s !important;
            }

            body.dark label[for="mk"],
            body.dark label[for="mg"],
            body.dark label[for="mittk"],
            body.dark label[for="ag"] {
                color: #FFFFFF !important;
                opacity: 0.9 !important;
            }

            /* Label ausblenden wenn Input Wert hat */
            label[for="mk"].hidden,
            label[for="mg"].hidden,
            label[for="mittk"].hidden,
            label[for="ag"].hidden {
                display: none !important;
            }

            /* Zeit-Input Rows: minimales gap */
            .arbeitszeit-kachel>div>div[style*="grid-row"] {
                gap: 0.125rem !important;
            }

            /* Fix f√ºr time inputs - zentriert mit gleichem Abstand */
            input[type="time"] {
                background: white !important;
                position: relative;
                z-index: 1;
                padding: 0.75rem !important;
                padding-right: 0.5rem !important;
                font-size: 0.9rem !important;
                border-radius: 0.5rem !important;
                text-align: center !important;
                -webkit-appearance: none;
                /* iOS Styling entfernen */
                appearance: none;

                /* Uhrzeit-Icon (rechts) UND Placeholder-Text (mitte) als Hintergrundbilder */
                background-image:
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239CA3AF' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' /%3E%3C/svg%3E"),
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='20' viewBox='0 0 60 20'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%239CA3AF' font-family='sans-serif' font-size='14'%3E-- : --%3C/text%3E%3C/svg%3E") !important;

                background-repeat: no-repeat, no-repeat !important;
                background-position: right 0.75rem center, center center !important;
                background-size: 1.25rem, 60px 20px !important;
            }

            /* Icon & Placeholder ausblenden wenn Wert vorhanden */
            input[type="time"].has-value {
                background-image: none !important;
            }

            body.dark input[type="time"] {
                background: #374151 !important;
                /* Dark Mode: Hellere Icons/Text */
                background-image:
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23E5E7EB' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' /%3E%3C/svg%3E"),
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='20' viewBox='0 0 60 20'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23E5E7EB' font-family='sans-serif' font-size='14'%3E-- : --%3C/text%3E%3C/svg%3E") !important;
            }

            /* Clear-Buttons sehr klein */
            .clear-btn {
                width: 30px !important;
                height: 30px !important;
                min-width: 30px !important;
                flex-shrink: 0 !important;
                font-size: 0.8rem !important;
                z-index: 20 !important;
                position: relative !important;
                visibility: visible !important;
                /* Always visible to keep layout stable */
                display: flex !important;
                top: auto !important;
                right: auto !important;
                transform: none !important;
                opacity: 0;
                /* Hidden by default */
                pointer-events: none;
            }

            .clear-btn.visible {
                opacity: 1 !important;
                pointer-events: auto !important;
                transition: opacity 0.2s ease !important;
            }

            /* NUR Mobile: Flex-wrap Layout f√ºr Zeitfelder */
            div[style*="grid-row: 3"],
            div[style*="grid-row: 4"],
            div[style*="grid-row: 5"],
            div[style*="grid-row: 6"] {
                display: flex !important;
                flex-wrap: wrap !important;
                align-items: center !important;
                gap: 1rem !important;
                /* Abstand Input <-> Button vergr√∂√üert */
                margin-bottom: 0 !important;
                /* Vertikaler Abstand zum n√§chsten Feld */
                padding-top: 0 !important;
            }

            /* WICHTIG: Grid-Rows auf auto setzen, damit Platz f√ºr Label + Input ist */
            .arbeitszeit-kachel>div {
                grid-template-rows: auto auto auto auto auto auto !important;
                gap: 0.5rem !important;
                /* Abstand zwischen den Grid-Zeilen vergr√∂√üert */
                display: flex !important;
                flex-direction: column !important;
            }

            /* Label nimmt volle Breite - erscheint in erster Zeile */
            div[style*="grid-row: 3"] label,
            div[style*="grid-row: 4"] label,
            div[style*="grid-row: 5"] label,
            div[style*="grid-row: 6"] label {
                flex-basis: 100% !important;
                position: static !important;
                transform: none !important;
                left: auto !important;
                top: auto !important;
                font-size: 0.75rem !important;
                color: #9CA3AF !important;
                margin-bottom: 0 !important;
                display: block !important;
            }

            body.dark div[style*="grid-row: 3"] label,
            body.dark div[style*="grid-row: 4"] label,
            body.dark div[style*="grid-row: 5"] label,
            body.dark div[style*="grid-row: 6"] label {
                color: #D1D5DB !important;
            }

            /* Input in zweiter Zeile - nimmt verf√ºgbaren Platz */
            div[style*="grid-row: 3"] input,
            div[style*="grid-row: 4"] input,
            div[style*="grid-row: 5"] input,
            div[style*="grid-row: 6"] input {
                flex: 1 !important;
                width: auto !important;
                max-width: none !important;
            }

            /* Button neben Input in zweiter Zeile */
            div[style*="grid-row: 3"] .clear-btn,
            div[style*="grid-row: 4"] .clear-btn,
            div[style*="grid-row: 5"] .clear-btn,
            div[style*="grid-row: 6"] .clear-btn {
                flex: 0 0 auto !important;
                flex: 0 0 auto !important;
                margin-left: 1.25rem !important;
                /* Erzwingt Abstand zum Input */
            }

            /* ‚úÖ √úberzeit-Verwaltung Mobile Portrait Fix */
            /* Stelle sicher, dass die gelben Input-Felder vertikal stacken */
            #settings-ueberzeit-datum,
            #settings-ueberzeit-start {
                width: 100% !important;
                max-width: 100% !important;
                display: block !important;
                margin-bottom: 0.75rem !important;
                box-sizing: border-box !important;
                font-size: 0.75rem !important;
                padding: 0.65rem !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                position: relative !important;
            }

            /* üî•üî• ULTRA-AGGRESSIVE: √úberschreibe ALLE inline-styles */
            /* Target: Gelbe Boxen + alle ihre Kinder */
            div[style*="background"][style*="FEF3C7"],
            div[style*="background"][style*="fef3c7"],
            div[style*="background"][style*="254, 243, 199"],
            div[style*="background-color"][style*="FEF3C7"],
            div[style*="background-color"][style*="fef3c7"],
            div[style*="background"][style*="rgb(254, 243, 199)"],
            div[style*="background"][style*="rgba(254, 243, 199"] {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                /* üéØ ZENTRIEREN */
                justify-content: center !important;
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                /* ‚ö° KRITISCH: √úberschreibe feste H√∂he */
                min-height: 60px !important;
                max-height: none !important;
                box-sizing: border-box !important;
                padding: 0.75rem !important;
                overflow: visible !important;
                position: relative !important;
                /* √úberschreibe absolute positioning */
                text-align: center !important;
                /* Text zentrieren */
            }

            /* Alle Kinder: volle Breite, vertical layout, KEINE absolute Position */
            div[style*="background"][style*="FEF3C7"]>*,
            div[style*="background"][style*="fef3c7"]>*,
            div[style*="background-color"][style*="FEF3C7"]>*,
            div[style*="background"][style*="rgb(254, 243, 199)"]>* {
                width: 85% !important;
                /* üéØ Etwas Platz lassen f√ºr Zentrierung */
                max-width: 350px !important;
                /* üéØ Begrenzte Breite wie gew√ºnscht */
                box-sizing: border-box !important;
                margin-bottom: 0.5rem !important;
                display: block !important;
                position: relative !important;
                /* ‚ö° KRITISCH: Reset alle Position-Properties */
                left: auto !important;
                right: auto !important;
                top: auto !important;
                bottom: auto !important;
                float: none !important;
                transform: none !important;
                text-align: center !important;
                /* Text in Labels zentrieren */
                margin-left: auto !important;
                margin-right: auto !important;
            }

            /* Generische Regel: ALLE inputs in Einstellungen - MUSS AUCH BEGRENZT SEIN */
            #v-einstellungen input[type="text"],
            #v-einstellungen input[type="date"],
            #v-einstellungen input[type="time"],
            #v-einstellungen input:not([type]) {
                max-width: 350px !important;
                /* üéØ Fix f√ºr Specificity Issue */
                width: 85% !important;
                /* üéØ Fix f√ºr Specificity Issue */
                box-sizing: border-box !important;
                font-size: 0.875rem !important;
                position: relative !important;
                text-align: center !important;
                /* Inputs zentrieren */
                margin-left: auto !important;
                margin-right: auto !important;
            }
        }

        /* üì± LANDSCAPE MODE: Gleiche Regeln f√ºr Querformat auf mobilen Ger√§ten */
        @media (max-height: 500px) and (orientation: landscape) and (hover: none) and (pointer: coarse) {

            /* ‚úÖ √úberzeit-Verwaltung auch im Querformat vertikal */
            div[style*="background"][style*="FEF3C7"],
            div[style*="background"][style*="fef3c7"],
            div[style*="background"][style*="254, 243, 199"],
            div[style*="background-color"][style*="FEF3C7"],
            div[style*="background-color"][style*="fef3c7"],
            div[style*="background"][style*="rgb(254, 243, 199)"],
            div[style*="background"][style*="rgba(254, 243, 199"] {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                /* üéØ ZENTRIEREN */
                justify-content: center !important;
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                min-height: 60px !important;
                max-height: none !important;
                box-sizing: border-box !important;
                padding: 0.75rem !important;
                overflow: visible !important;
                position: relative !important;
                text-align: center !important;
                /* Text zentrieren */
            }

            /* Alle Kinder: begrenzte Breite, zentriert */
            div[style*="background"][style*="FEF3C7"]>*,
            div[style*="background"][style*="fef3c7"]>*,
            div[style*="background-color"][style*="FEF3C7"]>*,
            div[style*="background"][style*="rgb(254, 243, 199)"]>* {
                width: 100% !important;
                max-width: 400px !important;
                /* üéØ Nicht zu breit werden lassen */
                box-sizing: border-box !important;
                margin-bottom: 0.5rem !important;
                display: block !important;
                position: relative !important;
                left: auto !important;
                right: auto !important;
                top: auto !important;
                bottom: auto !important;
                float: none !important;
                transform: none !important;
                text-align: center !important;
                /* Text in Labels zentrieren */
            }

            /* Inputs Text zentriert lassen */
            div[style*="background"][style*="FEF3C7"]>input,
            div[style*="background"][style*="fef3c7"]>input,
            div[style*="background-color"][style*="FEF3C7"]>input {
                text-align: center !important;
            }
        }

        /* Desktop: Zeit-Input Container */
        .arbeitszeit-kachel>div>div[style*="grid-row: 3"],
        .arbeitszeit-kachel>div>div[style*="grid-row: 4"],
        .arbeitszeit-kachel>div>div[style*="grid-row: 5"],
        .arbeitszeit-kachel>div>div[style*="grid-row: 6"] {
            display: flex !important;
            align-items: center !important;
            justify-content: flex-start !important;
            gap: 0.5rem !important;
            position: relative !important;
        }

        /* Label Styling */
        .arbeitszeit-kachel label[for="mk"],
        .arbeitszeit-kachel label[for="mg"],
        .arbeitszeit-kachel label[for="mittk"],
        .arbeitszeit-kachel label[for="ag"] {
            /* Position & Layout */
            position: static !important;
            transform: none !important;
            display: block !important;

            /* Spacing */
            margin: 0 !important;
            padding: 0 0.5rem !important;

            /* Sizing */
            width: auto !important;
            min-width: 140px !important;
            white-space: nowrap !important;

            /* Appearance */
            pointer-events: none !important;
            z-index: 10 !important;
            opacity: 1 !important;
            color: #6B7280 !important;
            font-size: 0.875rem !important;
        }

        /* Dark Mode Labels */
        body.dark .arbeitszeit-kachel label[for="mk"],
        body.dark .arbeitszeit-kachel label[for="mg"],
        body.dark .arbeitszeit-kachel label[for="mittk"],
        body.dark .arbeitszeit-kachel label[for="ag"] {
            color: #E5E7EB !important;
        }

        /* Zeit-Input */
        .arbeitszeit-kachel input[type="time"] {
            flex: 1 !important;
            text-align: center !important;
            padding-right: 0.75rem !important;
            padding-left: 0.75rem !important;
            min-width: 0 !important;
            /* Fix f√ºr Flexbox Overflow */
        }

        /* Clear Button */
        .arbeitszeit-kachel .clear-btn {
            position: static !important;
            transform: none !important;
            margin: 0 !important;
            margin-left: 1.5rem !important;
            /* 0.5rem gap + 1.5rem margin = 2rem zum Input */
            margin-right: 0.5rem !important;
            flex-shrink: 0 !important;
        }

        .google-one-tap__module,
        .google-one-tap-modal-div,
        #amp_floatingAdDiv,
        #ez-content-blocker-container {
            display: none !important;
            min-height: 0 !important;
            height: 0 !important;
        }
    </style>
    <style>
        :is([id*='google_ads_iframe'], [id*='taboola-'], .taboolaHeight, .taboola-placeholder, #top-ad, #credential_picker_container, #credentials-picker-container, #credential_picker_iframe, [id*='google-one-tap-iframe'], #google-one-tap-popup-container, .google-one-tap-modal-div, #amp_floatingAdDiv, #ez-content-blocker-container) {
            display: none !important;
            min-height: 0 !important;
            height: 0 !important;
        }
    </style>
    <style>
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
    <style>
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>

<body class="dark">
    <div class="container">
        <div class="header">
            <div class="card"
                style="flex: 1; min-width: 300px; margin: 0; display: flex; justify-content: space-between; align-items: center; position: relative;">
                <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1><span>üïê</span>Arbeitszeiten</h1>
                        <div style="font-size: 0.65rem; color: #9CA3AF; margin-top: 0.5rem; margin-left: 0.5rem;">
                            v1.2.81
                        </div>
                    </div>
                    <span style="font-size: 0.75rem; color: #9CA3AF; font-weight: normal;"></span>
                </div>
                <div id="user-info" style="text-align: right; font-size: 0.875rem; color: #6B7280; line-height: 1.4;">
                    <div class="user-info-name">Wyss Charly</div>
                    <div class="user-info-persnr">Pers. Nr. 1972</div>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sec card-sm" onclick="toggleDark()"><span id="icon">‚òÄÔ∏è</span></button>
                <div style="position: relative;">
                    <button class="btn btn-sec card-sm" onclick="toggleExport()">üì•</button>
                    <div id="export-menu" class="export-menu hidden">
                        <button class="export-btn time-export" onclick="exportBoth()">üì¶ Excel + PDF</button>
                        <button class="export-btn time-export" onclick="exportExcel()">üìä Excel (.xlsx)</button>
                        <button class="export-btn time-export" onclick="exportCSV()">üìÑ CSV (Deutsch)</button>
                        <button class="export-btn time-export" onclick="exportPDF()">üìï PDF</button>
                        <div class="time-export" style="border-top: 1px solid #E5E7EB; margin: 0.5rem 0;"></div>
                        <button class="export-btn settings-export" onclick="exportVollbackup()"
                            style="color: #10B981; font-weight: 600;">üíæ Voll-Backup erstellen</button>
                        <button class="export-btn settings-export" onclick="importVollbackup()"
                            style="color: #6366F1; font-weight: 600;">üì• Voll-Backup einlesen</button>
                        <div class="settings-export" style="border-top: 1px solid #E5E7EB; margin: 0.5rem 0;"></div>
                        <button class="export-btn time-export" onclick="importData()">üìä Excel/CSV importieren (nur
                            Zeiten)</button>
                        <button class="export-btn settings-export" onclick="downloadHTML()">üíæ HTML speichern</button>
                    </div>
                    <input type="file" id="import-file" accept=".xlsx,.csv" style="display: none;"
                        onchange="handleImport(event)">
                    <input type="file" id="backup-file" accept=".json" style="display: none;"
                        onchange="handleBackupImport(event)">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="btn tab" onclick="switchView('tag')">üìÖ Tag</button>
                <button class="btn tab" onclick="switchView('woche')">üìÖ Woche</button>
                <button class="btn tab" onclick="switchView('monat')">üìÖ Monat</button>
                <button class="btn tab active" onclick="switchView('jahr')">üìÖ Jahr</button>
                <button class="btn tab" onclick="switchView('einstellungen')"><span class="emoji-medium">‚öôÔ∏è</span>
                    Einstellungen</button>
            </div>
        </div>

        <div id="v-tag" class="card hidden">
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">Tagesansicht</h2>
                    <button class="btn btn-primary" onclick="goToday()" style="min-width: 70px;">Heute</button>
                </div>
                <div class="nav-controls"
                    style="display: flex; gap: 0.5rem; align-items: center; justify-content: center;">
                    <button class="btn btn-primary" onclick="prevDay()"
                        style="min-width: 44px; flex-shrink: 0;">‚Üê</button>
                    <span id="curr-date" class="datums-anzeige" style="flex: 1; text-align: center; min-width: 0;">KW
                        47&nbsp;&nbsp;&nbsp;&nbsp;Fr 21.11.2025</span>
                    <button class="btn btn-primary" onclick="nextDay()"
                        style="min-width: 44px; flex-shrink: 0;">‚Üí</button>
                </div>

                <div id="tag-typ-anzeige" class="hidden"
                    style="text-align: center; margin-top: 1rem; padding: 1rem; border-radius: 0.75rem; font-weight: 600; font-size: 1.125rem;">
                    <span id="tag-typ-icon" style="font-size: 1.5rem; margin-right: 0.5rem;"></span>
                    <span id="tag-typ-text"></span>
                </div>
            </div>
            <input type="date" id="selDate" style="display: none;">

            <div class="kachel-grid">

                <div class="arbeitszeit-kachel">
                    <h3 class="arbeitszeit-kachel-title">‚è∞ Arbeitszeiten</h3>
                    <div style="display: grid; grid-template-rows: 24px 54px 54px 54px 54px 54px; gap: 0.75rem;">
                        <!-- Zeile 1: Label -->
                        <label
                            style="grid-row: 1; font-weight: 600; font-size: 0.9375rem; line-height: 24px; align-self: start;">Zeiten</label>

                        <!-- Zeile 2: LEER (entspricht "Normaler Arbeitstag" rechts) -->

                        <!-- Zeile 3: Morgen Kommen -->
                        <div style="grid-row: 3;">
                            <label for="mk" id="label-mk">Morgen Kommen</label>
                            <input type="time" id="mk"
                                style="width: auto; height: 54px; box-sizing: border-box; padding: 0.75rem; border-radius: 0.5rem;"
                                oninput="toggleLabel('mk')" onchange="toggleLabel('mk')">
                            <button class="clear-btn" id="c-mk" onclick="clearField('mk')">‚úï</button>
                        </div>

                        <!-- Zeile 4: Morgen Gehen -->
                        <div style="grid-row: 4;">
                            <label for="mg" id="label-mg">Morgen Gehen</label>
                            <input type="time" id="mg"
                                style="width: auto; height: 54px; box-sizing: border-box; padding: 0.75rem; border-radius: 0.5rem;"
                                oninput="toggleLabel('mg')" onchange="toggleLabel('mg')">
                            <button class="clear-btn" id="c-mg" onclick="clearField('mg')">‚úï</button>
                        </div>

                        <!-- Zeile 5: Mittag Kommen -->
                        <div style="grid-row: 5;">
                            <label for="mittk" id="label-mittk">Mittag Kommen</label>
                            <input type="time" id="mittk"
                                style="width: auto; height: 54px; box-sizing: border-box; padding: 0.75rem; border-radius: 0.5rem;"
                                oninput="toggleLabel('mittk')" onchange="toggleLabel('mittk')">
                            <button class="clear-btn" id="c-mittk" onclick="clearField('mittk')">‚úï</button>
                        </div>

                        <!-- Zeile 6: Abend Gehen -->
                        <div style="grid-row: 6;">
                            <label for="ag" id="label-ag">Abend Gehen</label>
                            <input type="time" id="ag"
                                style="width: auto; height: 54px; box-sizing: border-box; padding: 0.75rem; border-radius: 0.5rem;"
                                oninput="toggleLabel('ag')" onchange="toggleLabel('ag')">
                            <button class="clear-btn" id="c-ag" onclick="clearField('ag')">‚úï</button>
                        </div>

                        <!-- Zeile 8: LEER (entspricht "√úberzeit-Kompensation" rechts) -->
                    </div>

                    <!-- Fehlermeldung innerhalb der Kachel -->
                    <!-- Fehlermeldungen / Erfolg -->
                    <div id="msg" class="message msg-ok hidden" style="margin-top: 0.75rem; text-align: center;"></div>
                </div>
            </div>
        </div>

        <!-- Zur√ºcksetzen und Speichern Buttons NACH dem kachel-grid -->
        <div style="display: flex; gap: 0.5rem; margin-top: 1.25rem;">
            <button class="btn btn-danger" style="flex: 1;" onclick="reset()">‚Üª Zur√ºcksetzen</button>
            <button class="btn btn-success" id="btn-save" style="flex: 1;" onclick="save()">üíæ Speichern</button>
        </div>

        <!-- Platzhalter f√ºr Warnbox (wird dynamisch eingef√ºgt) -->
        <div id="tagtyp-warning-container"></div>

        <div id="compact-result"
            style="margin-top: 1rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 0.5rem; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600; color: #6366F1;">‚è±Ô∏è Arbeitszeit:</span>
                <span id="compact-arb" style="font-weight: bold; font-size: 1.125rem;">--:--</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600;" id="compact-diff-label">Differenz:</span>
                <span id="compact-diff" style="font-weight: bold; font-size: 1.125rem;">--:--</span>
            </div>
        </div>

        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem;">

            <div class="grad-blue">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Arbeitszeit</div>
                        <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem; line-height: 1;" id="r-arb">
                            --:--</div>
                    </div>
                    <div
                        style="display: flex; flex-direction: column; align-items: flex-end; justify-content: flex-end; height: 100%;">
                        <div id="pause-info"
                            style="font-size: 0.75rem; font-style: italic; opacity: 0.75; margin-top: auto;">&nbsp;
                        </div>
                    </div>
                </div>
            </div>

            <div id="r-soll-card" class="grad-purple" style="position: relative;">
                <button onclick="toggleSollModus()"
                    style="position: absolute; top: 50%; right: 1.5rem; transform: translateY(-50%); background: rgba(255,255,255,0.3); border: none; border-radius: 0.5rem; padding: 0.75rem 1rem; cursor: pointer; color: white; font-size: 1.5rem; font-weight: 700; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.15);"
                    onmouseover="this.style.background='rgba(255,255,255,0.45)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.3)'">‚áÑ</button>
                <div style="padding-right: 80px;">
                    <div style="font-size: 0.875rem; opacity: 0.9;" id="soll-label">Sollzeit</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem; line-height: 1;"
                        id="r-soll-display">08:24</div>
                    <div style="font-size: 0.875rem; opacity: 0.85; margin-top: 0.5rem; text-align: right;"
                        id="soll-info">&nbsp;</div>
                </div>
            </div>

            <div id="r-diff-card" class="grad-orange">
                <div>
                    <div style="font-size: 0.875rem; opacity: 0.9;" id="r-diff-lbl">Fehlzeit Soll</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem; line-height: 1;" id="r-diff">
                        08:24</div>
                </div>
            </div>
        </div>
    </div>

    <div id="v-woche" class="card hidden">
        <div class="view-navigation" style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
            <h2>Wochenansicht</h2>
            <div class="nav-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary" onclick="wocheVor()">‚Üê</button>
                <span id="w-name">KW 47 17.11. - 23.11.2025</span>
                <button class="btn btn-primary" onclick="wocheWeiter()">‚Üí</button>
            </div>
        </div>
        <div class="grid3" style="margin-bottom:1.5rem;">
            <h3 class="arbeitszeit-kachel-title">üìã Zusatzoptionen</h3>
            <div style="display: grid; grid-template-rows: 24px 54px 54px 54px 54px 54px 54px 54px; gap: 0.75rem;">
                <!-- Zeile 1: Label -->
                <label
                    style="grid-row: 1; font-weight: 600; font-size: 0.9375rem; line-height: 24px; align-self: start;">Tag-Typ</label>

                <!-- Zeile 2: Normaler Arbeitstag -->
                <label class="tag-typ-label tag-typ-normal"
                    style="grid-row: 2; display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; height: 54px;">
                    <input type="radio" name="tagTyp" value="normal" checked="" onchange="updateTagTyp()"
                        style="margin-right: 0.5rem;">
                    <span class="emoji-medium">‚öôÔ∏è</span> <span>Normaler Arbeitstag</span>
                </label>

                <!-- Zeile 3: Bezahlter Feiertag -->
                <label class="tag-typ-label feiertag"
                    style="grid-row: 3; display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; height: 54px;">
                    <input type="radio" name="tagTyp" value="feiertag-bezahlt" onchange="updateTagTyp()"
                        style="margin-right: 0.5rem;">
                    <span class="emoji-medium">üîµ</span> <span>Bezahlter Feiertag</span>
                </label>

                <!-- Zeile 4: Unbezahlter Feiertag -->
                <label class="tag-typ-label feiertag-unbezahlt"
                    style="grid-row: 4; display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; height: 54px;">
                    <input type="radio" name="tagTyp" value="feiertag-unbezahlt" onchange="updateTagTyp()"
                        style="margin-right: 0.5rem;">
                    <span class="emoji-medium">üü†</span> <span>Unbezahlter Feiertag</span>
                </label>

                <!-- Zeile 5: Urlaub -->
                <label class="tag-typ-label tag-urlaub"
                    style="grid-row: 5; display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; height: 54px;">
                    <input type="radio" name="tagTyp" value="urlaub" onchange="updateTagTyp()"
                        style="margin-right: 0.5rem;">
                    <span class="emoji-medium">üèñÔ∏è</span> <span>Urlaub</span>
                </label>

                <!-- Zeile 6: Krankheit -->
                <label class="tag-typ-label tag-krank"
                    style="grid-row: 6; display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; height: 54px;">
                    <input type="radio" name="tagTyp" value="krank" onchange="updateTagTyp()"
                        style="margin-right: 0.5rem;">
                    <span class="emoji-medium">ü§í</span> <span>Krankheit</span>
                </label>

                <!-- Zeile 7: Unbezahlter Urlaub -->
                <label class="tag-typ-label tag-unbezahlt"
                    style="grid-row: 7; display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; height: 54px;">
                    <input type="radio" name="tagTyp" value="unbezahlt" onchange="updateTagTyp()"
                        style="margin-right: 0.5rem;">
                    <span class="emoji-medium">üìÖ</span> <span>Unbezahlter Urlaub</span>
                </label>

                <!-- Zeile 8: √úberzeit-Kompensation -->
                <label class="tag-typ-label tag-kompensation"
                    style="grid-row: 8; display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; height: 54px;">
                    <input type="radio" name="tagTyp" value="kompensation" onchange="updateTagTyp()"
                        style="margin-right: 0.5rem;">
                    <span class="emoji-medium">‚è∞</span> <span>√úberzeit-Kompensation</span>
                </label>

                <!-- Notiz am Ende au√üerhalb des Grids -->
                <div style="margin-top: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9375rem;">Notiz
                        (optional)</label>
                    <input type="text" id="notiz" placeholder="z.B. Projektname, Grund, etc." maxlength="100">
                </div>
            </div>
        </div>
    </div>


    <!-- Platzhalter f√ºr Warnbox (wird dynamisch eingef√ºgt) -->
    <div id="tagtyp-warning-container"></div>


    <div id="compact-result"
        style="margin-top: 1rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 0.5rem; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span style="font-weight: 600; color: #6366F1;">‚è±Ô∏è Arbeitszeit:</span>
            <span id="compact-arb" style="font-weight: bold; font-size: 1.125rem;">--:--</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 600;" id="compact-diff-label">Differenz:</span>
            <span id="compact-diff" style="font-weight: bold; font-size: 1.125rem;">--:--</span>
        </div>
    </div>

    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem;">

        <div class="grad-blue">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <div style="font-size: 0.875rem; opacity: 0.9;">Arbeitszeit</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem; line-height: 1;" id="r-arb">
                        --:--</div>
                </div>
                <div
                    style="display: flex; flex-direction: column; align-items: flex-end; justify-content: flex-end; height: 100%;">
                    <div id="pause-info"
                        style="font-size: 0.75rem; font-style: italic; opacity: 0.75; margin-top: auto;">&nbsp;
                    </div>
                </div>
            </div>
        </div>

        <div id="r-soll-card" class="grad-purple" style="position: relative;">
            <button onclick="toggleSollModus()"
                style="position: absolute; top: 50%; right: 1.5rem; transform: translateY(-50%); background: rgba(255,255,255,0.3); border: none; border-radius: 0.5rem; padding: 0.75rem 1rem; cursor: pointer; color: white; font-size: 1.5rem; font-weight: 700; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.15);"
                onmouseover="this.style.background='rgba(255,255,255,0.45)'"
                onmouseout="this.style.background='rgba(255,255,255,0.3)'">‚áÑ</button>
            <div style="padding-right: 80px;">
                <div style="font-size: 0.875rem; opacity: 0.9;" id="soll-label">Sollzeit</div>
                <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem; line-height: 1;"
                    id="r-soll-display">08:24</div>
                <div style="font-size: 0.875rem; opacity: 0.85; margin-top: 0.5rem; text-align: right;" id="soll-info">
                    &nbsp;</div>
            </div>
        </div>

        <div id="r-diff-card" class="grad-orange">
            <div>
                <div style="font-size: 0.875rem; opacity: 0.9;" id="r-diff-lbl">Fehlzeit Soll</div>
                <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem; line-height: 1;" id="r-diff">
                    08:24</div>
            </div>
        </div>
    </div>
    </div>

    <div id="v-woche" class="card hidden">
        <div class="view-navigation" style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
            <h2>Wochenansicht</h2>
            <div class="nav-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary" onclick="wocheVor()">‚Üê</button>
                <span id="w-name">KW 47 17.11. - 23.11.2025</span>
                <button class="btn btn-primary" onclick="wocheWeiter()">‚Üí</button>
            </div>
        </div>
        <div class="grid3" style="margin-bottom: 1.5rem;">
            <div class="grad-blue">
                <div style="font-size: 0.875rem;">Arbeitszeit Woche</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="w-arb">17:28</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="w-info">4 / 5 Tage</div>
                </div>
            </div>
            <div class="grad-purple">
                <div style="font-size: 0.875rem;">Sollzeit Woche</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="w-soll">42:00</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="w-soll-info">5 Tage</div>
                </div>
            </div>
            <div id="w-diff-card" class="grad-orange">
                <div style="font-size: 0.875rem;" id="w-diff-lbl">Fehlzeit Woche</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="w-diff">24:32</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="w-diff-info">4 / 5 Tage</div>
                </div>
            </div>
        </div>
        <div id="w-list">
            <div class="flex-col">
                <div class="card-sm " style="cursor: pointer;" onclick="jumpToDate('2025-11-17')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">Mo 17.11.2025</div>


                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: bold;">09:28</div>
                            <div style="font-size: 0.875rem; color: #10B981; font-weight: bold;">+01:04</div>
                        </div>
                    </div>
                </div>
                <div class="card-sm " style="cursor: pointer;" onclick="jumpToDate('2025-11-18')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">Di 18.11.2025</div>

                            <div style="font-size: 0.75rem; opacity: 0.75; margin-top: 0.25rem; font-style: italic;">
                                üìù LS8- ACM</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: bold;">08:00</div>
                            <div style="font-size: 0.875rem; color: #EF4444; font-weight: bold;">-00:24</div>
                        </div>
                    </div>
                </div>
                <div class="card-sm tag-krank" style="cursor: pointer;" onclick="jumpToDate('2025-11-19')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;"><span class="emoji-medium">ü§í</span> Mi 19.11.2025</div>

                            <div style="font-size: 0.75rem; opacity: 0.75; margin-top: 0.25rem; font-style: italic;">
                                üìù R√ºckenschmerzen Krank geschri...</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: bold;">--:--</div>
                            <div style="font-size: 0.875rem; color: #F59E0B;">Krankheit</div>
                        </div>
                    </div>
                </div>
                <div class="card-sm tag-krank" style="cursor: pointer;" onclick="jumpToDate('2025-11-20')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;"><span class="emoji-medium">ü§í</span> Do 20.11.2025</div>

                            <div style="font-size: 0.75rem; opacity: 0.75; margin-top: 0.25rem; font-style: italic;">
                                üìù R√ºckenschmerzen</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: bold;">--:--</div>
                            <div style="font-size: 0.875rem; color: #F59E0B;">Krankheit</div>
                        </div>
                    </div>
                </div>
                <div class="card-sm tag-krank" style="cursor: pointer;" onclick="jumpToDate('2025-11-21')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;"><span class="emoji-medium">ü§í</span> Fr 21.11.2025</div>

                            <div style="font-size: 0.75rem; opacity: 0.75; margin-top: 0.25rem; font-style: italic;">
                                üìù R√ºckenschmerzen</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: bold;">--:--</div>
                            <div style="font-size: 0.875rem; color: #F59E0B;">Krankheit</div>
                        </div>
                    </div>
                </div>
                <div class="card-sm " style="cursor: pointer;" onclick="jumpToDate('2025-11-22')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">Sa 22.11.2025</div>


                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: bold;">--:--</div>
                            <div style="font-size: 0.875rem; color: #6B7280;">- Wochenende</div>
                        </div>
                    </div>
                </div>
                <div class="card-sm " style="cursor: pointer;" onclick="jumpToDate('2025-11-23')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">So 23.11.2025</div>


                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: bold;">--:--</div>
                            <div style="font-size: 0.875rem; color: #6B7280;">- Wochenende</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="v-monat" class="card hidden">
        <div class="view-navigation" style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
            <h2>Monatsansicht</h2>
            <div class="nav-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary" onclick="monatVor()">‚Üê</button>
                <span id="m-name"
                    style="padding: 0.5rem 1rem; font-weight: 600; min-width: 200px; text-align: center; display: inline-block;">November
                    2025</span>
                <button class="btn btn-primary" onclick="monatWeiter()">‚Üí</button>
            </div>
        </div>
        <div class="grid3" style="margin-bottom: 1.5rem;">
            <div class="grad-blue">
                <div style="font-size: 0.875rem;">Arbeitszeit Monat</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="m-arb">17:28</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="m-info">12 / 20 Tage</div>
                </div>
            </div>
            <div class="grad-purple">
                <div style="font-size: 0.875rem;">Sollzeit Monat</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="m-soll">168:00</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="m-soll-info">20 Tage</div>
                </div>
            </div>
            <div id="m-diff-card" class="grad-orange">
                <div style="font-size: 0.875rem;" id="m-diff-lbl">Fehlzeit Monat</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="m-diff">150:32</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="m-diff-info">12 / 20 Tage</div>
                </div>
            </div>
        </div>
        <div
            style="display: flex; justify-content: space-between; margin-top: 0.75rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 0.5rem;">
            <div style="text-align: center; flex: 1;">
                <div style="font-size: 0.75rem; color: #6B7280;" id="m-urlaub-jahr-label">Urlaubstage im Jahr 2025
                </div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #6366F1;" id="m-urlaub-gesamt">27</div>
            </div>
            <div style="text-align: center; flex: 1; border-left: 1px solid #D1D5DB; border-right: 1px solid #D1D5DB;">
                <div style="font-size: 0.75rem; color: #6B7280;">bezogene Tage</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #EF4444;" id="m-urlaub-verbraucht">8</div>
            </div>
            <div style="text-align: center; flex: 1;">
                <div style="font-size: 0.75rem; color: #6B7280;">verf√ºgbare Tage</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #10B981;" id="m-urlaub-rest">19</div>
            </div>
        </div>
        <div style="margin-top: 1rem; margin-bottom: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="showMassenUrlaubDialog()" style="flex: 1;">üìÖ Urlaub √ºber
                Zeitraum eintragen</button>
            <button class="btn btn-danger" onclick="toggleUrlaubLoeschModus()" style="flex: 1;"
                id="urlaub-loeschen-btn-monat">üóëÔ∏è Mehrere Urlaubstage l√∂schen</button>
        </div>
        <div class="cal" id="m-cal">
            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: #6B7280;">Mo</div>
            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: #6B7280;">Di</div>
            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: #6B7280;">Mi</div>
            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: #6B7280;">Do</div>
            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: #6B7280;">Fr</div>
            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: #6B7280;">Sa</div>
            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: #6B7280;">So</div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div class="card-sm cal-day feiertag" data-date="2025-11-01"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-01')">
                <div style="font-weight: 600;">1</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.7rem; opacity: 0.85; line-height: 1.1; margin-bottom: 0.15rem;">üîµ
                        Allerheiligen</div>


                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-02"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-02')">
                <div style="font-weight: 600;">2</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day tag-urlaub" data-date="2025-11-03"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-03')">
                <div style="font-weight: 600;">3</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">üèñÔ∏è</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day tag-urlaub" data-date="2025-11-04"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-04')">
                <div style="font-weight: 600;">4</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">üèñÔ∏è</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day tag-urlaub" data-date="2025-11-05"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-05')">
                <div style="font-weight: 600;">5</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">üèñÔ∏è</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-06"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-06')">
                <div style="font-weight: 600;">6</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-07"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-07')">
                <div style="font-weight: 600;">7</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-08"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-08')">
                <div style="font-weight: 600;">8</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-09"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-09')">
                <div style="font-weight: 600;">9</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-10"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-10')">
                <div style="font-weight: 600;">10</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-11"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-11')">
                <div style="font-weight: 600;">11</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-12"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-12')">
                <div style="font-weight: 600;">12</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-13"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-13')">
                <div style="font-weight: 600;">13</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-14"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-14')">
                <div style="font-weight: 600;">14</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-15"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-15')">
                <div style="font-weight: 600;">15</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-16"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-16')">
                <div style="font-weight: 600;">16</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-17"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-17')">
                <div style="font-weight: 600;">17</div>
                <div style="text-align: right;">

                    <div style="font-size: 0.875rem; font-weight: bold;">09:28</div>
                    <div style="font-size: 0.75rem; color: #10B981;">+01:04</div>
                </div>
            </div>
            <div class="card-sm cal-day " data-date="2025-11-18"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-18')">
                <div style="font-weight: 600;">18</div>
                <div style="text-align: right;">

                    <div style="font-size: 0.875rem; font-weight: bold;">08:00</div>
                    <div style="font-size: 0.75rem; color: #EF4444;">-00:24</div>
                </div>
            </div>
            <div class="card-sm cal-day tag-krank" data-date="2025-11-19"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-19')">
                <div style="font-weight: 600;">19</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">ü§í</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day tag-krank" data-date="2025-11-20"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-20')">
                <div style="font-weight: 600;">20</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">ü§í</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day tag-krank" data-date="2025-11-21"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-21')">
                <div style="font-weight: 600;">21</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">ü§í</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-22"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-22')">
                <div style="font-weight: 600;">22</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-23"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-23')">
                <div style="font-weight: 600;">23</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day tag-urlaub" data-date="2025-11-24"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-24')">
                <div style="font-weight: 600;">24</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">üèñÔ∏è</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day tag-urlaub" data-date="2025-11-25"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-25')">
                <div style="font-weight: 600;">25</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">üèñÔ∏è</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day tag-urlaub" data-date="2025-11-26"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-26')">
                <div style="font-weight: 600;">26</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">üèñÔ∏è</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day tag-urlaub" data-date="2025-11-27"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-27')">
                <div style="font-weight: 600;">27</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">üèñÔ∏è</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day tag-urlaub" data-date="2025-11-28"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-28')">
                <div style="font-weight: 600;">28</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; margin-bottom: 0.15rem;"><span class="emoji-medium">üèñÔ∏è</span>
                    </div>


                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-29"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-29')">
                <div style="font-weight: 600;">29</div>
                <div style="text-align: right;">



                </div>
            </div>
            <div class="card-sm cal-day weekend" data-date="2025-11-30"
                style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;"
                onclick="jumpToDate('2025-11-30')">
                <div style="font-weight: 600;">30</div>
                <div style="text-align: right;">



                </div>
            </div>
        </div>
    </div>

    <div id="v-jahr" class="card">
        <div class="view-navigation" style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
            <h2>Jahresansicht</h2>
            <div class="nav-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary" onclick="jahrVor()">‚Üê</button>
                <span id="j-name"
                    style="padding: 0.5rem 1rem; font-weight: 600; min-width: 100px; text-align: center; display: inline-block;">2025</span>
                <button class="btn btn-primary" onclick="jahrWeiter()">‚Üí</button>
            </div>
        </div>
        <div class="grid3" style="margin-bottom: 1.5rem;">
            <div class="grad-blue">
                <div style="font-size: 0.875rem;">Arbeitszeit Jahr</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="j-arb">08:06</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="j-info">16 / 261 Tage</div>
                </div>
            </div>
            <div class="grad-purple">
                <div style="font-size: 0.875rem;">Sollzeit Jahr</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="j-soll">2192:24</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="j-soll-info">261 Tage</div>
                </div>
            </div>
            <div id="j-diff-card" class="grad-orange">
                <div style="font-size: 0.875rem;" id="j-diff-lbl">Fehlzeit Jahr</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="font-size: 2rem; font-weight: bold;" id="j-diff">2184:18</div>
                    <div style="font-size: 0.75rem; font-style: italic;" id="j-diff-info">16 / 261 Tage</div>
                </div>
            </div>
        </div>
        <div
            style="display: flex; justify-content: space-between; margin-top: 0.75rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 0.5rem;">
            <div style="text-align: center; flex: 1;">
                <div style="font-size: 0.75rem; color: #6B7280;" id="j-urlaub-jahr-label">Urlaubstage im Jahr 2025
                </div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #6366F1;" id="j-urlaub-gesamt">27</div>
            </div>
            <div style="text-align: center; flex: 1; border-left: 1px solid #D1D5DB; border-right: 1px solid #D1D5DB;">
                <div style="font-size: 0.75rem; color: #6B7280;">bezogene Tage</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #EF4444;" id="j-urlaub-verbraucht">8</div>
            </div>
            <div style="text-align: center; flex: 1;">
                <div style="font-size: 0.75rem; color: #6B7280;">verf√ºgbare Tage</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #10B981;" id="j-urlaub-rest">19</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;" id="j-list">
            <div class="card-sm month-card" onclick="jumpToMonth('2025-01')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Jan 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">193:12</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">193:12</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">2 / 23 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-02')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Feb 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">168:00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">168:00</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">0 / 20 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-03')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">M√§r 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">176:24</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">176:24</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">0 / 21 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-04')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Apr 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">184:48</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">184:48</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">0 / 22 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-05')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Mai 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">184:48</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">184:48</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">0 / 22 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-06')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Jun 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">176:24</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">176:24</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">1 / 21 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-07')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Jul 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">193:12</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">193:12</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">0 / 23 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-08')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Aug 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">176:24</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">176:24</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">1 / 21 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-09')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Sep 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">184:48</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">184:48</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">0 / 22 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-10')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Okt 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">193:12</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">193:12</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">0 / 23 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-11')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Nov 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">08:06</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">168:00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">159:54</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">11 / 20 Tage</div>
            </div>
            <div class="card-sm month-card" onclick="jumpToMonth('2025-12')">
                <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">Dez 2025</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                    <span style="font-weight: bold;">00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                    <span style="font-weight: bold;">193:12</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                    <span style="color: #6B7280; font-size: 0.875rem;">Fehlzeit:</span>
                    <span style="font-weight: bold; color: #EF4444;">193:12</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">1 / 23 Tage</div>
            </div>
        </div>
    </div>

    <div id="v-einstellungen" class="card hidden">
        <h2 style="margin-bottom: 1.5rem;">‚öôÔ∏è Einstellungen</h2>

        <div class="grid2" style="gap: 1.5rem;">

            <div class="card-sm">
                <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Arbeitszeit-Einstellungen</h3>
                <div class="flex-col">
                    <div>
                        <label>Sollzeit pro Woche (Stunden)</label>
                        <input type="number" id="soll-woche" min="0" max="60" step="0.5" value="42"
                            onchange="updateSollFromWoche()"
                            style="width: 100%; padding: 0.75rem 1rem; font-size: 1rem;" data-ddg-inputtype="unknown">
                    </div>
                    <div>
                        <label>Standard-Sollzeit pro Tag (berechnet aus Woche √∑ 5)</label>
                        <input type="time" id="soll" value="08:24" onchange="updateSettings()" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">
                            Wird automatisch berechnet: <span id="soll-berechnet">42h √∑ 5 = 8:24</span>
                        </div>
                    </div>
                    <div>
                        <label>Pausendauer (ab 6h Arbeitszeit)</label>
                        <input type="time" id="pause" value="00:30" onchange="updateSettings()" style="width: 100%;">
                    </div>
                    <div>
                        <label>√úberzeit-Vorgabe (z.B. 09:00)</label>
                        <input type="time" id="ueberzeit-vorgabe" value="09:00" onchange="updateSettings()"
                            style="width: 100%;">
                    </div>
                    <div>
                        <label>Resturlaub aus Vorjahr</label>
                        <input type="number" id="settings-resturlaub" min="0" max="50" value="0"
                            onchange="updateSettings()" style="width: 100%; padding: 0.75rem 1rem; font-size: 1rem;"
                            data-ddg-inputtype="unknown">
                    </div>
                    <div>
                        <label>Urlaubstage pro Jahr</label>
                        <input type="number" id="settings-urlaub" min="0" max="50" value="25"
                            onchange="updateSettings()" style="width: 100%; padding: 0.75rem 1rem; font-size: 1rem;"
                            data-ddg-inputtype="unknown">
                        <div
                            style="display: flex; justify-content: space-between; margin-top: 0.75rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 0.5rem;">
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 0.75rem; color: #6B7280;" id="urlaub-jahr-label">Urlaubstage
                                    im Jahr 2025</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: #6366F1;" id="urlaub-gesamt">27
                                </div>
                            </div>
                            <div
                                style="text-align: center; flex: 1; border-left: 1px solid #D1D5DB; border-right: 1px solid #D1D5DB;">
                                <div style="font-size: 0.75rem; color: #6B7280;">bezogene Tage</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: #EF4444;"
                                    id="urlaub-verbraucht">8</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 0.75rem; color: #6B7280;">verf√ºgbare Tage</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: #10B981;" id="urlaub-rest">
                                    19</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn btn-primary" onclick="showMassenUrlaubDialog()" style="flex: 1;">üìÖ
                                Urlaub √ºber Zeitraum eintragen</button>
                            <button class="btn btn-danger" onclick="toggleUrlaubLoeschModus()" style="flex: 1;"
                                id="urlaub-loeschen-btn">üóëÔ∏è Mehrere Urlaubstage l√∂schen</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-sm">
                <h3 style="margin-bottom: 0.4rem; font-size: 1rem;">‚è∞ √úberzeit-Verwaltung</h3>

                <!-- Eingabefelder mit absoluter Positionierung - PASSEN SIE DIE PX-WERTE AN -->
                <div
                    style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 0.4rem; padding: 0.4rem 0.6rem; border: 1px solid #FBBF24; margin-bottom: 0.5rem; position: relative; height: 45px;">
                    <!-- STAND per : Horizontal=130px, Vertikal=zentriert -->
                    <div
                        style="position: absolute; left: 125px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 0.3rem;">
                        <label
                            style="font-size: 0.7rem; color: #92400E; font-weight: 700; white-space: nowrap; line-height: 26px;">per
                            STAND:</label>
                        <input type="date" id="settings-ueberzeit-datum" value="" onchange="updateSettings()"
                            style="height: 26px; padding: 0 0.3rem; font-size: 0.85rem; font-weight: 700; border: 1px solid #F59E0B; border-radius: 0.25rem; background: white; width: 110px; text-align: center;">
                    </div>
                    <!-- √úBERZEIT: Horizontal=500px, Vertikal=zentriert -->
                    <div
                        style="position: absolute; left: 500px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 0.3rem;">
                        <label
                            style="font-size: 0.7rem; color: #92400E; font-weight: 700; text-transform: uppercase; white-space: nowrap; line-height: 26px;">√úBERZEIT:</label>
                        <input type="text" id="settings-ueberzeit-start" placeholder="+131:23"
                            onkeydown="handleUeberzeitKeydown(event)" onblur="updateSettings()"
                            style="height: 26px; padding: 0 0.4rem; font-size: 0.85rem; font-weight: 700; border: 1px solid #F59E0B; border-radius: 0.25rem; background: white; width: 90px; text-align: center; font-family: monospace;"
                            data-ddg-inputtype="unknown">
                    </div>
                    <!-- Hilfetext rechts unten -->
                    <div
                        style="position: absolute; right: 25px; bottom: 15px; font-size: 0.65rem; color: #92400E; opacity: 1;">
                        ( Eingabe: z.B. 12:45 ‚èé oder wenn minus -15:25 ‚èé )
                    </div>
                </div>

                <!-- √úbersicht-Box -->
                <div id="ueberzeit-stats"
                    style="padding: 0.5rem; background: rgba(99, 102, 241, 0.08); border-radius: 0.5rem; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                        <!-- Stand - Positioniert an erster roter Linie -->
                        <div style="text-align: center; min-width: 100px;">
                            <div style="font-size: 0.65rem; margin-bottom: 0.2rem; font-weight: 600; opacity: 0.7;">
                                Stand <span id="stats-datum-display">01.01.2025</span></div>
                            <div style="font-weight: 700; font-size: 1.25rem; margin-bottom: 0.1rem;"
                                id="ueberzeit-start-display">+131:23</div>
                            <div style="font-size: 0.65rem; opacity: 0.6; font-family: monospace;"
                                id="ueberzeit-start-industrial">+131.38h</div>
                        </div>
                        <div style="font-size: 1.2rem; opacity: 0.4; font-weight: 300;">‚Üí</div>
                        <!-- Erarbeitet - Positioniert an zweiter roter Linie -->
                        <div style="text-align: center; min-width: 100px;">
                            <div style="font-size: 0.65rem; margin-bottom: 0.2rem; font-weight: 600; opacity: 0.7;">
                                Erarbeitet</div>
                            <div style="font-weight: 700; font-size: 1.25rem; margin-bottom: 0.1rem; color: #10B981;"
                                id="ueberzeit-erarbeitet">-08:42</div>
                            <div style="font-size: 0.65rem; opacity: 0.6; font-family: monospace;"
                                id="ueberzeit-erarbeitet-industrial">-8.70h</div>
                        </div>
                        <div style="font-size: 1.2rem; opacity: 0.4; font-weight: 300;">‚àí</div>
                        <!-- Bezogen - Positioniert an dritter roter Linie -->
                        <div style="text-align: center; min-width: 100px;">
                            <div style="font-size: 0.65rem; margin-bottom: 0.2rem; font-weight: 600; opacity: 0.7;">
                                Bezogen</div>
                            <div style="font-weight: 700; font-size: 1.25rem; margin-bottom: 0.1rem; color: #EF4444;"
                                id="ueberzeit-bezogen">16:48</div>
                            <div style="font-size: 0.65rem; opacity: 0.6; font-family: monospace;"
                                id="ueberzeit-bezogen-industrial">16.88h</div>
                        </div>
                        <div style="font-size: 1.2rem; opacity: 0.4; font-weight: 300;">=</div>
                        <!-- Aktuell - Positioniert an vierter roter Linie -->
                        <div style="text-align: center; min-width: 100px;">
                            <div style="font-size: 0.65rem; margin-bottom: 0.2rem; font-weight: 600; opacity: 0.7;">
                                Aktuell</div>
                            <div style="font-weight: 700; font-size: 1.25rem; margin-bottom: 0.1rem; color: rgb(16, 185, 129);"
                                id="ueberzeit-aktuell">+105:53</div>
                            <div style="font-size: 0.65rem; opacity: 0.6; font-family: monospace;"
                                id="ueberzeit-aktuell-industrial">+105.88h</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-sm">
                <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Personalisierung</h3>
                <div class="flex-col">
                    <div>
                        <label>Name</label>
                        <input type="text" id="settings-name" placeholder="Ihr Name" onchange="updateSettings()"
                            style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; font-size: 0.875rem;"
                            data-ddg-inputtype="identities.fullName" data-ddg-autofill="true">
                    </div>
                    <div>
                        <label>Personalnummer</label>
                        <input type="text" id="settings-personalnummer" placeholder="12345" onchange="updateSettings()"
                            style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; font-size: 0.875rem;"
                            data-ddg-inputtype="unknown">
                    </div>
                </div>
            </div>

            <div class="card-sm">
                <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Feiertage</h3>
                <div class="flex-col">
                    <div>
                        <label>Kanton</label>
                        <select id="settings-kanton" onchange="updateSettings()"
                            style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; font-size: 0.875rem;"
                            data-ddg-inputtype="unknown">
                            <option value="">-- Kanton w√§hlen --</option>
                            <option value="ZH">Z√ºrich</option>
                            <option value="BE">Bern</option>
                            <option value="LU">Luzern</option>
                            <option value="UR">Uri</option>
                            <option value="SZ">Schwyz</option>
                            <option value="OW">Obwalden</option>
                            <option value="NW">Nidwalden</option>
                            <option value="GL">Glarus</option>
                            <option value="ZG">Zug</option>
                            <option value="FR">Freiburg</option>
                            <option value="SO">Solothurn</option>
                            <option value="BS">Basel-Stadt</option>
                            <option value="BL">Basel-Landschaft</option>
                            <option value="SH">Schaffhausen</option>
                            <option value="AR">Appenzell Ausserrhoden</option>
                            <option value="AI">Appenzell Innerrhoden</option>
                            <option value="SG">St. Gallen</option>
                            <option value="GR">Graub√ºnden</option>
                            <option value="AG">Aargau</option>
                            <option value="TG">Thurgau</option>
                            <option value="TI">Tessin</option>
                            <option value="VD">Waadt</option>
                            <option value="VS">Wallis</option>
                            <option value="NE">Neuenburg</option>
                            <option value="GE">Genf</option>
                            <option value="JU">Jura</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="importFeiertage()">üìÇ
                            Feiertags-JSON importieren</button>
                        <input type="file" id="feiertag-file" accept=".json" style="display: none;"
                            onchange="handleFeiertagImport(event)">
                    </div>
                    <div>
                        <button class="btn btn-success" style="width: 100%;" onclick="showAddFeiertagDialog()">‚ûï
                            Feiertag manuell hinzuf√ºgen</button>
                    </div>
                    <div id="feiertag-info" style="font-size: 0.875rem; color: #6B7280;"></div>
                </div>
            </div>
        </div>

        <div class="card-sm" style="margin-top: 1.5rem;">
            <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Geladene Feiertage <span id="feiertag-jahr"></span>
            </h3>
            <div id="feiertag-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>

        <div class="info-box" style="margin-top: 1.5rem;">
            <h4 style="margin-bottom: 0.5rem; font-weight: 600;">‚ÑπÔ∏è Feiertags-Handling</h4>
            <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li><strong>Bezahlte Feiertage:</strong> Z√§hlen NICHT als Fehlzeit (blau markiert üîµ)</li>
                <li><strong>Unbezahlte Feiertage:</strong> M√ºssen genommen werden, belasten aber das Zeitkonto
                    (orange markiert üü†)</li>
                <li><strong>Br√ºckentage:</strong> Optional, belasten Zeitkonto wenn genommen (lila markiert üü£)</li>
                <li>Arbeit an Feiertagen wird als <strong>volle √úberzeit</strong> gez√§hlt</li>
                <li>Import eine JSON-Datei mit Feiertagen f√ºr automatische Verwaltung</li>
            </ul>
        </div>
    </div>
    </div>

    <div id="feiertag-modal" class="hidden"
        style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div class="card" style="width: 100%; max-width: 500px; margin: 1rem;">
            <h3 style="margin-bottom: 1rem;" id="modal-title">Feiertag hinzuf√ºgen</h3>
            <div class="flex-col">
                <div>
                    <label>Datum</label>
                    <input type="date" id="modal-datum"
                        style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem;">
                </div>
                <div>
                    <label>Name</label>
                    <input type="text" id="modal-name" placeholder="z.B. Neujahr"
                        style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem;"
                        data-ddg-inputtype="identities.fullName" data-ddg-autofill="true">
                </div>
                <div>
                    <label>Typ</label>
                    <select id="modal-typ"
                        style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem;"
                        data-ddg-inputtype="unknown">
                        <option value="feiertag">Feiertag</option>
                        <option value="brueckentag">Br√ºckentag</option>
                    </select>
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="modal-bezahlt" checked=""
                            style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                        <span>Bezahlt (z√§hlt nicht als Fehlzeit)</span>
                    </label>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button class="btn btn-sec" style="flex: 1;" onclick="closeFeiertagModal()">Abbrechen</button>
                <button class="btn btn-success" style="flex: 1;" onclick="saveFeiertagFromModal()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="massenurlaub-modal" class="hidden"
        style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div class="card" style="width: 100%; max-width: 500px; margin: 1rem;">
            <h3 style="margin-bottom: 1rem;">üìÖ Urlaub √ºber Zeitraum eintragen</h3>
            <div class="flex-col">
                <div>
                    <label>Von (Datum)</label>
                    <input type="date" id="urlaub-von"
                        style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem;"
                        onchange="updateUrlaubBisDatum(); updateUrlaubVorschau()">
                </div>
                <div>
                    <label>Bis (Datum)</label>
                    <input type="date" id="urlaub-bis"
                        style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem;"
                        onchange="updateUrlaubVorschau()">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="urlaub-wochenende" checked=""
                            style="width: 1.25rem; height: 1.25rem; cursor: pointer;" onchange="updateUrlaubVorschau()">
                        <span>Wochenenden auslassen</span>
                    </label>
                </div>
                <div id="urlaub-vorschau"
                    style="padding: 0.75rem; background: #F3F4F6; border-radius: 0.5rem; font-size: 0.875rem; color: #374151; display: none;">
                    <strong>Vorschau:</strong> <span id="urlaub-anzahl">0</span> Arbeitage werden als Urlaub markiert
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button class="btn btn-sec" style="flex: 1;" onclick="closeMassenUrlaub()">Abbrechen</button>
                <button class="btn btn-success" style="flex: 1;" onclick="saveMassenUrlaub()">Urlaub eintragen</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden"
        style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div class="card" style="width: 100%; max-width: 400px; margin: 1rem;">
            <h3 style="margin-bottom: 1rem;" id="confirm-message">Best√§tigung</h3>
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button class="btn btn-sec" id="confirm-cancel" style="flex: 1;">Abbrechen</button>
                <button class="btn btn-danger" id="confirm-ok" style="flex: 1;">OK</button>
            </div>
        </div>
    </div>

    <script>
        let data = {}, view = 'tag';
        const today = new Date();
        let date = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0'),
            month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0'),
            year = today.getFullYear(), woche = getMonday(today);

        let feiertage = {};
        let settings = {
            soll: '08:24',
            pause: '00:30',
            ueberzeitVorgabe: '09:00',
            urlaubTage: 25,
            resturlaubVorjahr: 0,
            sollWoche: 42,
            kanton: '',
            name: '',
            personalnummer: '',
            ueberzeitStartJahr: new Date().getFullYear(),
            ueberzeitStartDatum: new Date().getFullYear() + '-01-01',
            ueberzeitStartStand: 0,
            lastProcessedYear: new Date().getFullYear()
        };
        let sollModus = true;

        function toggleSollModus() {
            sollModus = !sollModus;
            localStorage.setItem('sollModus', sollModus);
            calc();
        }

        function getMonday(d) {
            const dt = new Date(d), day = dt.getDay(), diff = day === 0 ? -6 : 1 - day;
            dt.setDate(dt.getDate() + diff);
            return dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
        }

        function loadFromStorage() {
            const stored = localStorage.getItem('arbeitszeitData');
            if (stored) {
                try { data = JSON.parse(stored); } catch (e) { data = {}; }
            }

            const storedFeiertage = localStorage.getItem('feiertage');
            if (storedFeiertage) {
                try { feiertage = JSON.parse(storedFeiertage); } catch (e) { feiertage = {}; }
            }

            const storedSettings = localStorage.getItem('settings');
            if (storedSettings) {
                try {
                    const oldSettings = JSON.parse(storedSettings);

                    if (oldSettings.ueberzeit && !oldSettings.ueberzeitVorgabe) {
                        const sollMin = timeToMin(oldSettings.soll || '08:24');
                        const ueberzeitMin = parseInt(oldSettings.ueberzeit);
                        const vorgabeMin = sollMin + ueberzeitMin;
                        oldSettings.ueberzeitVorgabe = minToTime(vorgabeMin);
                    }
                    settings = oldSettings;

                    // Stelle sicher, dass lastProcessedYear gesetzt ist
                    if (!settings.lastProcessedYear) {
                        settings.lastProcessedYear = new Date().getFullYear();
                    }

                    if (document.getElementById('soll')) {
                        document.getElementById('soll').value = settings.soll;
                        document.getElementById('pause').value = settings.pause || '00:30';
                        document.getElementById('ueberzeit-vorgabe').value = settings.ueberzeitVorgabe || '09:00';
                        document.getElementById('settings-urlaub').value = settings.urlaubTage;
                        document.getElementById('settings-resturlaub').value = settings.resturlaubVorjahr || 0;
                        document.getElementById('settings-kanton').value = settings.kanton;
                        document.getElementById('soll-woche').value = settings.sollWoche || 42;
                    }
                } catch (e) { }
            }

            const storedSollModus = localStorage.getItem('sollModus');
            if (storedSollModus !== null) {
                sollModus = storedSollModus === 'true';
            }
        }

        function saveToStorage() {
            localStorage.setItem('arbeitszeitData', JSON.stringify(data));
            localStorage.setItem('feiertage', JSON.stringify(feiertage));
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function isFeiertag(dateStr) {
            // PRIORIT√ÑT 1: Manuelle Eingabe hat IMMER Vorrang
            const d = data[dateStr];
            if (d && d.tagTyp) {
                // Wenn manuell als Feiertag markiert
                if (d.tagTyp === 'feiertag-bezahlt' || d.tagTyp === 'feiertag-unbezahlt') {
                    return true;
                }
                // Wenn manuell als etwas ANDERES markiert (Urlaub, Krank, etc.)
                // dann ist es KEIN Feiertag mehr - egal was in JSON steht!
                if (d.tagTyp !== 'normal') {
                    return false;
                }
            }

            // PRIORIT√ÑT 2: Nur wenn NICHTS manuell gesetzt, dann JSON-Feiertage pr√ºfen
            return feiertage[dateStr] !== undefined;
        }

        function getFeiertag(dateStr) {
            const ft = feiertage[dateStr];
            return ft ? (ft.name || ft) : null;
        }

        function isFeiertagBezahlt(dateStr) {
            // PRIORIT√ÑT 1: Manuelle Eingabe hat IMMER Vorrang
            const d = data[dateStr];
            if (d && d.tagTyp) {
                if (d.tagTyp === 'feiertag-bezahlt') {
                    return true;
                }
                if (d.tagTyp === 'feiertag-unbezahlt') {
                    return false;
                }
                // Wenn als etwas anderes markiert (Urlaub, Krank, etc.)
                // dann ist es KEIN Feiertag - return false
                if (d.tagTyp !== 'normal') {
                    return false;
                }
            }

            // PRIORIT√ÑT 2: Nur wenn NICHTS manuell gesetzt, dann JSON-Feiertage pr√ºfen
            const ft = feiertage[dateStr];
            if (!ft) return false;

            return ft.bezahlt !== undefined ? ft.bezahlt : true;
        }

        function getFeiertagTyp(dateStr) {
            const ft = feiertage[dateStr];
            return ft ? (ft.typ || 'feiertag') : null;
        }

        function init() {
            loadFromStorage();
            checkYearChange(); // Pr√ºfe ob Jahreswechsel stattgefunden hat
            document.getElementById('selDate').value = date;
            updateDateDisplay();
            updateUserInfo();
            updateUrlaubStats();
            updateUeberzeitStats();

            document.getElementById('selDate').onchange = e => {
                date = e.target.value;
                loadTag();
                updateDateDisplay();
            };

            ['mk', 'mg', 'mittk', 'ag'].forEach((id, idx) => {
                const field = document.getElementById(id);

                field.oninput = () => { calc(); updateClear(); };
                field.onchange = () => { calc(); updateClear(); };
                field.onblur = () => { calc(); updateClear(); };
                field.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextFields = ['mg', 'mittk', 'ag', null];
                        const next = nextFields[idx];
                        if (next) document.getElementById(next).focus();
                        else {
                            const saveBtn = document.getElementById('btn-save');
                            if (saveBtn) saveBtn.focus();
                        }
                    }
                };

                // Automatisch aktuelle Zeit einf√ºgen wenn Feld leer ist und angeklickt wird
                field.onfocus = () => {
                    if (!field.value) {
                        const now = new Date();
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        field.value = `${hours}:${minutes}`;
                        calc();
                        updateClear();
                    }
                };
            });

            ['soll', 'pause', 'ueberzeit-vorgabe'].forEach(id => {
                const field = document.getElementById(id);
                field.oninput = () => calc();
                field.onchange = () => calc();
                field.onblur = () => calc();
            });

            // Initial load
            clearMsg(); // Sicherstellen, dass keine alten Meldungen angezeigt werden
            switchView(view);
            calc(); updateClear();

            // Zus√§tzlicher updateClear-Aufruf nach kurzer Verz√∂gerung f√ºr sicheres Layout
            setTimeout(() => {
                calc();
                updateClear();
            }, 100);

            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            checkBackupReminder();
        }

        function checkBackupReminder() {
            const lastBackupCheck = localStorage.getItem('lastBackupCheck');
            const now = new Date();
            const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

            if (lastBackupCheck === today) return;

            localStorage.setItem('lastBackupCheck', today);

            const [y, m, d] = today.split('-');
            const lastDay = new Date(+y, +m, 0).getDate();

            if (+d === lastDay && Object.keys(data).length > 0) {

                const lastBackup = localStorage.getItem('lastBackupMonth');
                const currentMonth = y + '-' + m;

                if (lastBackup !== currentMonth) {
                    showBackupReminder();
                }
            }
        }

        function showBackupReminder() {

            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Arbeitszeitrechner - Backup-Erinnerung', {
                    body: 'üîî Monatsende erreicht! Zeit f√ºr dein monatliches Backup.',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üïê</text></svg>',
                    requireInteraction: true
                });
            }

            const confirmBackup = confirm(
                'üîî Monatsende erreicht!\n\n' +
                'M√∂chtest du jetzt dein monatliches Backup erstellen?\n\n' +
                'Empfehlung: Exportiere deine Daten als Excel-Datei.'
            );

            if (confirmBackup) {

                const today = new Date();
                const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                localStorage.setItem('lastBackupMonth', currentMonth);

                toggleExport();
            }
        }

        function updateDateDisplay() {
            try {
                console.log('updateDateDisplay() aufgerufen f√ºr Datum:', date);
                const [y, m, d] = date.split('-').map(Number);
                const dt = new Date(y, m - 1, d);
                const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

                const kw = getWeekNumber(dt);

                const kwJahr = getWeekYear(dt);
                let kwText = `KW ${kw}`;
                if (kwJahr !== y) {
                    kwText += ` (${kwJahr})`;
                }

                console.log('KW berechnet:', kw, 'Jahr:', kwJahr);
                let text = `${kwText}&nbsp;&nbsp;&nbsp;&nbsp;${formatDateWithDay(date)}`;

                if (isFeiertag(date)) {
                    const ftName = getFeiertag(date);
                    const bezahlt = isFeiertagBezahlt(date);
                    const emoji = bezahlt ? 'üîµ' : 'üü†';
                    text += `<br><small style="opacity: 0.8;">${emoji} ${ftName}</small>`;
                }

                document.getElementById('curr-date').innerHTML = text;
                console.log('updateDateDisplay() erfolgreich - Text:', text);
            } catch (e) {
                console.error('Fehler in updateDateDisplay():', e);

                try {
                    let text = formatDateWithDay(date);
                    document.getElementById('curr-date').innerHTML = text;
                } catch (e2) {
                    console.error('Auch Fallback fehlgeschlagen:', e2);
                }
            }
        }

        function getWeekYear(d) {
            const dt = new Date(d.getTime());
            dt.setHours(0, 0, 0, 0);
            dt.setDate(dt.getDate() + 3 - (dt.getDay() + 6) % 7);
            return dt.getFullYear();
        }

        function loadTag() {
            const d = data[date];
            if (d) {
                document.getElementById('mk').value = d.mk || '';
                document.getElementById('mg').value = d.mg || '';
                document.getElementById('mittk').value = d.mittk || '';
                document.getElementById('ag').value = d.ag || '';
                document.getElementById('notiz').value = d.notiz || '';

                // Warnung immer zur√ºcksetzen beim Laden eines neuen Tages
                const warningContainer = document.getElementById('tagtyp-warning-container');
                if (warningContainer) warningContainer.innerHTML = '';

                // Tag-Typ setzen (Radio Buttons)
                const tagTyp = d.tagTyp || 'normal';
                const tagTypRadios = document.getElementsByName('tagTyp');
                for (const radio of tagTypRadios) {
                    radio.checked = (radio.value === tagTyp);
                }

                updateTagTypAnzeige(tagTyp);
            } else {
                ['mk', 'mg', 'mittk', 'ag'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('notiz').value = '';

                // Pr√ºfe, ob der Tag ein Feiertag ist
                let defaultTyp = 'normal';
                if (isFeiertag(date)) {
                    const istBezahlt = isFeiertagBezahlt(date);
                    defaultTyp = istBezahlt ? 'feiertag-bezahlt' : 'feiertag-unbezahlt';
                }

                const tagTypRadios = document.getElementsByName('tagTyp');
                for (const radio of tagTypRadios) {
                    radio.checked = (radio.value === defaultTyp);
                }

                updateTagTypAnzeige(defaultTyp);
            }
            calc();
            updateClear();

            // Toggle labels based on field values
            ['mk', 'mg', 'mittk', 'ag'].forEach(id => toggleLabel(id));
        }

        function updateTagTypAnzeige(tagTyp) {
            const anzeige = document.getElementById('tag-typ-anzeige');
            const icon = document.getElementById('tag-typ-icon');
            const text = document.getElementById('tag-typ-text');

            if (!tagTyp) {
                anzeige.classList.add('hidden');
                return;
            }

            const typConfig = {
                'normal': {
                    icon: '‚öôÔ∏è',
                    text: 'Normaler Arbeitstag',
                    bg: 'linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%)',
                    color: '#1F2937',
                    border: '#9CA3AF'
                },
                'feiertag-bezahlt': {
                    icon: 'üîµ',
                    text: 'Bezahlter Feiertag',
                    bg: 'linear-gradient(135deg, #93C5FD 0%, #60A5FA 100%)',
                    color: '#1F2937',
                    border: '#3B82F6'
                },
                'feiertag-unbezahlt': {
                    icon: 'üü†',
                    text: 'Unbezahlter Feiertag',
                    bg: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)',
                    color: '#1F2937',
                    border: '#F97316'
                },
                'urlaub': {
                    icon: 'üèñÔ∏è',
                    text: 'Urlaubstag',
                    bg: 'linear-gradient(135deg, #A7F3D0 0%, #6EE7B7 100%)',
                    color: '#1F2937',
                    border: '#10B981'
                },
                'krank': {
                    icon: 'ü§í',
                    text: 'Krankheitstag',
                    bg: 'linear-gradient(135deg, #FDE68A 0%, #FCD34D 100%)',
                    color: '#1F2937',
                    border: '#F59E0B'
                },
                'unbezahlt': {
                    icon: 'üìÖ',
                    text: 'Unbezahlter Urlaub',
                    bg: 'linear-gradient(135deg, #FECACA 0%, #FCA5A5 100%)',
                    color: '#1F2937',
                    border: '#EF4444'
                },
                'kompensation': {
                    icon: '‚è∞',
                    text: '√úberzeit-Kompensation',
                    bg: 'linear-gradient(135deg, #D8B4FE 0%, #C4B5FD 100%)',
                    color: '#1F2937',
                    border: '#A855F7'
                }
            };

            const config = typConfig[tagTyp];
            if (config) {
                icon.textContent = config.icon;
                text.textContent = config.text;
                anzeige.style.background = config.bg;
                anzeige.style.color = config.color;
                anzeige.style.border = `2px solid ${config.border}`;
                anzeige.classList.remove('hidden');

                if (document.body.classList.contains('dark')) {
                    // Im Dark Mode: ALLE Typen bekommen wei√üe Schrift und passende dunkle Hintergr√ºnde
                    anzeige.style.opacity = '0.9';
                    anzeige.style.color = '#FFFFFF';

                    // Spezifische Hintergrundfarben f√ºr jeden Typ im Dark Mode (passend zu CSS)
                    // WICHTIG: setProperty mit 'important' verwenden, um CSS zu √ºberschreiben
                    switch (tagTyp) {
                        case 'normal':
                            anzeige.style.setProperty('background', 'linear-gradient(135deg, #6B7280 0%, #9CA3AF 100%)', 'important');
                            anzeige.style.border = '2px solid #D1D5DB';
                            break;
                        case 'feiertag-bezahlt':
                            anzeige.style.setProperty('background', 'linear-gradient(135deg, #1E3A8A 0%, #1E40AF 100%)', 'important');
                            anzeige.style.border = '2px solid #60A5FA';
                            break;
                        case 'feiertag-unbezahlt':
                            anzeige.style.setProperty('background', 'linear-gradient(135deg, #9A3412 0%, #C2410C 100%)', 'important');
                            anzeige.style.border = '2px solid #FB923C';
                            break;
                        case 'urlaub':
                            anzeige.style.setProperty('background', 'linear-gradient(135deg, #065F46 0%, #047857 100%)', 'important');
                            anzeige.style.border = '2px solid #34D399';
                            break;
                        case 'krank':
                            anzeige.style.setProperty('background', 'linear-gradient(135deg, #92400E 0%, #B45309 100%)', 'important');
                            anzeige.style.border = '2px solid #FBBF24';
                            break;
                        case 'unbezahlt':
                            anzeige.style.setProperty('background', 'linear-gradient(135deg, #991B1B 0%, #B91C1C 100%)', 'important');
                            anzeige.style.border = '2px solid #F87171';
                            break;
                        case 'kompensation':
                            anzeige.style.setProperty('background', 'linear-gradient(135deg, #5B21B6 0%, #6D28D9 100%)', 'important');
                            anzeige.style.border = '2px solid #C084FC';
                            break;
                    }
                }
            }
        }

        function updateClear() {
            ['mk', 'mg', 'mittk', 'ag'].forEach(id => {
                const input = document.getElementById(id);
                const clearBtn = document.getElementById('c-' + id);

                if (input && clearBtn) {
                    if (input.value) {
                        input.classList.add('has-value');
                        clearBtn.classList.add('visible');
                    } else {
                        input.classList.remove('has-value');
                        clearBtn.classList.remove('visible');
                    }
                }
            });
        }

        function clearField(id) {
            document.getElementById(id).value = '';

            // Toggle label f√ºr das ge√§nderte Feld
            toggleLabel(id);

            calc();
            updateClear();
        }

        function toggleLabel(id) {
            const input = document.getElementById(id);
            const label = document.getElementById('label-' + id);

            if (label) {
                if (input.value) {
                    label.style.display = 'none';
                } else {
                    label.style.display = 'block';
                }
            }
        }

        function reset() {
            showConfirmDialog('Zeiten zur√ºcksetzen?', () => {
                ['mk', 'mg', 'mittk', 'ag'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('notiz').value = '';
                delete data[date];
                saveToStorage();
                calc();
                updateClear();

                // Toggle labels nach Reset
                ['mk', 'mg', 'mittk', 'ag'].forEach(id => toggleLabel(id));

                showMsg('Zeiten zur√ºckgesetzt', true);
            });
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = message;
            modal.classList.remove('hidden');

            document.getElementById('confirm-ok').onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };
            document.getElementById('confirm-cancel').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        function confirmTagTypChange(confirmed) {
            // Warnbox entfernen
            const container = document.getElementById('tagtyp-warning-container');
            if (container) {
                container.innerHTML = '';
            }

            if (confirmed) {
                // OK geklickt: Zeiten l√∂schen und mit neuem Tag-Typ speichern
                document.getElementById('mk').value = '';
                document.getElementById('mg').value = '';
                document.getElementById('mittk').value = '';
                document.getElementById('ag').value = '';
                updateClear();
                // Speichern mit dem gew√ºnschten Tag-Typ
                save();
            } else {
                // Abbrechen geklickt: Zur√ºck auf "Normaler Arbeitstag"
                const normalRadio = document.querySelector('input[name="tagTyp"][value="normal"]');
                if (normalRadio) {
                    normalRadio.checked = true;
                    updateTagTyp();
                }
                // L√∂sche pending Tag-Typ
                delete window.pendingTagTyp;
            }
        }

        function save() {
            let mk = document.getElementById('mk').value;
            let mg = document.getElementById('mg').value;
            let mittk = document.getElementById('mittk').value;
            let ag = document.getElementById('ag').value;

            let validationErrors = [];

            ['mk', 'mg', 'mittk', 'ag'].forEach(id => {
                document.getElementById(id).classList.remove('input-error');
            });

            if (ag && !mittk) {
                validationErrors.push('Bitte "Mittag Kommen" ausf√ºllen, bevor "Abend Gehen" eingegeben wird');
                document.getElementById('mittk').classList.add('input-error');
                document.getElementById('ag').classList.add('input-error');
            }

            if (mittk && !mg) {
                validationErrors.push('Bitte "Morgen Gehen" ausf√ºllen, bevor "Mittag Kommen" eingegeben wird');
                document.getElementById('mg').classList.add('input-error');
                document.getElementById('mittk').classList.add('input-error');
            }

            if (mg && !mk) {
                validationErrors.push('Bitte "Morgen Kommen" ausf√ºllen, bevor "Morgen Gehen" eingegeben wird');
                document.getElementById('mk').classList.add('input-error');
                document.getElementById('mg').classList.add('input-error');
            }

            if (validationErrors.length > 0) {
                showMsg(validationErrors.join(' ‚Ä¢ '), false);
                return;
            }

            // Keine Validierungsfehler -> Fehlermeldung ausblenden
            clearMsg();

            const tagTypRadios = document.getElementsByName('tagTyp');
            let tagTyp = 'normal';
            for (const radio of tagTypRadios) {
                if (radio.checked) {
                    tagTyp = radio.value;
                    break;
                }
            }

            // Pr√ºfen ob von normalem Arbeitstag mit Zeiten zu speziellem Typ gewechselt wird
            const oldData = data[date] || {};
            const oldTagTyp = oldData.tagTyp || 'normal';
            const hasOldTimes = oldData.mk || oldData.mg || oldData.mittk || oldData.ag;
            const hasNewTimes = mk || mg || mittk || ag;
            const specialTypes = ['urlaub', 'krank', 'unbezahlt', 'kompensation', 'feiertag-bezahlt', 'feiertag-unbezahlt'];

            // Wenn von normal mit Zeiten zu speziellem Typ gewechselt wird UND noch Zeiten eingetragen sind
            if (oldTagTyp === 'normal' && hasOldTimes && specialTypes.includes(tagTyp) && hasNewTimes) {
                // Zeige Warnbox dynamisch an
                const container = document.getElementById('tagtyp-warning-container');
                if (container) {
                    container.innerHTML = `
                        <div id="tagtyp-warning" 
                            style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border: 2px solid #F59E0B; border-radius: 0.5rem;">
                            <div style="font-weight: 700; font-size: 1rem; color: #92400E; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                ‚ö†Ô∏è Tag-Typ Wechsel
                            </div>
                            <div style="color: #78350F; font-size: 0.875rem; line-height: 1.5; margin-bottom: 1rem;">
                                <strong>Bei OK werden Arbeitszeiten gel√∂scht!</strong><br>
                                Bei Abbruch geht es zur√ºck auf Normalen Arbeitstag.
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-success" onclick="confirmTagTypChange(true)" style="flex: 1;">OK - Zeiten l√∂schen</button>
                                <button class="btn btn-sec" onclick="confirmTagTypChange(false)" style="flex: 1;">Abbrechen</button>
                            </div>
                        </div>
                    `;
                    // Speichere gew√ºnschten Tag-Typ global
                    window.pendingTagTyp = tagTyp;
                    return; // Stoppe save() hier - wird fortgesetzt nach Best√§tigung
                }
            }

            const notiz = document.getElementById('notiz').value.trim();

            if (!mk && !mg && !mittk && !ag && tagTyp === 'normal') {
                delete data[date];
            } else {
                // F√ºr Feiertage m√ºssen keine Zeiten eingegeben werden
                if (tagTyp === 'feiertag-bezahlt' || tagTyp === 'feiertag-unbezahlt' ||
                    tagTyp === 'urlaub' || tagTyp === 'krank' ||
                    tagTyp === 'unbezahlt' || tagTyp === 'kompensation') {
                    data[date] = { mk, mg, mittk, ag, tagTyp, notiz };
                } else {
                    data[date] = { mk, mg, mittk, ag, tagTyp, notiz };
                }
            }

            saveToStorage();
            showMsg('Gespeichert!', true);
            updateDateDisplay(); // Aktualisiere die Datums-Anzeige mit Feiertag
            updateTagTypAnzeige(tagTyp); // Aktualisiere die Tag-Typ-Anzeige
            updateUrlaubStats();
            updateUeberzeitStats();

            if (view === 'woche') renderWoche();
            if (view === 'monat') renderMonat();
            if (view === 'jahr') renderJahr();
        }

        function showMsg(text, ok) {
            if (!text) return;
            const msg = document.getElementById('msg');
            if (msg) {
                msg.innerHTML = text; // innerHTML statt textContent f√ºr <br>
                msg.className = 'message ' + (ok ? 'msg-ok' : 'msg-err');
                msg.classList.remove('hidden');
                msg.style.display = 'block';

                // Nur Erfolgs-Nachrichten nach 3 Sekunden ausblenden
                if (ok) {
                    setTimeout(() => {
                        msg.classList.add('hidden');
                        msg.style.display = 'none';
                    }, 3000);
                }
            }
        }

        // Hilfsfunktion zum Ausblenden von Fehlermeldungen
        function clearMsg() {
            const msg = document.getElementById('msg');
            if (msg) {
                msg.classList.add('hidden');
                msg.style.display = 'none';
                msg.textContent = '';
            }
        }
        function timeToMin(time) {
            if (!time) return 0;
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        function minToTime(min) {
            const h = Math.floor(Math.abs(min) / 60);
            const m = Math.abs(min) % 60;
            const sign = min < 0 ? '-' : '';
            return sign + String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
        }

        function minToDecimalHours(min) {
            const hours = (Math.abs(min) / 60).toFixed(2);
            const parts = hours.split('.');
            parts[0] = parts[0].padStart(2, '0');
            return parts.join('.');
        }

        // NEUE FUNKTION: Berechne kumulativen Urlaub vom Jahresbeginn bis zum gegebenen Monat
        // WICHTIG: Bezahlte Feiertage werden NICHT als Ferientag gez√§hlt!
        function getUrlaubBisZumMonat(bisZumMonat) {
            let urlaubGesamt = 0;

            // Durchlaufe alle Tage vom 1.1. bis zum Ende des gegebenen Monats
            for (let m = 1; m <= bisZumMonat; m++) {
                const lastDay = new Date(parseInt(year), m, 0).getDate();
                for (let day = 1; day <= lastDay; day++) {
                    const dateStr = year + '-' + String(m).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    const d = data[dateStr] || {};

                    // Z√§hle als Ferientag NUR wenn:
                    // 1. Es ist als Urlaub markiert UND
                    // 2. Es ist KEIN bezahlter Feiertag
                    if (d.tagTyp === 'urlaub') {
                        const isFT = isFeiertag(dateStr);
                        const ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;

                        // Nur z√§hlen wenn es NICHT ein bezahlter Feiertag ist
                        if (!(isFT && ftBezahlt)) {
                            urlaubGesamt++;
                        }
                    }
                }
            }

            return urlaubGesamt;
        }

        function minToIndustrialHours(min) {
            const isNegative = min < 0;
            const absMin = Math.abs(min);
            const hours = (absMin / 60).toFixed(2);
            return (isNegative ? '-' : '+') + hours + 'h';
        }

        function parseOvertimeString(str) {

            if (!str || str.trim() === '') return 0;

            str = str.trim();
            const isNegative = str.startsWith('-');
            const isPositive = str.startsWith('+');

            if (isNegative || isPositive) {
                str = str.substring(1);
            }

            // Entferne alle Nicht-Zahlen
            str = str.replace(/[^0-9]/g, '');

            // Wenn nur Zahlen ohne Doppelpunkt: interpretiere als HHMM oder HMM
            if (str.length > 0) {
                let hours, minutes;

                if (str.length <= 2) {
                    // 1-2 Ziffern: nur Stunden
                    hours = parseInt(str) || 0;
                    minutes = 0;
                } else if (str.length === 3) {
                    // 3 Ziffern: HMM -> z.B. 845 = 8:45
                    hours = parseInt(str.substring(0, 1)) || 0;
                    minutes = parseInt(str.substring(1)) || 0;
                } else {
                    // 4+ Ziffern: HHMM -> z.B. 11439 = 114:39
                    minutes = parseInt(str.slice(-2)) || 0;
                    hours = parseInt(str.slice(0, -2)) || 0;
                }

                const totalMinutes = hours * 60 + minutes;
                return isNegative ? -totalMinutes : totalMinutes;
            }

            return 0;
        }

        function handleUeberzeitKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();

                const input = document.getElementById('settings-ueberzeit-start');
                const value = input.value.trim();

                // Leere Eingabe ist erlaubt - setze auf 0
                if (value === '') {
                    input.value = '';
                    input.classList.remove('input-error');
                    updateSettings();
                    input.blur();
                    return;
                }

                // Validiere das Format
                const validation = validateUeberzeitInput(value);

                if (!validation.valid) {
                    // Zeige Fehler visuell
                    input.classList.add('input-error');
                    input.title = validation.error || 'Ung√ºltiges Format! Verwenden Sie: +12:34 oder -15:25';

                    // Optional: Zeige Fehlermeldung
                    showMsg(validation.error || 'Ung√ºltiges √úberzeit-Format!', false);
                    return;
                }

                // Eingabe ist g√ºltig - formatiere und speichere
                input.classList.remove('input-error');
                input.title = '';
                input.value = validation.formatted;

                updateSettings();
                input.blur();
            }
        }

        // NEUE FUNKTION: Validiere √úberzeit-Eingabe
        function validateUeberzeitInput(value) {
            if (!value || value.trim() === '') {
                return { valid: true, minutes: 0, formatted: '' };
            }

            const trimmed = value.trim();

            // Pr√ºfe Format: [+/-]HHH:MM
            const regex = /^([+-])?(\d{1,4}):(\d{2})$/;
            const match = trimmed.match(regex);

            if (!match) {
                return {
                    valid: false,
                    error: 'Ung√ºltiges Format! Bitte verwenden Sie: +12:34 oder -15:25'
                };
            }

            const sign = match[1] === '-' ? -1 : 1;
            const hours = parseInt(match[2]);
            const mins = parseInt(match[3]);

            // Pr√ºfe ob Minuten g√ºltig sind (< 60)
            if (mins >= 60) {
                return {
                    valid: false,
                    error: `Ung√ºltige Minuten: ${mins}. Minuten m√ºssen zwischen 00 und 59 liegen!`
                };
            }

            // Optionale Warnung bei sehr hohen Werten
            if (hours > 500) {
                // Warnung, aber trotzdem erlauben
                console.warn(`Sehr hoher √úberstundenwert: ${hours}h`);
            }

            const totalMinutes = sign * (hours * 60 + mins);
            const formatted = formatOvertimeString(totalMinutes);

            return {
                valid: true,
                minutes: totalMinutes,
                formatted: formatted
            };
        }

        function formatOvertimeString(minutes) {

            const isNegative = minutes < 0;
            const absMin = Math.abs(minutes);
            const hours = Math.floor(absMin / 60);
            const mins = absMin % 60;

            const sign = isNegative ? '-' : '+';
            return sign + String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
        }

        function addTime(time, min) {
            const totalMin = timeToMin(time) + min;
            const h = Math.floor(totalMin / 60) % 24;
            const m = totalMin % 60;
            return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
        }

        function formatDateWithDay(dateStr) {

            const [y, m, d] = dateStr.split('-').map(Number);
            const dt = new Date(y, m - 1, d);
            const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            const dayName = days[dt.getDay()];
            return `${dayName} ${String(d).padStart(2, '0')}.${String(m).padStart(2, '0')}.${y}`;
        }

        function calc() {

            console.log('calc() aufgerufen');

            const mk = document.getElementById('mk').value;
            const mg = document.getElementById('mg').value;
            const mittk = document.getElementById('mittk').value;
            const ag = document.getElementById('ag').value;
            const soll = document.getElementById('soll').value;
            const pause = document.getElementById('pause').value;
            const ueberzeitVorgabe = document.getElementById('ueberzeit-vorgabe').value;

            console.log('mk:', mk);
            console.log('mg:', mg);
            console.log('mittk:', mittk);
            console.log('ag:', ag);
            console.log('soll:', soll);
            console.log('pause:', pause);

            let arbBrutto = 0;
            let errors = [];
            let tatsaechlichePause = 0;
            let pauseOK = true;

            ['mk', 'mg', 'mittk', 'ag'].forEach(id => {
                document.getElementById(id).classList.remove('input-error');
            });

            if (mk && mg) {
                const morgen = timeToMin(mg) - timeToMin(mk);
                if (morgen <= 0) {
                    document.getElementById('mk').classList.add('input-error');
                    document.getElementById('mg').classList.add('input-error');
                    errors.push('Morgen Gehen muss mindestens 1 Minute nach Morgen Kommen sein');
                } else {
                    arbBrutto += morgen;
                }
            }

            if (mittk && ag) {
                const mittag = timeToMin(ag) - timeToMin(mittk);
                if (mittag <= 0) {
                    document.getElementById('mittk').classList.add('input-error');
                    document.getElementById('ag').classList.add('input-error');
                    errors.push('Abend Gehen muss mindestens 1 Minute nach Mittag Kommen sein');
                } else {
                    arbBrutto += mittag;
                }
            }

            // NEUE VALIDIERUNG: Mittag Kommen muss nach Morgen Gehen sein
            if (mg && mittk) {
                tatsaechlichePause = timeToMin(mittk) - timeToMin(mg);
                if (tatsaechlichePause <= 0) {
                    document.getElementById('mg').classList.add('input-error');
                    document.getElementById('mittk').classList.add('input-error');
                    errors.push('Mittag Kommen muss mindestens 1 Minute nach Morgen Gehen sein');
                }
            }

            const sollPause = timeToMin(pause);
            let arbNetto = arbBrutto;

            if (arbBrutto >= 360) {
                arbNetto = arbBrutto - sollPause;

                if (tatsaechlichePause > 0 && tatsaechlichePause < sollPause) {
                    const fehlendePause = sollPause - tatsaechlichePause;
                    arbNetto = arbNetto - fehlendePause;
                }
            }

            if (mittk && tatsaechlichePause > 0) {
                pauseOK = tatsaechlichePause >= sollPause;
            }

            let sollMin = timeToMin(soll);

            const istFeiertag = isFeiertag(date);
            const bezahlt = istFeiertag ? isFeiertagBezahlt(date) : false;

            if (istFeiertag && bezahlt) {

                sollMin = 0;
            }

            const vorgabeMin = timeToMin(ueberzeitVorgabe);

            let diffSoll = sollMin - arbNetto;
            let diffVorgabe = vorgabeMin - arbNetto;

            document.getElementById('r-arb').textContent = arbNetto > 0 ? minToTime(arbNetto) : '--:--';

            console.log('arbNetto:', arbNetto);
            console.log('Arbeitszeit angezeigt:', arbNetto > 0 ? minToTime(arbNetto) : '--:--');

            if (mittk && tatsaechlichePause > 0) {
                const pauseIcon = pauseOK ? '‚úì' : '‚úó';
                const pauseColor = pauseOK ? '#10B981' : '#EF4444';
                document.getElementById('pause-info').innerHTML =
                    `<span style="background: rgba(255,255,255,0.9); padding: 0.25rem 0.5rem; border-radius: 0.375rem; color: ${pauseColor}; font-weight: 600; display: inline-block;">${pauseIcon} Pause: ${minToTime(tatsaechlichePause)}</span>`;
            } else if (arbBrutto >= 360) {

                document.getElementById('pause-info').textContent = `inkl. ${pause} Pause`;
            } else {
                document.getElementById('pause-info').innerHTML = '&nbsp;';
            }

            if (sollModus) {

                document.getElementById('soll-label').textContent = 'Sollzeit';
                document.getElementById('r-soll-display').textContent = minToTime(sollMin);
                document.getElementById('r-soll-card').className = 'grad-purple';

                if (mk && mittk && sollMin > 0) {

                    const bisherBrutto = mg && mittk ? (timeToMin(mg) - timeToMin(mk)) : 0;
                    const bruttoGesamt = sollMin >= 360 ? sollMin + sollPause : sollMin;
                    const nochZuArbeiten = bruttoGesamt - bisherBrutto;
                    const gehenUm = addTime(mittk, nochZuArbeiten);
                    document.getElementById('soll-info').innerHTML = `Gehen um: ${gehenUm}`;
                } else {
                    document.getElementById('soll-info').innerHTML = '&nbsp;';
                }

                if (diffSoll === 0 && arbNetto > 0) {
                    document.getElementById('r-diff').textContent = minToTime(sollMin);
                    document.getElementById('r-diff-lbl').textContent = 'Soll erreicht';
                    document.getElementById('r-diff-card').className = 'grad-green';
                } else if (diffSoll < 0) {
                    document.getElementById('r-diff').textContent = minToTime(-diffSoll);
                    document.getElementById('r-diff-lbl').textContent = '√úberzeit Soll';
                    document.getElementById('r-diff-card').className = 'grad-green';
                } else {
                    document.getElementById('r-diff').textContent = minToTime(diffSoll);
                    document.getElementById('r-diff-lbl').textContent = 'Fehlzeit Soll';
                    document.getElementById('r-diff-card').className = 'grad-orange';
                }
            } else {

                document.getElementById('soll-label').textContent = '√úberzeit-Vorgabe';
                document.getElementById('r-soll-display').textContent = minToTime(vorgabeMin);
                document.getElementById('r-soll-card').className = 'grad-green';

                if (mk && mittk && vorgabeMin > 0) {

                    const bisherBrutto = mg && mittk ? (timeToMin(mg) - timeToMin(mk)) : 0;
                    const bruttoGesamt = vorgabeMin >= 360 ? vorgabeMin + sollPause : vorgabeMin;
                    const nochZuArbeiten = bruttoGesamt - bisherBrutto;
                    const gehenUm = addTime(mittk, nochZuArbeiten);
                    document.getElementById('soll-info').innerHTML = `Gehen um: ${gehenUm}`;
                } else {
                    document.getElementById('soll-info').innerHTML = '&nbsp;';
                }

                if (diffVorgabe === 0 && arbNetto > 0) {
                    document.getElementById('r-diff').textContent = minToTime(vorgabeMin);
                    document.getElementById('r-diff-lbl').textContent = 'Vorgabe erreicht';
                    document.getElementById('r-diff-card').className = 'grad-green';
                } else if (diffVorgabe < 0) {
                    document.getElementById('r-diff').textContent = minToTime(-diffVorgabe);
                    document.getElementById('r-diff-lbl').textContent = '√úberzeit √úberzeit-Vorgabe';
                    document.getElementById('r-diff-card').className = 'grad-green';
                } else {
                    document.getElementById('r-diff').textContent = minToTime(diffVorgabe);
                    document.getElementById('r-diff-lbl').textContent = 'Fehlzeit √úberzeit-Vorgabe';
                    document.getElementById('r-diff-card').className = 'grad-orange';
                }
            }

            const compactResult = document.getElementById('compact-result');
            if (arbNetto > 0) {
                compactResult.style.display = 'block';
                document.getElementById('compact-arb').textContent = minToTime(arbNetto);

                const currentDiff = sollModus ? diffSoll : diffVorgabe;
                const currentDiffLabel = sollModus ? 'Fehlzeit/√úberzeit:' : 'Differenz:';

                document.getElementById('compact-diff-label').textContent = currentDiffLabel;
                const diffText = currentDiff < 0 ? '+' + minToTime(-currentDiff) : '-' + minToTime(currentDiff);
                const diffColor = currentDiff < 0 ? '#10B981' : '#EF4444';

                const compactDiffEl = document.getElementById('compact-diff');
                compactDiffEl.textContent = diffText;
                compactDiffEl.style.color = diffColor;
            } else {
                compactResult.style.display = 'none';
            }

            if (errors.length > 0) {
                showMsg(errors.join('<br>'), false);
            } else {
                // Keine Fehler -> Fehlermeldung ausblenden, falls vorhanden
                clearMsg();
            }

            // Sicherheitsnetz: Verstecke msg wenn leer (verhindert leeren gr√ºnen Balken)
            const msgEl = document.getElementById('msg');
            if (msgEl && (!msgEl.textContent || msgEl.textContent.trim() === '')) {
                msgEl.classList.add('hidden');
                msgEl.style.display = 'none';
            }
        }

        function switchView(v) {
            // AUTO-SAVE: Wenn wir von der Tag-Ansicht wegwechseln, automatisch speichern
            if (view === 'tag' && v !== 'tag') {
                const mk = document.getElementById('mk').value;
                const mg = document.getElementById('mg').value;
                const mittk = document.getElementById('mittk').value;
                const ag = document.getElementById('ag').value;

                // Nur speichern wenn mindestens eine Zeit eingegeben wurde
                if (mk || mg || mittk || ag) {
                    console.log('Auto-Save beim Ansichtswechsel');

                    // Direkt speichern OHNE Validierung (um Datenverlust zu vermeiden)
                    const tagTypRadios = document.getElementsByName('tagTyp');
                    let tagTyp = 'normal';
                    for (const radio of tagTypRadios) {
                        if (radio.checked) {
                            tagTyp = radio.value;
                            break;
                        }
                    }

                    const notiz = document.getElementById('notiz').value.trim();
                    data[date] = { mk, mg, mittk, ag, tagTyp, notiz };
                    saveToStorage();
                    console.log('Auto-Save erfolgreich:', date, data[date]);
                }
            }

            // Beende L√∂schmodus wenn aktiv
            if (urlaubLoeschModus) {
                urlaubLoeschModus = false;
                updateLoeschButtons('üóëÔ∏è Mehrere Urlaubstage l√∂schen', 'btn btn-danger');
                const hinweis = document.getElementById('loeschen-hinweis');
                if (hinweis) hinweis.remove();
                ausgewaehlteUrlaubstage.clear();
                entferneMarkierungen();
            }

            view = v;
            ['tag', 'woche', 'monat', 'jahr', 'einstellungen'].forEach(x => {
                document.getElementById('v-' + x).classList.add('hidden');
            });
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick*="${v}"]`).classList.add('active');
            document.getElementById('v-' + v).classList.remove('hidden');

            if (v === 'tag') {
                loadTag(); // Lade Tag-Daten und initialisiere Tag-Typ-Anzeige
            } else if (v === 'woche') {

                const [y, m, d] = date.split('-').map(Number);
                const currentDate = new Date(y, m - 1, d);
                const dayOfWeek = currentDate.getDay();
                const diff = currentDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                const monday = new Date(currentDate.setDate(diff));
                woche = monday.getFullYear() + '-' + String(monday.getMonth() + 1).padStart(2, '0') + '-' + String(monday.getDate()).padStart(2, '0');
                renderWoche();
            }
            else if (v === 'monat') renderMonat();
            else if (v === 'jahr') renderJahr();
            else if (v === 'einstellungen') renderEinstellungen();
        }

        function prevDay() {
            try {
                console.log('prevDay() aufgerufen - aktuelles Datum:', date);
                const [y, m, d] = date.split('-').map(Number);
                const dt = new Date(y, m - 1, d);
                dt.setDate(dt.getDate() - 1);

                date = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
                console.log('prevDay() - neues Datum:', date);
                document.getElementById('selDate').value = date;
                loadTag();
                updateDateDisplay();
                console.log('prevDay() erfolgreich abgeschlossen');
            } catch (e) {
                console.error('Fehler in prevDay():', e);
                alert('Fehler beim Zur√ºckschalten: ' + e.message);
            }
        }

        function nextDay() {
            try {
                console.log('nextDay() aufgerufen - aktuelles Datum:', date);
                const [y, m, d] = date.split('-').map(Number);
                const dt = new Date(y, m - 1, d);
                dt.setDate(dt.getDate() + 1);

                date = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
                console.log('nextDay() - neues Datum:', date);
                document.getElementById('selDate').value = date;
                loadTag();
                updateDateDisplay();
                console.log('nextDay() erfolgreich abgeschlossen');
            } catch (e) {
                console.error('Fehler in nextDay():', e);
                alert('Fehler beim Weiterschalten: ' + e.message);
            }
        }

        function goToday() {
            const today = new Date();

            date = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            document.getElementById('selDate').value = date;
            loadTag();
            updateDateDisplay();
        }

        function wocheVor() {
            const [y, m, d] = woche.split('-').map(Number);
            const dt = new Date(y, m - 1, d);
            dt.setDate(dt.getDate() - 7);
            woche = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
            renderWoche();
        }

        function wocheWeiter() {
            const [y, m, d] = woche.split('-').map(Number);
            const dt = new Date(y, m - 1, d);
            dt.setDate(dt.getDate() + 7);
            woche = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
            renderWoche();
        }

        function renderWoche() {
            const [y, m, d] = woche.split('-').map(Number);
            const monday = new Date(y, m - 1, d);
            const sunday = new Date(monday);
            sunday.setDate(sunday.getDate() + 6);

            const kw = getWeekNumber(monday);
            const kwJahr = getWeekYear(monday);
            let kwText = `KW ${kw}`;
            if (kwJahr !== y) {
                kwText += ` (${kwJahr})`;
            }

            document.getElementById('w-name').textContent =
                window.innerWidth < 768
                    ? kwText
                    : `${kwText}    ${d}.${m}. - ${sunday.getDate()}.${sunday.getMonth() + 1}.${y}`;

            let totalArb = 0;
            let erfuellteTage = 0;
            let html = '<div class="flex-col">';

            const sollWocheStunden = parseFloat(document.getElementById('soll-woche').value) || 42;
            const totalSoll = sollWocheStunden * 60;
            const sollProTag = timeToMin(settings.soll);

            for (let i = 0; i < 7; i++) {
                const dt = new Date(monday);
                dt.setDate(dt.getDate() + i);
                const dateStr = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
                const d = data[dateStr] || {};

                const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
                const dayName = days[dt.getDay()];
                const dayNum = dt.getDate();
                const monthNum = dt.getMonth() + 1;
                const isWeekend = dt.getDay() === 0 || dt.getDay() === 6;

                let arb = 0;
                let isFT = isFeiertag(dateStr);
                let ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;
                let ftName = isFT ? getFeiertag(dateStr) : '';

                if (d) {
                    const mk = d.mk || '', mg = d.mg || '', mittk = d.mittk || '', ag = d.ag || '';
                    if (mk && mg) arb += timeToMin(mg) - timeToMin(mk);
                    if (mittk && ag) arb += timeToMin(ag) - timeToMin(mittk);
                    if (arb >= 360) arb -= timeToMin(settings.pause);
                }

                totalArb += arb;

                let sollTagMin = 0;
                let diffText = '';
                let diffClass = '';

                if (isWeekend) {

                    if (arb > 0) {
                        diffClass = 'color: #10B981; font-weight: bold;';
                        diffText = `+${minToTime(arb)}`;
                    } else if (isFT && ftBezahlt) {
                        diffClass = 'color: #10B981;';
                        diffText = '‚úì Feiertag';
                    } else {
                        diffClass = 'color: #6B7280;';
                        diffText = '- Wochenende';
                    }
                } else {
                    // Wochentag
                    const tagTyp = d.tagTyp || 'normal';

                    // Diese Tagtypen z√§hlen als "erf√ºllter Tag"
                    if (tagTyp === 'urlaub' ||
                        tagTyp === 'krank' ||
                        tagTyp === 'kompensation' ||
                        tagTyp === 'feiertag-bezahlt' ||
                        (isFT && ftBezahlt)) {
                        sollTagMin = 0;
                        erfuellteTage++;

                        // ‚ö° NEU: Krankheit, Urlaub, Kompensation z√§hlen als gearbeitete Zeit (8:24)
                        if ((tagTyp === 'krank' || tagTyp === 'urlaub' || tagTyp === 'kompensation') && arb === 0) {
                            totalArb += sollProTag;
                        }

                        if (arb > 0) {
                            diffClass = 'color: #10B981; font-weight: bold;';
                            if (isFT && ftBezahlt) {
                                diffText = `‚úì Feiertag +${minToTime(arb)}`;
                            } else {
                                diffText = `+${minToTime(arb)}`;
                            }
                        } else {
                            diffClass = 'color: #10B981;';
                            if (isFT && ftBezahlt) {
                                diffText = '‚úì Feiertag';
                            } else {
                                diffText = '‚úì Erf√ºllt';
                            }
                        }
                    } else {
                        // Normaler Arbeitstag
                        sollTagMin = sollProTag;
                        const diff = sollTagMin - arb;

                        if (diff === 0) {
                            erfuellteTage++;
                            diffClass = 'color: #10B981; font-weight: bold;';
                            diffText = '‚úì Erf√ºllt';
                        } else if (diff < 0) {
                            erfuellteTage++;
                            diffClass = 'color: #10B981; font-weight: bold;';
                            diffText = `+${minToTime(-diff)}`;
                        } else if (arb === 0) {
                            diffClass = 'color: #EF4444; font-weight: bold;';
                            diffText = '- Nicht gearbeitet';
                        } else {
                            diffClass = 'color: #EF4444; font-weight: bold;';
                            diffText = `-${minToTime(diff)}`;
                        }
                    }
                }

                let bgClass = '';
                let tagTypIcon = '';

                if (isFT) {
                    bgClass = ftBezahlt ? 'feiertag' : 'feiertag-unbezahlt';
                } else if (d && d.tagTyp) {
                    switch (d.tagTyp) {
                        case 'urlaub':
                            bgClass = 'tag-urlaub';
                            tagTypIcon = '<span class="emoji-medium">üèñÔ∏è</span> ';
                            diffText = 'Urlaub';
                            diffClass = 'color: #10B981;';
                            break;
                        case 'krank':
                            bgClass = 'tag-krank';
                            tagTypIcon = '<span class="emoji-medium">ü§í</span> ';
                            diffText = 'Krankheit';
                            diffClass = 'color: #F59E0B;';
                            break;
                        case 'unbezahlt':
                            bgClass = 'tag-unbezahlt';
                            tagTypIcon = '<span class="emoji-medium">üìÖ</span> ';
                            diffText = 'Unbez. Urlaub';
                            diffClass = 'color: #EF4444;';
                            break;
                        case 'kompensation':
                            bgClass = 'tag-kompensation';
                            tagTypIcon = '<span class="emoji-medium">‚è∞</span> ';
                            diffText = 'Kompensation';
                            diffClass = 'color: #A855F7;';
                            break;
                        case 'normal':
                            bgClass = 'tag-typ-normal';
                            break;
                        default:
                            bgClass = 'tag-typ-normal';
                            break;
                    }
                } else if (isWeekend) {
                    bgClass = 'weekend';
                } else {
                    // Fallback f√ºr normale Tage ohne expliziten Typ
                    bgClass = 'tag-typ-normal';
                }

                // Fix f√ºr fehlendes notizDisplay (V18)
                let notizDisplay = '';
                if (d.notiz) {
                    notizDisplay = `<div style="font-size: 0.75rem; color: #9CA3AF; margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üìù ${d.notiz}</div>`;
                }

                html += `<div class="card-sm ${bgClass}" style="cursor: pointer;" onclick="jumpToDate('${dateStr}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">${tagTypIcon}${formatDateWithDay(dateStr)}</div>
                            ${isFT ? `<div style="font-size: 0.75rem; opacity: 0.75; margin-top: 0.25rem;">${ftBezahlt ? 'üîµ' : 'üü†'} ${ftName}</div>` : ''}
                            ${notizDisplay}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: bold;">${arb > 0 ? minToTime(arb) : '--:--'}</div>
                            <div style="font-size: 0.875rem; ${diffClass}">${diffText}</div>
                        </div>
                    </div>
                </div>`;

            }

            html += '</div>';
            document.getElementById('w-list').innerHTML = html;

            const totalDiff = totalSoll - totalArb;

            document.getElementById('w-arb').textContent = minToTime(totalArb);
            document.getElementById('w-info').textContent = `${erfuellteTage} / 5 Tage`;

            document.getElementById('w-soll').textContent = minToTime(totalSoll);
            document.getElementById('w-soll-info').textContent = '5 Tage';

            if (totalDiff === 0) {
                document.getElementById('w-diff').textContent = minToTime(totalSoll);
                document.getElementById('w-diff-lbl').textContent = 'Soll erreicht';
                document.getElementById('w-diff-card').className = 'grad-green';
                document.getElementById('w-diff-info').textContent = `${erfuellteTage} / 5 Tage`;
            } else if (totalDiff < 0) {
                document.getElementById('w-diff').textContent = minToTime(-totalDiff);
                document.getElementById('w-diff-lbl').textContent = '√úberzeit Woche';
                document.getElementById('w-diff-card').className = 'grad-green';
                document.getElementById('w-diff-info').textContent = `${erfuellteTage} / 5 Tage`;
            } else {
                document.getElementById('w-diff').textContent = minToTime(totalDiff);
                document.getElementById('w-diff-lbl').textContent = 'Fehlzeit Woche';
                document.getElementById('w-diff-card').className = 'grad-orange';
                document.getElementById('w-diff-info').textContent = `${erfuellteTage} / 5 Tage`;
            }
        }

        function getWeekNumber(d) {
            const dt = new Date(d.getTime());
            dt.setHours(0, 0, 0, 0);
            dt.setDate(dt.getDate() + 3 - (dt.getDay() + 6) % 7);
            const week1 = new Date(dt.getFullYear(), 0, 4);
            return 1 + Math.round(((dt - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function monatVor() {
            const [y, m] = month.split('-').map(Number);
            const newM = m === 1 ? 12 : m - 1;
            const newY = m === 1 ? y - 1 : y;
            month = newY + '-' + String(newM).padStart(2, '0');
            renderMonat();
        }

        function monatWeiter() {
            const [y, m] = month.split('-').map(Number);
            const newM = m === 12 ? 1 : m + 1;
            const newY = m === 12 ? y + 1 : y;
            month = newY + '-' + String(newM).padStart(2, '0');
            renderMonat();
        }

        function renderMonat() {
            const [y, m] = month.split('-').map(Number);
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('m-name').textContent = `${months[m - 1]} ${y}`;

            const firstDay = new Date(y, m - 1, 1);
            const lastDay = new Date(y, m, 0);
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

            let html = '';
            const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            days.forEach(d => {
                html += `<div style="text-align: center; font-weight: 600; padding: 0.5rem; color: #6B7280;">${d}</div>`;
            });

            let totalArb = 0;
            let erfuellteTage = 0;
            let arbeitsTageImMonat = 0;
            const sollProTag = timeToMin(settings.soll);

            // SCHRITT 1: Z√§hle ALLE Wochentage (Mo-Fr) im Monat
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = y + '-' + String(m).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                const dt = new Date(y, m - 1, day);
                const dayOfWeek = dt.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                if (!isWeekend) {
                    arbeitsTageImMonat++;
                }
            }

            const totalSoll = arbeitsTageImMonat * sollProTag;

            for (let i = 0; i < startDay; i++) {
                html += '<div></div>';
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = y + '-' + String(m).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                const d = data[dateStr] || {};
                const dt = new Date(y, m - 1, day);
                const dayOfWeek = dt.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                let arb = 0;
                let isFT = isFeiertag(dateStr);
                let ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;
                let ftName = isFT ? getFeiertag(dateStr) : '';

                if (d) {
                    const mk = d.mk || '', mg = d.mg || '', mittk = d.mittk || '', ag = d.ag || '';
                    if (mk && mg) arb += timeToMin(mg) - timeToMin(mk);
                    if (mittk && ag) arb += timeToMin(ag) - timeToMin(mittk);
                    if (arb >= 360) arb -= timeToMin(settings.pause);
                }

                totalArb += arb;

                let diff = 0;
                let diffColor = '';

                if (isWeekend) {

                    if (arb > 0) {
                        diff = -arb;
                        diffColor = '#10B981';
                    }
                } else {
                    // Z√§hle erf√ºllte Tage nur an Wochentagen
                    const tagTyp = d.tagTyp || 'normal';

                    // Diese Tagtypen z√§hlen als "erf√ºllter Tag"
                    if (tagTyp === 'urlaub' ||
                        tagTyp === 'krank' ||
                        tagTyp === 'kompensation' ||
                        tagTyp === 'feiertag-bezahlt' ||
                        (isFT && ftBezahlt)) {
                        erfuellteTage++;

                        // ‚ö° NEU: Krankheit, Urlaub, Kompensation z√§hlen als gearbeitete Zeit (8:24)
                        if ((tagTyp === 'krank' || tagTyp === 'urlaub' || tagTyp === 'kompensation') && arb === 0) {
                            totalArb += sollProTag;
                        }

                        if (arb > 0) {
                            diff = -arb;
                            diffColor = '#10B981';
                        }
                    } else {
                        // Normaler Arbeitstag: Pr√ºfe ob genug gearbeitet wurde
                        diff = sollProTag - arb;
                        if (diff <= 0) {
                            erfuellteTage++;
                            diffColor = '#10B981';
                        } else if (arb > 0) {
                            diffColor = '#EF4444';
                        }
                    }
                }

                let bgClass = '';
                let tagTypIcon = '';

                if (isFT) {
                    bgClass = ftBezahlt ? 'feiertag' : 'feiertag-unbezahlt';
                } else if (d && d.tagTyp) {
                    switch (d.tagTyp) {
                        case 'urlaub':
                            bgClass = 'tag-urlaub';
                            tagTypIcon = '<span class="emoji-medium">üèñÔ∏è</span>';
                            break;
                        case 'krank':
                            bgClass = 'tag-krank';
                            tagTypIcon = '<span class="emoji-medium">ü§í</span>';
                            break;
                        case 'unbezahlt':
                            bgClass = 'tag-unbezahlt';
                            tagTypIcon = '<span class="emoji-medium">üìÖ</span>';
                            break;
                        case 'kompensation':
                            bgClass = 'tag-kompensation';
                            tagTypIcon = '<span class="emoji-medium">‚è∞</span>';
                            break;
                        case 'normal':
                            bgClass = 'tag-typ-normal';
                            break;
                        default:
                            bgClass = 'tag-typ-normal';
                            break;
                    }
                } else if (isWeekend) {
                    bgClass = 'weekend';
                } else {
                    bgClass = 'tag-typ-normal';
                }

                html += `<div class="card-sm cal-day ${bgClass}" data-date="${dateStr}" style="cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;" onclick="jumpToDate('${dateStr}')">
                    <div style="font-weight: 600;">${day}</div>
                    <div style="text-align: right;">
                        ${isFT ? `<div style="font-size: 0.7rem; opacity: 0.85; line-height: 1.1; margin-bottom: 0.15rem;">${ftBezahlt ? 'üîµ' : 'üü†'} ${ftName}</div>` : tagTypIcon ? `<div style="font-size: 0.875rem; margin-bottom: 0.15rem;">${tagTypIcon}</div>` : ''}
                        ${arb > 0 ? `<div style="font-size: 0.875rem; font-weight: bold;">${minToTime(arb)}</div>` : ''}
                        ${diff !== 0 && arb > 0 ? `<div style="font-size: 0.75rem; color: ${diffColor};">${diff < 0 ? '+' : '-'}${minToTime(Math.abs(diff))}</div>` : ''}
                    </div>
                </div>`;
            }

            document.getElementById('m-cal').innerHTML = html;

            const totalDiff = totalSoll - totalArb;

            document.getElementById('m-arb').textContent = minToTime(totalArb);
            document.getElementById('m-info').textContent = `${erfuellteTage} / ${arbeitsTageImMonat} Tage`;

            document.getElementById('m-soll').textContent = minToTime(totalSoll);
            document.getElementById('m-soll-info').textContent = `${arbeitsTageImMonat} Tage`;

            if (totalDiff === 0) {
                document.getElementById('m-diff').textContent = minToTime(totalSoll);
                document.getElementById('m-diff-lbl').textContent = 'Soll erreicht';
                document.getElementById('m-diff-card').className = 'grad-green';
                document.getElementById('m-diff-info').textContent = `${erfuellteTage} / ${arbeitsTageImMonat} Tage`;
            } else if (totalDiff < 0) {
                document.getElementById('m-diff').textContent = minToTime(-totalDiff);
                document.getElementById('m-diff-lbl').textContent = '√úberzeit Monat';
                document.getElementById('m-diff-card').className = 'grad-green';
                document.getElementById('m-diff-info').textContent = `${erfuellteTage} / ${arbeitsTageImMonat} Tage`;
            } else {
                document.getElementById('m-diff').textContent = minToTime(totalDiff);
                document.getElementById('m-diff-lbl').textContent = 'Fehlzeit Monat';
                document.getElementById('m-diff-card').className = 'grad-orange';
                document.getElementById('m-diff-info').textContent = `${erfuellteTage} / ${arbeitsTageImMonat} Tage`;
            }

            // Ferientage anzeigen (mit Null-Checks)
            const urlaubGesamt = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
            const urlaubBisHierthin = getUrlaubBisZumMonat(m);
            const urlaubRest = urlaubGesamt - urlaubBisHierthin;
            const mUrlaubGesamt = document.getElementById('m-urlaub-gesamt');
            const mUrlaubBezogen = document.getElementById('m-urlaub-bezogen');
            const mUrlaubRest = document.getElementById('m-urlaub-rest');
            if (mUrlaubGesamt) mUrlaubGesamt.textContent = urlaubGesamt;
            if (mUrlaubBezogen) mUrlaubBezogen.textContent = urlaubBisHierthin;
            if (mUrlaubRest) mUrlaubRest.textContent = urlaubRest;
        }

        function jahrVor() {
            year--;
            renderJahr();
        }

        function jahrWeiter() {
            year++;
            renderJahr();
        }

        function renderJahr() {
            document.getElementById('j-name').textContent = year;

            const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
            let html = '';

            let totalArbJahr = 0, totalSollJahr = 0, erfuellteTageJahr = 0, arbeitsTageJahrGesamt = 0;
            const sollProTag = timeToMin(settings.soll);

            for (let m = 1; m <= 12; m++) {
                const lastDay = new Date(year, m, 0);

                let totalArb = 0;
                let erfuellteTage = 0;
                let arbeitsTageImMonat = 0;

                // SCHRITT 1: Z√§hle ALLE Wochentage (Mo-Fr) im Monat
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateStr = year + '-' + String(m).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    const dt = new Date(year, m - 1, day);
                    const dayOfWeek = dt.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    if (!isWeekend) {
                        arbeitsTageImMonat++;
                    }
                }

                const totalSoll = arbeitsTageImMonat * sollProTag;

                // SCHRITT 2: Berechne Arbeitszeit und erf√ºllte Tage
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateStr = year + '-' + String(m).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    const d = data[dateStr] || {};
                    const dt = new Date(year, m - 1, day);
                    const dayOfWeek = dt.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    let arb = 0;
                    let isFT = isFeiertag(dateStr);
                    let ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;

                    if (d) {
                        const mk = d.mk || '', mg = d.mg || '', mittk = d.mittk || '', ag = d.ag || '';
                        if (mk && mg) arb += timeToMin(mg) - timeToMin(mk);
                        if (mittk && ag) arb += timeToMin(ag) - timeToMin(mittk);
                        if (arb >= 360) arb -= timeToMin(settings.pause);
                    }

                    totalArb += arb;

                    // Z√§hle erf√ºllte Tage nur an Wochentagen
                    if (!isWeekend) {
                        const tagTyp = d.tagTyp || 'normal';

                        // Diese Tagtypen z√§hlen als "erf√ºllter Tag"
                        if (tagTyp === 'urlaub' ||
                            tagTyp === 'krank' ||
                            tagTyp === 'kompensation' ||
                            tagTyp === 'feiertag-bezahlt' ||
                            (isFT && ftBezahlt)) {
                            erfuellteTage++;

                            // ‚ö° NEU: Krankheit, Urlaub, Kompensation z√§hlen als gearbeitete Zeit (8:24)
                            if ((tagTyp === 'krank' || tagTyp === 'urlaub' || tagTyp === 'kompensation') && arb === 0) {
                                totalArb += sollProTag;
                            }
                        } else {
                            // Normaler Arbeitstag: Pr√ºfe ob genug gearbeitet wurde
                            const diff = sollProTag - arb;
                            if (diff <= 0) {
                                erfuellteTage++;
                            }
                        }
                    }
                }

                totalArbJahr += totalArb;
                totalSollJahr += totalSoll;
                erfuellteTageJahr += erfuellteTage;
                arbeitsTageJahrGesamt += arbeitsTageImMonat;

                const totalDiff = totalSoll - totalArb;

                html += `<div class="card-sm month-card" onclick="jumpToMonth('${year}-${String(m).padStart(2, '0')}')">
                    <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1.125rem;">${months[m - 1]} ${year}</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #6B7280; font-size: 0.875rem;">Arbeitszeit:</span>
                        <span style="font-weight: bold;">${minToTime(totalArb)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #6B7280; font-size: 0.875rem;">Sollzeit:</span>
                        <span style="font-weight: bold;">${minToTime(totalSoll)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                        <span style="color: #6B7280; font-size: 0.875rem;">${totalDiff <= 0 ? '√úberzeit:' : 'Fehlzeit:'}</span>
                        <span style="font-weight: bold; color: ${totalDiff <= 0 ? '#10B981' : '#EF4444'};">${totalDiff === 0 ? '00:00' : minToTime(Math.abs(totalDiff))}</span>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6B7280;">${erfuellteTage} / ${arbeitsTageImMonat} Tage</div>
                </div>`;
            }

            document.getElementById('j-list').innerHTML = html;

            const totalDiffJahr = totalSollJahr - totalArbJahr;

            document.getElementById('j-arb').textContent = minToTime(totalArbJahr);
            document.getElementById('j-info').textContent = `${erfuellteTageJahr} / ${arbeitsTageJahrGesamt} Tage`;

            document.getElementById('j-soll').textContent = minToTime(totalSollJahr);
            document.getElementById('j-soll-info').textContent = `${arbeitsTageJahrGesamt} Tage`;

            if (totalDiffJahr === 0) {
                document.getElementById('j-diff').textContent = minToTime(totalSollJahr);
                document.getElementById('j-diff-lbl').textContent = 'Soll erreicht';
                document.getElementById('j-diff-card').className = 'grad-green';
                document.getElementById('j-diff-info').textContent = `${erfuellteTageJahr} / ${arbeitsTageJahrGesamt} Tage`;
            } else if (totalDiffJahr < 0) {
                document.getElementById('j-diff').textContent = minToTime(-totalDiffJahr);
                document.getElementById('j-diff-lbl').textContent = '√úberzeit Jahr';
                document.getElementById('j-diff-card').className = 'grad-green';
                document.getElementById('j-diff-info').textContent = `${erfuellteTageJahr} / ${arbeitsTageJahrGesamt} Tage`;
            } else {
                document.getElementById('j-diff').textContent = minToTime(totalDiffJahr);
                document.getElementById('j-diff-lbl').textContent = 'Fehlzeit Jahr';
                document.getElementById('j-diff-card').className = 'grad-orange';
                document.getElementById('j-diff-info').textContent = `${erfuellteTageJahr} / ${arbeitsTageJahrGesamt} Tage`;
            }


            // Urlaubstage f√ºr das angezeigte Jahr berechnen
            updateUrlaubStats();
        }

        function jumpToDate(dateStr) {
            date = dateStr;
            document.getElementById('selDate').value = date;
            loadTag();
            updateDateDisplay();
            switchView('tag');
        }

        function jumpToMonth(monthStr) {
            month = monthStr;
            switchView('monat');
        }

        function renderEinstellungen() {

            const ftCount = Object.keys(feiertage).length;
            const ftBezahlt = Object.values(feiertage).filter(ft => ft.bezahlt !== false).length;
            const ftUnbezahlt = ftCount - ftBezahlt;
            document.getElementById('feiertag-info').textContent =
                `${ftCount} Feiertage geladen (${ftBezahlt} bezahlt, ${ftUnbezahlt} unbezahlt)`;

            const sortedFeiertage = Object.entries(feiertage).sort((a, b) => a[0].localeCompare(b[0]));

            if (sortedFeiertage.length === 0) {
                document.getElementById('feiertag-list').innerHTML =
                    '<div style="text-align: center; padding: 2rem; color: #9CA3AF;">Noch keine Feiertage geladen</div>';
                document.getElementById('feiertag-jahr').textContent = '';
                return;
            }

            const byYear = {};
            sortedFeiertage.forEach(([datum, ft]) => {
                const jahr = datum.split('-')[0];
                if (!byYear[jahr]) byYear[jahr] = [];
                byYear[jahr].push([datum, ft]);
            });

            let html = '';
            Object.keys(byYear).sort((a, b) => b - a).forEach(jahr => {
                html += `<div style="margin-bottom: 1rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem;">Jahr ${jahr}</div>`;

                byYear[jahr].forEach(([datum, ft]) => {
                    const [y, m, d] = datum.split('-');
                    const ftName = ft.name || ft;
                    const bezahlt = ft.bezahlt !== undefined ? ft.bezahlt : true;
                    const typ = ft.typ || 'feiertag';

                    let badgeClass = 'badge-bezahlt';
                    let badgeText = 'Bezahlt';
                    if (!bezahlt) {
                        badgeClass = 'badge-unbezahlt';
                        badgeText = 'Unbezahlt';
                    }
                    if (typ === 'brueckentag') {
                        badgeClass = 'badge-bruecke';
                        badgeText = 'Br√ºcke';
                    }

                    html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem; background: rgba(0,0,0,0.02);">
                        <div>
                            <span style="font-weight: 600;">${d}.${m}.${y}</span>
                            <span style="margin-left: 0.5rem;">${ftName}</span>
                            <span class="feiertag-badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sec" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editFeiertag('${datum}')">‚úèÔ∏è</button>
                            <button class="del-btn" onclick="deleteFeiertag('${datum}')">‚úï</button>
                        </div>
                    </div>`;
                });

                html += '</div>';
            });

            document.getElementById('feiertag-list').innerHTML = html;

            const allYears = Object.keys(byYear).sort((a, b) => b - a);
            if (allYears.length === 1) {
                document.getElementById('feiertag-jahr').textContent = `(${allYears[0]})`;
            } else if (allYears.length > 1) {
                document.getElementById('feiertag-jahr').textContent = `(${allYears[allYears.length - 1]} - ${allYears[0]})`;
            }

            if (document.getElementById('settings-name')) {
                document.getElementById('settings-name').value = settings.name || '';
            }
            if (document.getElementById('settings-personalnummer')) {
                document.getElementById('settings-personalnummer').value = settings.personalnummer || '';
            }

            if (document.getElementById('settings-ueberzeit-datum')) {
                const jahr = settings.ueberzeitStartJahr || new Date().getFullYear();
                const datum = settings.ueberzeitStartDatum || (jahr + '-01-01');
                document.getElementById('settings-ueberzeit-datum').value = datum;
                document.getElementById('settings-ueberzeit-start').value = formatOvertimeString(settings.ueberzeitStartStand || 0);
            }

            if (document.getElementById('soll-berechnet')) {
                const sollWoche = settings.sollWoche || 42;
                const sollZeit = settings.soll || '08:24';
                document.getElementById('soll-berechnet').textContent = `${sollWoche}h √∑ 5 = ${sollZeit}`;
            }

            updateUrlaubStats();
            updateUeberzeitStats();
        }

        function updateSollFromWoche() {

            const sollWoche = parseFloat(document.getElementById('soll-woche').value) || 42;
            const sollMinutenProTag = (sollWoche * 60) / 5;
            const sollZeit = minToTime(Math.round(sollMinutenProTag));

            document.getElementById('soll').value = sollZeit;
            document.getElementById('soll-berechnet').textContent = `${sollWoche}h √∑ 5 = ${sollZeit}`;

            updateSettings();
        }

        function updateSettings() {
            settings.soll = document.getElementById('soll').value;
            settings.pause = document.getElementById('pause').value;
            settings.ueberzeitVorgabe = document.getElementById('ueberzeit-vorgabe').value;
            settings.urlaubTage = parseInt(document.getElementById('settings-urlaub').value);
            settings.resturlaubVorjahr = parseInt(document.getElementById('settings-resturlaub').value) || 0;
            settings.kanton = document.getElementById('settings-kanton').value;
            settings.sollWoche = parseFloat(document.getElementById('soll-woche').value) || 42;
            settings.name = document.getElementById('settings-name').value;
            settings.personalnummer = document.getElementById('settings-personalnummer').value;

            if (document.getElementById('settings-ueberzeit-datum')) {
                const datum = document.getElementById('settings-ueberzeit-datum').value || (new Date().getFullYear() + '-01-01');
                settings.ueberzeitStartDatum = datum;
                settings.ueberzeitStartJahr = parseInt(datum.substring(0, 4));

                const ueberzeitStartStr = document.getElementById('settings-ueberzeit-start').value.trim();
                settings.ueberzeitStartStand = parseOvertimeString(ueberzeitStartStr);
            }

            saveToStorage();
            calc();
            updateUserInfo();
            updateUrlaubStats();
            updateUeberzeitStats();

            if (view === 'woche') renderWoche();
            if (view === 'monat') renderMonat();
            if (view === 'jahr') renderJahr();
        }

        function updateUeberzeitStats() {
            const startDatum = settings.ueberzeitStartDatum || (new Date().getFullYear() + '-01-01');
            const startJahr = parseInt(startDatum.substring(0, 4));
            const startStand = settings.ueberzeitStartStand || 0;
            const sollProTag = timeToMin(settings.soll);

            let erarbeitet = 0;
            let kompensationstage = 0;

            // Alle Tage ab dem Startjahr durchgehen
            for (const datum in data) {
                const jahr = parseInt(datum.substring(0, 4));
                if (jahr < startJahr) continue;

                const entry = data[datum];
                if (!entry) continue;

                const [y, m, d] = datum.split('-').map(Number);
                const dt = new Date(y, m - 1, d);
                const dayOfWeek = dt.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                // Arbeitszeit berechnen
                let arb = 0;
                if (entry.mk && entry.mg) arb += timeToMin(entry.mg) - timeToMin(entry.mk);
                if (entry.mittk && entry.ag) arb += timeToMin(entry.ag) - timeToMin(entry.mittk);
                if (arb >= 360) arb -= timeToMin(settings.pause);

                // Sollzeit berechnen
                let sollMin = 0;
                const isFT = isFeiertag(datum);
                const ftBezahlt = isFT ? isFeiertagBezahlt(datum) : false;

                if (!isWeekend && !(isFT && ftBezahlt)) {
                    if (entry.tagTyp === 'kompensation') {
                        kompensationstage++;
                        sollMin = sollProTag;  // Sollzeit setzen f√ºr korrekte Berechnung
                    } else if (entry.tagTyp !== 'urlaub' && entry.tagTyp !== 'krank' && entry.tagTyp !== 'unbezahlt') {
                        sollMin = sollProTag;
                    }
                }

                // √úberzeit akkumulieren
                if (arb > 0 || sollMin > 0) {
                    erarbeitet += (arb - sollMin);
                }
            }

            const bezogen = 0;  // Kompensation ist jetzt in erarbeitet enthalten
            const aktuell = startStand + erarbeitet;

            // UI aktualisieren
            if (document.getElementById('ueberzeit-start-display')) {
                document.getElementById('ueberzeit-start-display').textContent = formatOvertimeString(startStand);
                document.getElementById('ueberzeit-erarbeitet').textContent = formatOvertimeString(erarbeitet);
                document.getElementById('ueberzeit-bezogen').textContent = minToTime(bezogen);
                document.getElementById('ueberzeit-aktuell').textContent = formatOvertimeString(aktuell);

                // Formatiere Datum f√ºr Anzeige: "01.10.2025"
                const [y, m, d] = startDatum.split('-');
                const datumFormatiert = `${d}.${m}.${y}`;
                document.getElementById('stats-datum-display').textContent = datumFormatiert;

                // Industriezeit anzeigen
                document.getElementById('ueberzeit-start-industrial').textContent = minToIndustrialHours(startStand);
                document.getElementById('ueberzeit-erarbeitet-industrial').textContent = minToIndustrialHours(erarbeitet);
                document.getElementById('ueberzeit-bezogen-industrial').textContent = (bezogen / 60).toFixed(2) + 'h';
                document.getElementById('ueberzeit-aktuell-industrial').textContent = minToIndustrialHours(aktuell);

                // Farbe f√ºr "Aktuell" je nach Wert
                const aktuellEl = document.getElementById('ueberzeit-aktuell');
                if (aktuell > 0) {
                    aktuellEl.style.color = '#10B981';
                } else if (aktuell < 0) {
                    aktuellEl.style.color = '#EF4444';
                } else {
                    aktuellEl.style.color = '#6B7280';
                }
            }
        }

        function updateUrlaubStats() {
            const currentYear = new Date().getFullYear();
            let verbraucht = 0;

            for (const datum in data) {
                const jahr = parseInt(datum.substring(0, 4));
                if (jahr === currentYear) {
                    const entry = data[datum];
                    if (entry && entry.tagTyp === 'urlaub') {
                        // Pr√ºfe ob es ein bezahlter Feiertag ist (diese z√§hlen NICHT als Urlaubstag)
                        const isFT = isFeiertag(datum);
                        const ftBezahlt = isFT ? isFeiertagBezahlt(datum) : false;
                        if (!(isFT && ftBezahlt)) {
                            verbraucht++;
                        }
                    }
                }
            }

            const gesamt = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
            const rest = gesamt - verbraucht;

            if (document.getElementById('urlaub-gesamt')) {
                // Update Jahr im Label
                const jahrLabel = document.getElementById('urlaub-jahr-label');
                if (jahrLabel) {
                    jahrLabel.textContent = `Urlaubstage im Jahr ${currentYear}`;
                }

                // Zeige nur die Zahl (ohne Klammern)
                document.getElementById('urlaub-gesamt').textContent = gesamt;
                document.getElementById('urlaub-verbraucht').textContent = verbraucht;
                document.getElementById('urlaub-rest').textContent = rest;

                const restEl = document.getElementById('urlaub-rest');
                if (rest < 0) {
                    restEl.style.color = '#EF4444';
                } else if (rest < 5) {
                    restEl.style.color = '#F59E0B';
                } else {
                    restEl.style.color = '#10B981';
                }
            }

            // Update Monatsansicht
            if (document.getElementById('m-urlaub-gesamt')) {
                const mJahrLabel = document.getElementById('m-urlaub-jahr-label');
                if (mJahrLabel) {
                    mJahrLabel.textContent = `Urlaubstage im Jahr ${currentYear}`;
                }
                document.getElementById('m-urlaub-gesamt').textContent = gesamt;
                document.getElementById('m-urlaub-verbraucht').textContent = verbraucht;
                document.getElementById('m-urlaub-rest').textContent = rest;
            }

            // Update Jahresansicht - verwende calculateUrlaubForYear f√ºr korrekte Berechnung
            if (document.getElementById('j-urlaub-gesamt')) {
                // Verwende die globale 'year' Variable f√ºr das angezeigte Jahr
                const urlaubData = calculateUrlaubForYear(year);

                const jJahrLabel = document.getElementById('j-urlaub-jahr-label');
                if (jJahrLabel) {
                    jJahrLabel.textContent = `Urlaubstage im Jahr ${urlaubData.jahr}`;
                }
                document.getElementById('j-urlaub-gesamt').textContent = urlaubData.gesamt;
                document.getElementById('j-urlaub-verbraucht').textContent = urlaubData.verbraucht;
                document.getElementById('j-urlaub-rest').textContent = urlaubData.rest;
            }
        }

        // Berechne Urlaubstage f√ºr ein bestimmtes Jahr
        // Wenn das Jahr in der Zukunft liegt, verwende die verf√ºgbaren Tage des aktuellen Jahres als Resturlaub
        function calculateUrlaubForYear(jahr) {
            const currentYear = new Date().getFullYear();
            let verbraucht = 0;

            // Z√§hle verbrauchte Urlaubstage im angegebenen Jahr
            for (const datum in data) {
                const datumJahr = parseInt(datum.substring(0, 4));
                if (datumJahr === jahr) {
                    const entry = data[datum];
                    if (entry && entry.tagTyp === 'urlaub') {
                        const isFT = isFeiertag(datum);
                        const ftBezahlt = isFT ? isFeiertagBezahlt(datum) : false;
                        if (!(isFT && ftBezahlt)) {
                            verbraucht++;
                        }
                    }
                }
            }

            let gesamt, resturlaub;

            if (jahr > currentYear) {
                // Zuk√ºnftiges Jahr: Berechne verf√ºgbare Tage aus dem Vorjahr
                const vorjahr = jahr - 1;
                let verbrauchtVorjahr = 0;

                for (const datum in data) {
                    const datumJahr = parseInt(datum.substring(0, 4));
                    if (datumJahr === vorjahr) {
                        const entry = data[datum];
                        if (entry && entry.tagTyp === 'urlaub') {
                            const isFT = isFeiertag(datum);
                            const ftBezahlt = isFT ? isFeiertagBezahlt(datum) : false;
                            if (!(isFT && ftBezahlt)) {
                                verbrauchtVorjahr++;
                            }
                        }
                    }
                }

                // Berechne verf√ºgbare Tage aus Vorjahr
                const gesamtVorjahr = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
                resturlaub = Math.max(0, gesamtVorjahr - verbrauchtVorjahr);
                gesamt = (settings.urlaubTage || 25) + resturlaub;
            } else if (jahr === currentYear) {
                // Aktuelles Jahr: Verwende settings
                gesamt = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
                resturlaub = settings.resturlaubVorjahr || 0;
            } else {
                // Vergangenes Jahr: Nur urlaubTage, KEIN Resturlaub (da wir nicht wissen, wie viel es damals gab)
                gesamt = settings.urlaubTage || 25;
                resturlaub = 0;
            }

            const rest = gesamt - verbraucht;

            return { gesamt, verbraucht, rest, jahr, resturlaub };
        }

        // ========================================
        // JAHRESWECHSEL: AUTOMATISCHER RESTURLAUB-√úBERTRAG
        // ========================================

        function calculateRestUrlaubForYear(jahr) {
            let verbraucht = 0;

            for (const datum in data) {
                const datumJahr = parseInt(datum.substring(0, 4));
                if (datumJahr === jahr) {
                    const entry = data[datum];
                    if (entry && entry.tagTyp === 'urlaub') {
                        // Pr√ºfe ob es ein bezahlter Feiertag ist (diese z√§hlen nicht als Urlaubstag)
                        const isFT = isFeiertag(datum);
                        const ftBezahlt = isFT ? isFeiertagBezahlt(datum) : false;
                        if (!(isFT && ftBezahlt)) {
                            verbraucht++;
                        }
                    }
                }
            }

            // WICHTIG: F√ºr das Vorjahr verwenden wir die AKTUELLEN Einstellungen
            // (urlaubTage und resturlaubVorjahr), da diese f√ºr das Vorjahr galten
            // BEVOR der Jahreswechsel stattfand
            const urlaubTageProJahr = settings.urlaubTage || 25;
            const resturlaubAusVorvorjahr = settings.resturlaubVorjahr || 0;

            const gesamt = urlaubTageProJahr + resturlaubAusVorvorjahr;
            return Math.max(0, gesamt - verbraucht);
        }

        function showYearChangeDialog(altesJahr, neuesJahr, resturlaub) {
            // Automatisch √ºbernehmen (kein Best√§tigungsdialog)
            settings.resturlaubVorjahr = resturlaub;
            settings.lastProcessedYear = neuesJahr;
            saveToStorage();
            updateUrlaubStats();

            // Zeige styled Notification Banner
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
                color: white;
                padding: 1.5rem 2rem;
                border-radius: 1rem;
                box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
                z-index: 10000;
                min-width: 400px;
                max-width: 90%;
                text-align: center;
                animation: slideDown 0.5s ease-out;
            `;

            banner.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üéá</div>
                <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.75rem;">
                    Willkommen im Jahr ${neuesJahr}!
                </div>
                <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">
                    Resturlaub aus ${altesJahr}: <strong>${resturlaub} Tage</strong>
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9;">
                    (in Einstellungen anpassen)
                </div>
            `;

            // Animation hinzuf√ºgen
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from {
                        opacity: 0;
                        transform: translateX(-50%) translateY(-20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(-50%) translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(banner);

            // Banner nach 10 Sekunden ausblenden
            setTimeout(() => {
                banner.style.transition = 'opacity 0.5s ease-out';
                banner.style.opacity = '0';
                setTimeout(() => banner.remove(), 500);
            }, 10000);
        }

        function checkYearChange() {
            const currentYear = new Date().getFullYear();
            const lastYear = settings.lastProcessedYear || currentYear;

            if (currentYear > lastYear) {
                // Berechne Resturlaub vom Vorjahr
                const restUrlaubVorjahr = calculateRestUrlaubForYear(lastYear);

                // Zeige Dialog mit kleiner Verz√∂gerung, damit die UI geladen ist
                setTimeout(() => {
                    showYearChangeDialog(lastYear, currentYear, restUrlaubVorjahr);
                }, 500);
            }
        }

        function showMassenUrlaubDialog() {
            document.getElementById('massenurlaub-modal').classList.remove('hidden');
            document.getElementById('urlaub-von').value = '';
            document.getElementById('urlaub-bis').value = '';
            document.getElementById('urlaub-wochenende').checked = true;
            document.getElementById('urlaub-vorschau').style.display = 'none';
        }

        function closeMassenUrlaub() {
            document.getElementById('massenurlaub-modal').classList.add('hidden');
        }

        function updateUrlaubBisDatum() {
            const vonInput = document.getElementById('urlaub-von');
            const bisInput = document.getElementById('urlaub-bis');

            if (vonInput.value) {
                const vonDate = new Date(vonInput.value);
                const bisDate = bisInput.value ? new Date(bisInput.value) : null;

                // Wenn Bis-Datum leer ist oder vor dem Von-Datum liegt, 
                // setze es auf den letzten Tag des Monats vom Von-Datum
                if (!bisDate || bisDate < vonDate) {
                    const year = vonDate.getFullYear();
                    const month = vonDate.getMonth();
                    const lastDay = new Date(year, month + 1, 0).getDate();

                    const bisValue = `${year}-${String(month + 1).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
                    bisInput.value = bisValue;
                }
            }
        }

        function updateUrlaubVorschau() {
            const von = document.getElementById('urlaub-von').value;
            const bis = document.getElementById('urlaub-bis').value;
            const skipWeekend = document.getElementById('urlaub-wochenende').checked;

            if (!von || !bis) {
                document.getElementById('urlaub-vorschau').style.display = 'none';
                return;
            }

            const start = new Date(von + 'T12:00:00');
            const end = new Date(bis + 'T12:00:00');

            if (start > end) {
                document.getElementById('urlaub-vorschau').style.display = 'none';
                return;
            }

            let count = 0;
            const current = new Date(start);

            while (current <= end) {
                const dayOfWeek = current.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                if (!skipWeekend || !isWeekend) {
                    count++;
                }

                current.setDate(current.getDate() + 1);
            }

            document.getElementById('urlaub-anzahl').textContent = count;
            document.getElementById('urlaub-vorschau').style.display = 'block';
        }

        function saveMassenUrlaub() {
            const von = document.getElementById('urlaub-von').value;
            const bis = document.getElementById('urlaub-bis').value;
            const skipWeekend = document.getElementById('urlaub-wochenende').checked;

            if (!von || !bis) {
                alert('Bitte beide Daten ausw√§hlen!');
                return;
            }

            const start = new Date(von + 'T12:00:00');
            const end = new Date(bis + 'T12:00:00');

            if (start > end) {
                alert('Das "Von"-Datum muss vor dem "Bis"-Datum liegen!');
                return;
            }

            let count = 0;
            const current = new Date(start);

            while (current <= end) {
                const dayOfWeek = current.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                if (!skipWeekend || !isWeekend) {
                    const dateStr = current.getFullYear() + '-' +
                        String(current.getMonth() + 1).padStart(2, '0') + '-' +
                        String(current.getDate()).padStart(2, '0');

                    if (!data[dateStr]) {
                        data[dateStr] = {};
                    }
                    data[dateStr].tagTyp = 'urlaub';
                    count++;
                }

                current.setDate(current.getDate() + 1);
            }

            saveToStorage();
            closeMassenUrlaub();
            updateUrlaubStats();

            alert(`‚úì ${count} Urlaubstage eingetragen!`);

            if (view === 'tag') loadTag();
            if (view === 'woche') renderWoche();
            if (view === 'monat') renderMonat();
            if (view === 'jahr') renderJahr();
        }

        function updateTagTyp() {
            const tagTypRadios = document.getElementsByName('tagTyp');
            let selectedTyp = 'normal';
            for (const radio of tagTypRadios) {
                if (radio.checked) {
                    selectedTyp = radio.value;
                    break;
                }
            }
            updateTagTypAnzeige(selectedTyp);
        }

        let urlaubLoeschModus = false;
        let ausgewaehlteUrlaubstage = new Set();

        // Hilfsfunktion zum Aktualisieren beider Buttons
        function updateLoeschButtons(html, className) {
            const btn1 = document.getElementById('urlaub-loeschen-btn');
            const btn2 = document.getElementById('urlaub-loeschen-btn-monat');

            if (btn1) {
                btn1.innerHTML = html;
                btn1.className = className;
            }
            if (btn2) {
                btn2.innerHTML = html;
                btn2.className = className;
            }
        }

        function toggleUrlaubLoeschModus() {
            // Diese Funktion funktioniert nur in der Monatsansicht
            if (view !== 'monat') {
                alert('Das L√∂schen mehrerer Urlaubstage funktioniert nur in der Monatsansicht.');
                return;
            }

            urlaubLoeschModus = !urlaubLoeschModus;

            if (urlaubLoeschModus) {
                updateLoeschButtons('‚úÖ Ausgew√§hlte l√∂schen', 'btn btn-success');

                // F√ºge Hinweis hinzu
                const hinweisDiv = document.createElement('div');
                hinweisDiv.id = 'loeschen-hinweis';
                hinweisDiv.className = 'loeschen-hinweis';
                hinweisDiv.innerHTML = '‚ö†Ô∏è L√∂schmodus aktiv: Klicke auf Urlaubstage zum Ausw√§hlen, dann auf "Ausgew√§hlte l√∂schen"';

                const monthView = document.getElementById('v-monat');

                if (view === 'monat' && monthView) {
                    monthView.insertBefore(hinweisDiv, monthView.firstChild);
                }

                markiereUrlaubstage();
            } else {
                // L√∂sche ausgew√§hlte Tage wenn welche markiert sind
                if (ausgewaehlteUrlaubstage.size > 0) {
                    if (confirm(`M√∂chten Sie ${ausgewaehlteUrlaubstage.size} Urlaubstag(e) l√∂schen?`)) {
                        ausgewaehlteUrlaubstage.forEach(dateStr => {
                            if (data[dateStr]) {
                                delete data[dateStr].tagTyp;
                            }
                        });
                        save();
                    }
                }

                // Beende L√∂schmodus
                updateLoeschButtons('üóëÔ∏è Mehrere Urlaubstage l√∂schen', 'btn btn-danger');

                const hinweis = document.getElementById('loeschen-hinweis');
                if (hinweis) hinweis.remove();

                ausgewaehlteUrlaubstage.clear();
                entferneMarkierungen();

                // Aktualisiere Ansicht
                if (view === 'monat') renderMonat();
                else if (view === 'jahr') renderJahr();
            }
        }

        function markiereUrlaubstage() {
            const calDivs = document.querySelectorAll('.cal-day');

            calDivs.forEach(div => {
                const dateStr = div.getAttribute('data-date');
                if (dateStr && data[dateStr] && data[dateStr].tagTyp === 'urlaub') {
                    div.classList.add('urlaub-auswahl');
                    div.onclick = function (e) {
                        e.stopPropagation();
                        if (ausgewaehlteUrlaubstage.has(dateStr)) {
                            ausgewaehlteUrlaubstage.delete(dateStr);
                            div.classList.remove('urlaub-ausgewaehlt');
                        } else {
                            ausgewaehlteUrlaubstage.add(dateStr);
                            div.classList.add('urlaub-ausgewaehlt');
                        }

                        // Update beide Buttons
                        const btnText = ausgewaehlteUrlaubstage.size > 0
                            ? `‚úÖ ${ausgewaehlteUrlaubstage.size} Tag(e) l√∂schen`
                            : '‚úÖ Ausgew√§hlte l√∂schen';
                        updateLoeschButtons(btnText, 'btn btn-success');
                    };
                }
            });
        }

        function entferneMarkierungen() {
            const calDivs = document.querySelectorAll('.cal-day');
            calDivs.forEach(div => {
                div.classList.remove('urlaub-auswahl', 'urlaub-ausgewaehlt');
                div.onclick = null;
            });
        }

        function updateUserInfo() {
            const userInfoEl = document.getElementById('user-info');
            if (!userInfoEl) return;

            const name = settings.name || '';
            const persNr = settings.personalnummer || '';

            if (name || persNr) {
                let html = '';
                if (name) html += `<div class="user-info-name">${name}</div>`;
                if (persNr) html += `<div class="user-info-persnr">Pers. Nr. ${persNr}</div>`;
                userInfoEl.innerHTML = html;
            } else {
                userInfoEl.innerHTML = '';
            }
        }

        function toggleDark() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.getElementById('icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDark);

            // Aktualisiere Tag-Typ-Anzeige mit korrekten Farben f√ºr den neuen Modus
            const tagTypRadios = document.getElementsByName('tagTyp');
            let selectedTyp = 'normal';
            for (const radio of tagTypRadios) {
                if (radio.checked) {
                    selectedTyp = radio.value;
                    break;
                }
            }
            updateTagTypAnzeige(selectedTyp);
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark');
            document.getElementById('icon').textContent = '‚òÄÔ∏è';
        }

        // Globaler Click-Listener zum Schlie√üen des Men√ºs
        function closeExportMenuOutside(event) {
            const menu = document.getElementById('export-menu');
            const toggleBtn = event.target.closest('button[onclick="toggleExport()"]');

            // Wenn Klick NICHT im Men√º und NICHT auf dem Toggle-Button
            if (menu && !menu.contains(event.target) && !toggleBtn) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeExportMenuOutside);
            }
        }

        function toggleExport() {
            const menu = document.getElementById('export-menu');
            const isHidden = menu.classList.contains('hidden');

            if (isHidden) {
                // Men√º √∂ffnen
                menu.classList.remove('hidden');

                // Update visibility based on current view
                const isSettings = view === 'einstellungen';
                const timeExports = menu.querySelectorAll('.time-export');
                const settingsExports = menu.querySelectorAll('.settings-export');

                // Hide time-related exports in Settings view
                timeExports.forEach(el => {
                    el.style.display = isSettings ? 'none' : '';
                });

                // Always show settings exports
                settingsExports.forEach(el => {
                    el.style.display = '';
                });

                // Event Listener hinzuf√ºgen (mit kleiner Verz√∂gerung, damit der aktuelle Klick nicht sofort schlie√üt)
                setTimeout(() => {
                    document.addEventListener('click', closeExportMenuOutside);
                }, 0);

            } else {
                // Men√º schlie√üen
                menu.classList.add('hidden');
                document.removeEventListener('click', closeExportMenuOutside);
            }
        }

        function getExportDates() {

            let dates = [];

            switch (view) {
                case 'tag':

                    dates = [date];
                    break;

                case 'woche':

                    const [y, m, d] = woche.split('-').map(Number);
                    const monday = new Date(y, m - 1, d);
                    for (let i = 0; i < 7; i++) {
                        const dt = new Date(monday);
                        dt.setDate(dt.getDate() + i);
                        const dateStr = dt.getFullYear() + '-' +
                            String(dt.getMonth() + 1).padStart(2, '0') + '-' +
                            String(dt.getDate()).padStart(2, '0');
                        dates.push(dateStr);
                    }
                    break;

                case 'monat':

                    const [yM, mM] = month.split('-').map(Number);
                    const lastDay = new Date(yM, mM, 0);
                    for (let day = 1; day <= lastDay.getDate(); day++) {
                        const dateStr = yM + '-' + String(mM).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                        dates.push(dateStr); // ALLE Tage hinzuf√ºgen, nicht nur mit Daten
                    }
                    break;

                case 'jahr':

                    for (let m = 1; m <= 12; m++) {
                        const lastDay = new Date(year, m, 0);
                        for (let day = 1; day <= lastDay.getDate(); day++) {
                            const dateStr = year + '-' + String(m).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                            dates.push(dateStr); // ALLE Tage hinzuf√ºgen, nicht nur mit Daten
                        }
                    }
                    break;

                default:

                    dates = Object.keys(data).sort();
            }

            return dates.sort();
        }

        function getExportTitle() {

            switch (view) {
                case 'tag':
                    const [y, m, d] = date.split('-').map(Number);
                    return `Tag_${d}.${m}.${y}`;
                case 'woche':
                    const [yW, mW, dW] = woche.split('-').map(Number);
                    const monday = new Date(yW, mW - 1, dW);
                    const sunday = new Date(monday);
                    sunday.setDate(sunday.getDate() + 6);
                    return `KW${getWeekNumber(monday)}_${yW}`;
                case 'monat':
                    const [yM, mM] = month.split('-').map(Number);
                    const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                    return `${months[mM - 1]}_${yM}`;
                case 'jahr':
                    return `Jahr_${year}`;
                default:
                    return 'Arbeitszeiten';
            }
        }

        function minToExcelTime(minutes) {
            // Konvertiert Minuten in Excel-Zeitwert (1 Tag = 1.0)
            // Excel speichert Zeiten als Dezimalzahl: 0.5 = 12 Stunden, 1.0 = 24 Stunden
            // Beispiel: 504 Minuten (8:24) ‚Üí 0.35 (504 / 1440)
            return minutes / (24 * 60);
        }

        async function exportExcel() {
            try {
                const wb = new ExcelJS.Workbook();

                // SPEZIALBEHANDLUNG F√úR JAHR: 12 Worksheets erstellen (ein pro Monat)
                if (view === 'jahr') {
                    const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                    const sollProTag = timeToMin(settings.soll);
                    let ueberzeitMinutenGesamt = settings.ueberzeitStartStand || 0;

                    for (let monthNum = 1; monthNum <= 12; monthNum++) {
                        const ws = wb.addWorksheet(`${months[monthNum - 1]} ${year}`);

                        const startRow = 2;
                        const startCol = 2;

                        // Zeile 2: Titel "Arbeitszeiten" in B2
                        const titleCell = ws.getCell(2, 2);
                        titleCell.value = 'Arbeitszeiten';
                        titleCell.font = { bold: true, size: 16, color: { argb: 'FF6366F1' } };
                        titleCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };
                        ws.getRow(2).height = 30;

                        // Name und Personal.Nr. √úBER Notiz-Spalte (L2 und L3)
                        if (settings.name || settings.personalnummer) {
                            let nameText = '';
                            if (settings.name) nameText = settings.name;
                            if (settings.personalnummer) {
                                if (nameText) nameText += '\n';
                                nameText += 'Personal.Nr. ' + settings.personalnummer;
                            }
                            const nameCell = ws.getCell('L2');
                            nameCell.value = nameText;
                            nameCell.font = { name: 'Calibri', bold: true, size: 11, color: { argb: 'FF646464' } };
                            nameCell.alignment = { vertical: 'top', horizontal: 'right', wrapText: true };
                            ws.mergeCells('L2:L3');
                        }

                        // Zeile 3: Monat und Jahr
                        const kwCell = ws.getCell(3, 2);
                        kwCell.value = `${months[monthNum - 1]} ${year}`;
                        kwCell.font = { bold: true, size: 12, color: { argb: 'FF646464' } };
                        kwCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };
                        ws.getRow(3).height = 20;

                        // Header
                        const headerRow = 4;
                        const headers = ['Wochentag', 'Datum', 'Morgen\nKommen', 'Morgen\nGehen', 'Mittag\nKommen', 'Abend\nGehen', 'Arbeitszeit', 'Sollzeit', 'Differenz', '√úberzeit\nKonto', 'Notiz'];
                        headers.forEach((header, i) => {
                            const cell = ws.getCell(headerRow, startCol + i);
                            cell.value = header;
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF6366F1' } };
                            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                            cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                            };
                        });
                        ws.getRow(headerRow).height = 30;

                        const widths = [12, 14, 14, 14, 14, 14, 12, 10, 12, 14, 35];
                        widths.forEach((width, i) => {
                            ws.getColumn(startCol + i).width = width;
                        });
                        ws.getColumn(13).width = 3;

                        // Urlaubstage f√ºr diesen Monat berechnen
                        let urlaubstageVerbraucht = getUrlaubBisZumMonat(monthNum);

                        let totalArb = 0, totalSoll = 0;
                        let krankheitstageGesamt = 0;
                        let unbezahlteTage = 0;
                        let kompensationsTage = 0;
                        let feiertageBezahlt = 0;
                        let feiertageUnbezahlt = 0;
                        let currentRow = headerRow + 1;

                        // Alle Daten f√ºr diesen Monat sammeln
                        const allDates = [];
                        const lastDay = new Date(parseInt(year), monthNum, 0);
                        for (let day = 1; day <= lastDay.getDate(); day++) {
                            allDates.push(`${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                        }

                        allDates.forEach(dateStr => {
                            const d = data[dateStr] || {};
                            const [y, m, day] = dateStr.split('-').map(Number);
                            const dt = new Date(y, m - 1, day);
                            const dayOfWeek = dt.getDay();
                            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                            let arb = 0;
                            if (d.mk && d.mg) arb += timeToMin(d.mg) - timeToMin(d.mk);
                            if (d.mittk && d.ag) arb += timeToMin(d.ag) - timeToMin(d.mittk);
                            if (arb >= 360) arb -= timeToMin(settings.pause);

                            let sollMin = 0;
                            const isFT = isFeiertag(dateStr);
                            const ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;

                            if (!isWeekend) {
                                if (isFT && ftBezahlt) {
                                    feiertageBezahlt++;
                                } else if (d.tagTyp === 'urlaub') {
                                    // KEINE Sollzeit
                                } else if (d.tagTyp === 'krank') {
                                    krankheitstageGesamt++;
                                } else if (d.tagTyp === 'kompensation') {
                                    kompensationsTage++;
                                    sollMin = sollProTag;
                                } else if (d.tagTyp === 'unbezahlt') {
                                    unbezahlteTage++;
                                } else if (isFT && !ftBezahlt) {
                                    feiertageUnbezahlt++;
                                } else {
                                    sollMin = sollProTag;
                                }
                            }

                            totalArb += arb;


                            totalSoll += sollMin;
                            const diff = sollMin - arb;
                            if (arb > 0 || sollMin > 0) ueberzeitMinutenGesamt += (arb - sollMin);

                            const values = [
                                ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][dayOfWeek],
                                `${String(day).padStart(2, '0')}.${String(m).padStart(2, '0')}.${y} `,
                                d.mk || '',
                                d.mg || '',
                                d.mittk || '',
                                d.ag || '',
                                arb > 0 ? minToExcelTime(arb) : '',
                                sollMin > 0 ? minToExcelTime(sollMin) : '',
                                (arb > 0 || sollMin > 0) ? ((diff < 0 ? '+' : diff > 0 ? '-' : '') + minToTime(Math.abs(diff))) : '',
                                (ueberzeitMinutenGesamt < 0 ? '-' : '+') + minToTime(Math.abs(ueberzeitMinutenGesamt)),
                                d.notiz || ''
                            ];

                            values.forEach((value, i) => {
                                const cell = ws.getCell(currentRow, startCol + i);
                                cell.value = value;
                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            });

                            // Excel-Zeitformat f√ºr Arbeitszeit und Sollzeit
                            if (arb > 0) {
                                ws.getCell(currentRow, startCol + 6).numFmt = '[h]:mm';
                            }
                            if (sollMin > 0) {
                                ws.getCell(currentRow, startCol + 7).numFmt = '[h]:mm';
                            }

                            let fillColor = null;
                            if (isFT && ftBezahlt) {
                                fillColor = 'FFDBEAFE';
                            } else if (isFT && !ftBezahlt) {
                                fillColor = 'FFFED7AA';
                            } else if (d.tagTyp === 'feiertag-bezahlt') {
                                fillColor = 'FFDBEAFE';
                            } else if (d.tagTyp === 'feiertag-unbezahlt') {
                                fillColor = 'FFFED7AA';
                            } else if (d.tagTyp === 'urlaub') {
                                fillColor = 'FFD1FAE5';
                            } else if (d.tagTyp === 'krank') {
                                fillColor = 'FFFEF3C7';
                            } else if (d.tagTyp === 'unbezahlt') {
                                fillColor = 'FFFECACA';
                            } else if (d.tagTyp === 'kompensation') {
                                fillColor = 'FFC4B5FD';
                            } else if (isWeekend) {
                                fillColor = 'FFF3F4F6';
                            }

                            for (let i = 0; i < 11; i++) {
                                const cell = ws.getCell(currentRow, startCol + i);
                                if (fillColor) {
                                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
                                }
                                cell.border = {
                                    top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                    left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                    bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                    right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                                };
                            }

                            const diffCell = ws.getCell(currentRow, startCol + 8);
                            if (diff < 0) diffCell.font = { color: { argb: 'FF10B981' }, bold: false, italic: true };
                            else if (diff > 0) diffCell.font = { color: { argb: 'FFEF4444' }, bold: false, italic: true };

                            const ueberzeitCell = ws.getCell(currentRow, startCol + 9);
                            if (ueberzeitMinutenGesamt > 0) ueberzeitCell.font = { color: { argb: 'FF10B981' }, bold: false, italic: true };
                            else if (ueberzeitMinutenGesamt < 0) ueberzeitCell.font = { color: { argb: 'FFEF4444' }, bold: false, italic: true };

                            // Notiz-Formatierung: Linksb√ºndig, wrapText, schwarze Schrift (NACH allen anderen Formatierungen!)
                            if (d.notiz) {
                                const notizCell = ws.getCell(currentRow, startCol + 10);
                                notizCell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
                                notizCell.font = { color: { argb: 'FF000000' } };
                            }

                            currentRow++;
                        });

                        // Dicke graue Linie unter der letzten Datenzeile (Trennung zu Summen)
                        for (let i = 0; i < 11; i++) {
                            const cell = ws.getCell(currentRow - 1, startCol + i);
                            // Bestehende Rahmen beibehalten, nur unten √§ndern
                            const existingBorder = cell.border || {};
                            cell.border = {
                                ...existingBorder,
                                bottom: { style: 'medium', color: { argb: 'FF9CA3AF' } } // Mittelgrau
                            };
                        }

                        const totalDiff = totalSoll - totalArb;

                        const arbValues = ['', 'Arbeitszeit', '', '', '', '',
                            minToExcelTime(totalArb),
                            minToExcelTime(totalSoll),
                            (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + minToTime(Math.abs(totalDiff)),
                            (ueberzeitMinutenGesamt < 0 ? '-' : '+') + minToTime(Math.abs(ueberzeitMinutenGesamt)),
                            ''
                        ];
                        arbValues.forEach((value, i) => {
                            const cell = ws.getCell(currentRow, startCol + i);
                            cell.value = value;
                            cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            cell.font = { italic: true, bold: true };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                            };
                        });

                        // Excel-Zeitformat f√ºr Summenzeile
                        ws.getCell(currentRow, startCol + 6).numFmt = '[h]:mm';
                        ws.getCell(currentRow, startCol + 7).numFmt = '[h]:mm';

                        if (totalDiff < 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
                        else if (totalDiff > 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };
                        if (ueberzeitMinutenGesamt > 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
                        else if (ueberzeitMinutenGesamt < 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };

                        currentRow++;

                        const indValues = ['', 'Industriezeit', '', '', '', '',
                            (totalArb / 60).toFixed(2),
                            (totalSoll / 60).toFixed(2),
                            (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + (Math.abs(totalDiff) / 60).toFixed(2),
                            (ueberzeitMinutenGesamt < 0 ? '-' : '+') + (Math.abs(ueberzeitMinutenGesamt) / 60).toFixed(2),
                            ''
                        ];
                        indValues.forEach((value, i) => {
                            const cell = ws.getCell(currentRow, startCol + i);
                            cell.value = value;
                            cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            cell.font = { italic: true, bold: true };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                                right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                            };
                        });

                        if (totalDiff < 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
                        else if (totalDiff > 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };
                        if (ueberzeitMinutenGesamt > 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
                        else if (ueberzeitMinutenGesamt < 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };

                        // Legende RECHTS neben Tabelle (mit 1 Spalte Abstand)
                        const legendCol = 14;
                        let legendRow = headerRow;

                        ws.getCell(legendRow, legendCol).value = 'Legende:';
                        ws.getCell(legendRow, legendCol).font = { bold: true, size: 11 };
                        ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                        legendRow++;

                        const urlaubGesamt = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
                        const urlaubRest = urlaubGesamt - urlaubstageVerbraucht;

                        const legende = [
                            { text: 'Urlaub', color: 'FFD1FAE5', value: `${urlaubstageVerbraucht} Tage`, desc: 'Urlaub bezogen' },
                            { text: 'Krankheit', color: 'FFFEF3C7', value: `${krankheitstageGesamt} Tage`, desc: 'Krankheitstage' },
                            { text: 'Feiertag (bezahlt)', color: 'FFDBEAFE', value: `${feiertageBezahlt} Tage`, desc: 'Feiertag (bezahlt)' },
                            { text: 'Feiertag (unbezahlt)', color: 'FFFED7AA', value: `${feiertageUnbezahlt} Tage`, desc: 'Feiertag (unbezahlt)' },
                            { text: 'Unbezahlt', color: 'FFFECACA', value: `${unbezahlteTage} Tage`, desc: 'Unbezahlter Urlaub' },
                            { text: 'Kompensation', color: 'FFC4B5FD', value: `${kompensationsTage} Tage`, desc: '√úberzeit-Kompensation' }
                        ];

                        legende.forEach((item) => {
                            const colorCell = ws.getCell(legendRow, legendCol);
                            colorCell.value = item.value || '    ';
                            colorCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: item.color } };
                            colorCell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                            colorCell.alignment = { vertical: 'middle', horizontal: 'center' };
                            if (item.value) {
                                colorCell.font = { bold: true };
                            }

                            const descCell = ws.getCell(legendRow, legendCol + 1);
                            descCell.value = item.desc;
                            descCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };

                            legendRow++;
                        });

                        legendRow++;

                        ws.getCell(legendRow, legendCol).value = 'Urlaubs√ºbersicht:';
                        ws.getCell(legendRow, legendCol).font = { bold: true, size: 11 };
                        ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                        legendRow++;

                        ws.getCell(legendRow, legendCol).value = 'Urlaubstage im Jahr:';
                        ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                        ws.getCell(legendRow, legendCol + 1).value = `${urlaubGesamt} Tage`;
                        ws.getCell(legendRow, legendCol + 1).font = { bold: true };
                        ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'right', indent: 1 };
                        legendRow++;

                        ws.getCell(legendRow, legendCol).value = 'bezogene Tage:';
                        ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                        ws.getCell(legendRow, legendCol + 1).value = `${urlaubstageVerbraucht} Tage`;
                        ws.getCell(legendRow, legendCol + 1).font = { bold: true };
                        ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'right', indent: 1 };
                        legendRow++;

                        ws.getCell(legendRow, legendCol).value = 'verf√ºgbare Tage:';
                        ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                        ws.getCell(legendRow, legendCol + 1).value = `${urlaubRest} Tage`;
                        ws.getCell(legendRow, legendCol + 1).font = { bold: true };
                        ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'right', indent: 1 };
                        if (urlaubRest < 0) {
                            ws.getCell(legendRow, legendCol + 1).font = { color: { argb: 'FFEF4444' }, bold: true };
                        }

                        ws.getColumn(legendCol).width = 18;
                        ws.getColumn(legendCol + 1).width = 20;

                        ws.pageSetup = {
                            paperSize: 9,
                            orientation: 'landscape',
                            fitToPage: true,
                            fitToWidth: 1,
                            fitToHeight: 1,
                            margins: {
                                left: 0.25,
                                right: 0.25,
                                top: 0.25,
                                bottom: 0.25,
                                header: 0,
                                footer: 0
                            }
                        };
                    }

                    // Workbook-Properties setzen um Datei-Sperr-Problem zu vermeiden
                    wb.creator = settings.name || 'Arbeitszeitrechner';
                    wb.lastModifiedBy = settings.name || 'Arbeitszeitrechner';
                    wb.created = new Date();
                    wb.modified = new Date();

                    // Schreibschutz deaktivieren
                    wb.calcProperties = wb.calcProperties || {};
                    wb.calcProperties.fullCalcOnLoad = true;

                    const buffer = await wb.xlsx.writeBuffer();
                    saveAs(new Blob([buffer]), `Arbeitszeiten_Jahr_${year}.xlsx`);

                    toggleExport();
                    return;
                }

                // NORMALE BEHANDLUNG F√úR TAG, WOCHE, MONAT
                const ws = wb.addWorksheet('Arbeitszeiten');

                const startRow = 2;
                const startCol = 2;

                // Zeile 2: B2 = "Arbeitszeiten"
                const titleCell = ws.getCell(2, 2);
                titleCell.value = 'Arbeitszeiten';
                titleCell.font = { bold: true, size: 16, color: { argb: 'FF6366F1' } };
                titleCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };

                ws.getRow(2).height = 30;

                // Name und Pers.Nr. √úBER Notiz-Spalte L2:L3
                if (settings.name || settings.personalnummer) {
                    let nameText = settings.name || '';
                    if (settings.name && settings.personalnummer) nameText += '\n';
                    if (settings.personalnummer) nameText += 'Personal.Nr. ' + settings.personalnummer;
                    const nameCell = ws.getCell('L2');
                    nameCell.value = nameText;
                    nameCell.font = { name: 'Calibri', bold: true, size: 11, color: { argb: 'FF646464' } };
                    nameCell.alignment = { vertical: 'top', horizontal: 'right', wrapText: true };
                    ws.mergeCells('L2:L3');
                }

                // Zeile 3: B3 = Datum
                let kwInfo = '';
                switch (view) {
                    case 'tag':
                        const [yT, mT, dT] = date.split('-').map(Number);
                        const dateObj = new Date(yT, mT - 1, dT);
                        kwInfo = `KW ${getWeekNumber(dateObj)}     ${dT}.${mT}.${yT} `;
                        break;
                    case 'woche':
                        const [yW2, mW2, dW2] = woche.split('-').map(Number);
                        const monday2 = new Date(yW2, mW2 - 1, dW2);
                        const sunday2 = new Date(monday2);
                        sunday2.setDate(sunday2.getDate() + 6);
                        kwInfo = `KW ${getWeekNumber(monday2)}     ${dW2}.${mW2}.- ${sunday2.getDate()}.${sunday2.getMonth() + 1}.${yW2} `;
                        break;
                    case 'monat':
                        const [yM2, mM2] = month.split('-').map(Number);
                        const months2 = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                        kwInfo = `${months2[mM2 - 1]} ${yM2} `;
                        break;
                }
                if (kwInfo) {
                    const kwCell = ws.getCell(3, 2);
                    kwCell.value = kwInfo;
                    kwCell.font = { bold: true, size: 12, color: { argb: 'FF646464' } };
                    kwCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };
                    ws.getRow(3).height = 20;
                }

                const headerRow = 4;
                const headers = ['Wochentag', 'Datum', 'Morgen\nKommen', 'Morgen\nGehen', 'Mittag\nKommen', 'Abend\nGehen', 'Arbeitszeit', 'Sollzeit', 'Differenz', '√úberzeit\nKonto', 'Notiz'];
                headers.forEach((header, i) => {
                    const cell = ws.getCell(headerRow, startCol + i);
                    cell.value = header;
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF6366F1' } };
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                    };
                });
                ws.getRow(headerRow).height = 30;

                const widths = [12, 14, 14, 14, 14, 14, 12, 10, 12, 14, 35];
                widths.forEach((width, i) => {
                    ws.getColumn(startCol + i).width = width;
                });
                // Add a small gap column between the main table and the name/personal number info
                ws.getColumn(startCol + headers.length).width = 3;

                const exportDates = getExportDates();
                const sollProTag = timeToMin(settings.soll);

                let urlaubstageVerbraucht = 0;
                if (exportDates.length > 0) {
                    const lastDateParts = exportDates[exportDates.length - 1].split('-');
                    const lastMonth = parseInt(lastDateParts[1]);
                    urlaubstageVerbraucht = getUrlaubBisZumMonat(lastMonth);
                }

                let totalArb = 0, totalSoll = 0;
                let ueberzeitMinuten = settings.ueberzeitStartStand || 0;
                let krankheitstageGesamt = 0;
                let unbezahlteTage = 0;
                let kompensationsTage = 0;
                let feiertageBezahlt = 0;
                let feiertageUnbezahlt = 0;
                let currentRow = headerRow + 1;

                exportDates.forEach(dateStr => {
                    const d = data[dateStr] || {};
                    const [y, m, day] = dateStr.split('-').map(Number);
                    const dt = new Date(y, m - 1, day);
                    const dayOfWeek = dt.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    let arb = 0;
                    if (d.mk && d.mg) arb += timeToMin(d.mg) - timeToMin(d.mk);
                    if (d.mittk && d.ag) arb += timeToMin(d.ag) - timeToMin(d.mittk);
                    if (arb >= 360) arb -= timeToMin(settings.pause);

                    let sollMin = 0;
                    const isFT = isFeiertag(dateStr);
                    const ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;

                    if (!isWeekend) {
                        if (isFT && ftBezahlt) {
                            feiertageBezahlt++;
                        } else if (d.tagTyp === 'urlaub') {
                            urlaubstageVerbraucht++;
                        } else if (d.tagTyp === 'krank') {
                            krankheitstageGesamt++;
                        } else if (d.tagTyp === 'kompensation') {
                            kompensationsTage++;
                            sollMin = sollProTag;
                        } else if (d.tagTyp === 'unbezahlt') {
                            unbezahlteTage++;
                        } else if (isFT && !ftBezahlt) {
                            feiertageUnbezahlt++;
                        } else {
                            sollMin = sollProTag;
                        }
                    }

                    totalArb += arb;


                    totalSoll += sollMin;
                    const diff = sollMin - arb;
                    if (arb > 0 || sollMin > 0) ueberzeitMinuten += (arb - sollMin);

                    const values = [
                        ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][dayOfWeek],
                        `${String(day).padStart(2, '0')}.${String(m).padStart(2, '0')}.${y} `,
                        d.mk || '',
                        d.mg || '',
                        d.mittk || '',
                        d.ag || '',
                        arb > 0 ? minToExcelTime(arb) : '',
                        sollMin > 0 ? minToExcelTime(sollMin) : '',
                        (arb > 0 || sollMin > 0) ? ((diff < 0 ? '+' : diff > 0 ? '-' : '') + minToTime(Math.abs(diff))) : '',
                        (ueberzeitMinuten < 0 ? '-' : '+') + minToTime(Math.abs(ueberzeitMinuten)),
                        d.notiz || ''
                    ];

                    values.forEach((value, i) => {
                        const cell = ws.getCell(currentRow, startCol + i);
                        cell.value = value;
                        cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    });

                    // Excel-Zeitformat f√ºr Arbeitszeit und Sollzeit
                    if (arb > 0) {
                        ws.getCell(currentRow, startCol + 6).numFmt = '[h]:mm';
                    }
                    if (sollMin > 0) {
                        ws.getCell(currentRow, startCol + 7).numFmt = '[h]:mm';
                    }

                    // Notiz-Formatierung: Linksb√ºndig, wrapText, schwarze Schrift
                    if (d.notiz) {
                        const notizCell = ws.getCell(currentRow, startCol + 10);
                        notizCell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
                        notizCell.font = { color: { argb: 'FF000000' } };
                    }

                    let fillColor = null;
                    if (isFT && ftBezahlt) {
                        fillColor = 'FFDBEAFE';
                    } else if (isFT && !ftBezahlt) {
                        fillColor = 'FFFED7AA';
                    } else if (d.tagTyp === 'feiertag-bezahlt') {
                        fillColor = 'FFDBEAFE';
                    } else if (d.tagTyp === 'feiertag-unbezahlt') {
                        fillColor = 'FFFED7AA';
                    } else if (d.tagTyp === 'urlaub') {
                        fillColor = 'FFD1FAE5';
                    } else if (d.tagTyp === 'krank') {
                        fillColor = 'FFFEF3C7';
                    } else if (d.tagTyp === 'unbezahlt') {
                        fillColor = 'FFFECACA';
                    } else if (d.tagTyp === 'kompensation') {
                        fillColor = 'FFC4B5FD';
                    } else if (isWeekend) {
                        fillColor = 'FFF3F4F6';
                    }

                    for (let i = 0; i < 11; i++) {
                        const cell = ws.getCell(currentRow, startCol + i);
                        if (fillColor) {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
                        }
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                            left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                            bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                            right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                        };
                    }

                    const diffCell = ws.getCell(currentRow, startCol + 8);
                    if (diff < 0) diffCell.font = { color: { argb: 'FF10B981' }, bold: false, italic: true };
                    else if (diff > 0) diffCell.font = { color: { argb: 'FFEF4444' }, bold: false, italic: true };

                    const ueberzeitCell = ws.getCell(currentRow, startCol + 9);
                    if (ueberzeitMinuten > 0) ueberzeitCell.font = { color: { argb: 'FF10B981' }, bold: false, italic: true };
                    else if (ueberzeitMinuten < 0) ueberzeitCell.font = { color: { argb: 'FFEF4444' }, bold: false, italic: true };

                    // Notiz-Formatierung: Linksb√ºndig, wrapText, schwarze Schrift (NACH allen anderen Formatierungen!)
                    if (d.notiz) {
                        const notizCell = ws.getCell(currentRow, startCol + 10);
                        notizCell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
                        notizCell.font = { color: { argb: 'FF000000' } };
                    }

                    currentRow++;
                });

                // Dicke graue Linie unter der letzten Datenzeile (Trennung zu Summen)
                for (let i = 0; i < headers.length; i++) {
                    const cell = ws.getCell(currentRow - 1, startCol + i);
                    // Bestehende Rahmen beibehalten, nur unten √§ndern
                    const existingBorder = cell.border || {};
                    cell.border = {
                        ...existingBorder,
                        bottom: { style: 'medium', color: { argb: 'FF9CA3AF' } } // Mittelgrau
                    };
                }

                const totalDiff = totalSoll - totalArb;

                const arbValues = ['', 'Arbeitszeit', '', '', '', '', minToTime(totalArb), minToTime(totalSoll),
                    (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + minToTime(Math.abs(totalDiff)),
                    minToTime(ueberzeitMinuten)
                ];
                arbValues.forEach((value, i) => {
                    const cell = ws.getCell(currentRow, startCol + i);
                    cell.value = value;
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.font = { italic: true, bold: true };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                });

                if (totalDiff < 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
                else if (totalDiff > 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };
                if (ueberzeitMinuten > 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
                else if (ueberzeitMinuten < 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };

                currentRow++;

                const indValues = ['', 'Industriezeit', '', '', '', '', (totalArb / 60).toFixed(2), (totalSoll / 60).toFixed(2),
                    (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + (Math.abs(totalDiff) / 60).toFixed(2),
                    (ueberzeitMinuten / 60).toFixed(2)
                ];
                indValues.forEach((value, i) => {
                    const cell = ws.getCell(currentRow, startCol + i);
                    cell.value = value;
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.font = { italic: true, bold: true };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                });

                if (totalDiff < 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
                else if (totalDiff > 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };
                if (ueberzeitMinuten > 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
                else if (ueberzeitMinuten < 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };

                // Legende RECHTS (mit 1 Spalte Abstand)
                const legendCol = 14;
                let legendRow = headerRow;

                ws.getCell(legendRow, legendCol).value = 'Legende:';
                ws.getCell(legendRow, legendCol).font = { bold: true, size: 11 };
                ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                legendRow++;

                const urlaubGesamt = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
                const urlaubRest = urlaubGesamt - urlaubstageVerbraucht;

                const legende = [
                    { text: 'Urlaub', color: 'FFD1FAE5', value: `${urlaubstageVerbraucht} Tage`, desc: 'Urlaub bezogen' },
                    { text: 'Krankheit', color: 'FFFEF3C7', value: `${krankheitstageGesamt} Tage`, desc: 'Krankheitstage' },
                    { text: 'Feiertag (bezahlt)', color: 'FFDBEAFE', value: `${feiertageBezahlt} Tage`, desc: 'Feiertag (bezahlt)' },
                    { text: 'Feiertag (unbezahlt)', color: 'FFFED7AA', value: `${feiertageUnbezahlt} Tage`, desc: 'Feiertag (unbezahlt)' },
                    { text: 'Unbezahlt', color: 'FFFECACA', value: `${unbezahlteTage} Tage`, desc: 'Unbezahlter Urlaub' },
                    { text: 'Kompensation', color: 'FFC4B5FD', value: `${kompensationsTage} Tage`, desc: '√úberzeit-Kompensation' }
                ];

                legende.forEach((item) => {
                    const colorCell = ws.getCell(legendRow, legendCol);
                    colorCell.value = item.value || '    ';
                    colorCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: item.color } };
                    colorCell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    colorCell.alignment = { vertical: 'middle', horizontal: 'center' };
                    if (item.value) {
                        colorCell.font = { bold: true };
                    }

                    const descCell = ws.getCell(legendRow, legendCol + 1);
                    descCell.value = item.desc;
                    descCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };

                    legendRow++;
                });

                legendRow++;

                ws.getCell(legendRow, legendCol).value = 'Urlaubs√ºbersicht:';
                ws.getCell(legendRow, legendCol).font = { bold: true, size: 11 };
                ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                legendRow++;

                ws.getCell(legendRow, legendCol).value = 'Urlaubstage im Jahr:';
                ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                ws.getCell(legendRow, legendCol + 1).value = `${urlaubGesamt} Tage`;
                ws.getCell(legendRow, legendCol + 1).font = { bold: true };
                ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'right', indent: 1 };
                legendRow++;

                ws.getCell(legendRow, legendCol).value = 'bezogene Tage:';
                ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                ws.getCell(legendRow, legendCol + 1).value = `${urlaubstageVerbraucht} Tage`;
                ws.getCell(legendRow, legendCol + 1).font = { bold: true };
                ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'right', indent: 1 };
                legendRow++;

                ws.getCell(legendRow, legendCol).value = 'verf√ºgbare Tage:';
                ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
                ws.getCell(legendRow, legendCol + 1).value = `${urlaubRest} Tage`;
                ws.getCell(legendRow, legendCol + 1).font = { bold: true };
                ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'right', indent: 1 };
                if (urlaubRest < 0) {
                    ws.getCell(legendRow, legendCol + 1).font = { color: { argb: 'FFEF4444' }, bold: true };
                }

                ws.getColumn(legendCol).width = 18;
                ws.getColumn(legendCol + 1).width = 20;

                ws.pageSetup = {
                    paperSize: 9,
                    orientation: 'landscape',
                    fitToPage: true,
                    fitToWidth: 1,
                    fitToHeight: 1,
                    margins: {
                        left: 0.25,
                        right: 0.25,
                        top: 0.25,
                        bottom: 0.25,
                        header: 0,
                        footer: 0
                    }
                };

                // Workbook-Properties setzen um Datei-Sperr-Problem zu vermeiden
                wb.creator = settings.name || 'Arbeitszeitrechner';
                wb.lastModifiedBy = settings.name || 'Arbeitszeitrechner';
                wb.created = new Date();
                wb.modified = new Date();

                // Schreibschutz deaktivieren
                wb.calcProperties = wb.calcProperties || {};
                wb.calcProperties.fullCalcOnLoad = true;

                const buffer = await wb.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `Arbeitszeiten_${getExportTitle()}.xlsx`);

                toggleExport();
            } catch (error) {
                console.error('Fehler beim Export:', error);
                alert('Fehler beim Export: ' + error.message);
            }
        }


        function exportCSV() {
            let csv = 'Datum;Morgen Kommen;Morgen Gehen;Mittag Kommen;Abend Gehen;Arbeitszeit;Sollzeit;Differenz;Feiertag\n';

            const exportDates = getExportDates();

            let totalArb = 0;
            let totalSoll = 0;
            const sollProTag = timeToMin(settings.soll);

            exportDates.forEach(dateStr => {
                const d = data[dateStr] || {};
                const [y, m, day] = dateStr.split('-').map(Number);
                const dt = new Date(y, m - 1, day);

                let arb = 0;
                if (d.mk && d.mg) arb += timeToMin(d.mg) - timeToMin(d.mk);
                if (d.mittk && d.ag) arb += timeToMin(d.ag) - timeToMin(d.mittk);
                if (arb >= 360) arb -= timeToMin(settings.pause);

                const dayOfWeek = dt.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                let sollMin = isWeekend ? 0 : sollProTag;
                let isFT = isFeiertag(dateStr);
                let ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;
                let ftText = '';

                if (isFT) {
                    const ftName = getFeiertag(dateStr);
                    ftText = ftName + (ftBezahlt ? ' (bezahlt)' : ' (unbezahlt)');
                    if (ftBezahlt && !isWeekend) {
                        sollMin = 0;
                    }
                }

                totalArb += arb;
                totalSoll += sollMin;

                const diff = sollMin - arb;

                csv += `${formatDateWithDay(dateStr)};${d.mk || ''};${d.mg || ''};${d.mittk || ''};${d.ag || ''};${minToTime(arb)};${minToTime(sollMin)};${minToTime(Math.abs(diff))} ${diff < 0 ? '√úber' : diff > 0 ? 'Fehl' : ''};${ftText} \n`;
            });

            const totalDiff = totalSoll - totalArb;
            csv += `;;; Arbeitszeit;;${minToTime(totalArb)};${minToTime(totalSoll)};${(totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '')}${minToTime(Math.abs(totalDiff))}; \n`;
            csv += `;;; Industriezeit;;${(totalArb / 60).toFixed(2)};${(totalSoll / 60).toFixed(2)};${(totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '')}${minToDecimalHours(totalDiff)}; \n`;

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `Arbeitszeiten_${getExportTitle()}.csv`);

            toggleExport();
        }

        async function exportPDF() {
            const pdfBlob = await generatePDFBlob();
            saveAs(pdfBlob, `Arbeitszeiten_${getExportTitle()}.pdf`);
            toggleExport();
        }

        async function exportBoth() {
            try {

                const zip = new JSZip();

                const fileName = `Arbeitszeiten_${getExportTitle()} `;

                const excelBlob = await generateExcelBlob();
                zip.file(`${fileName}.xlsx`, excelBlob);

                const pdfBlob = await generatePDFBlob();
                zip.file(`${fileName}.pdf`, pdfBlob);

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                saveAs(zipBlob, `${fileName}.zip`);

                toggleExport();
            } catch (error) {
                console.error('Fehler beim Erstellen der ZIP-Datei:', error);
                alert('Fehler beim Erstellen der ZIP-Datei');
            }
        }

        async function generateExcelBlob() {
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('Arbeitszeiten');

            const startRow = 2;
            const startCol = 2;

            // Zeile 2: B2 = "Arbeitszeiten" linksb√ºndig mit Einzug - VIOLETTE SCHRIFT AUF WEISS
            const titleCell = ws.getCell(2, 2);
            titleCell.value = 'Arbeitszeiten';
            titleCell.font = { bold: true, size: 16, color: { argb: 'FF6366F1' } };
            titleCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };

            ws.getRow(2).height = 30;

            // Name und Pers.Nr. in J2-K2 (Spalten 10-11 mergen), Calibri 12 Fett rechtsb√ºndig mit Einzug
            if (settings.name || settings.personalnummer) {
                ws.mergeCells(2, 10, 2, 11);
                const nameCell = ws.getCell(2, 10);
                let nameText = settings.name || '';
                if (settings.name && settings.personalnummer) nameText += '\n';
                if (settings.personalnummer) nameText += 'Personal.Nr. ' + settings.personalnummer;
                nameCell.value = nameText;
                nameCell.font = { name: 'Calibri', bold: true, size: 12, color: { argb: 'FF646464' } };
                nameCell.alignment = { vertical: 'middle', horizontal: 'right', wrapText: true, indent: 1 };
            }

            // Zeile 3: B3 = Datum linksb√ºndig mit Einzug - GRAUE SCHRIFT AUF WEISS
            let kwInfo = '';
            switch (view) {
                case 'woche':
                    const [yW2, mW2, dW2] = woche.split('-').map(Number);
                    const monday2 = new Date(yW2, mW2 - 1, dW2);
                    const sunday2 = new Date(monday2);
                    sunday2.setDate(sunday2.getDate() + 6);
                    kwInfo = `KW ${getWeekNumber(monday2)}     ${dW2}.${mW2}.- ${sunday2.getDate()}.${sunday2.getMonth() + 1}.${yW2} `;
                    break;
                case 'monat':
                    const [yM2, mM2] = month.split('-').map(Number);
                    const months2 = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                    kwInfo = `${months2[mM2 - 1]} ${yM2} `;
                    break;
                case 'jahr':
                    kwInfo = `${year} `;
                    break;
            }
            if (kwInfo) {
                const kwCell = ws.getCell(3, 2);
                kwCell.value = kwInfo;
                kwCell.font = { bold: true, size: 12, color: { argb: 'FF646464' } };
                kwCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };
                ws.getRow(3).height = 20;
            }

            const headerRow = 4;
            const headers = ['Wochentag', 'Datum', 'Morgen\nKommen', 'Morgen\nGehen', 'Mittag\nKommen', 'Abend\nGehen', 'Arbeitszeit', 'Sollzeit', 'Differenz', '√úberzeitkonto'];
            headers.forEach((header, i) => {
                const cell = ws.getCell(headerRow, startCol + i);
                cell.value = header;
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF6366F1' } };
                cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                    left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                    bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                    right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                };
            });
            ws.getRow(headerRow).height = 30;

            const widths = [12, 14, 14, 14, 14, 14, 12, 10, 12, 14];
            widths.forEach((width, i) => {
                ws.getColumn(startCol + i).width = width;
            });

            // Leere Spalte L (Spalte 12) mit Breite 20
            ws.getColumn(12).width = 20;

            const exportDates = getExportDates();
            const sollProTag = timeToMin(settings.soll);

            // Berechne Urlaubstage kumulativ vom 1.1. bis zum Ende des Export-Zeitraums
            let urlaubstageVerbraucht = 0;
            if (exportDates.length > 0) {
                const lastDateParts = exportDates[exportDates.length - 1].split('-');
                const lastMonth = parseInt(lastDateParts[1]);
                urlaubstageVerbraucht = getUrlaubBisZumMonat(lastMonth);
            }

            let totalArb = 0, totalSoll = 0;
            let ueberzeitMinuten = settings.ueberzeitStartStand || 0;
            let krankheitstageGesamt = 0;
            let unbezahlteTage = 0;
            let kompensationsTage = 0;
            let feiertageBezahlt = 0;
            let feiertageUnbezahlt = 0;
            let currentRow = headerRow + 1;

            exportDates.forEach(dateStr => {
                const d = data[dateStr] || {};
                const [y, m, day] = dateStr.split('-').map(Number);
                const dt = new Date(y, m - 1, day);
                const dayOfWeek = dt.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                let arb = 0;
                if (d.mk && d.mg) arb += timeToMin(d.mg) - timeToMin(d.mk);
                if (d.mittk && d.ag) arb += timeToMin(d.ag) - timeToMin(d.mittk);
                if (arb >= 360) arb -= timeToMin(settings.pause);

                let sollMin = 0;
                const isFT = isFeiertag(dateStr);
                const ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;

                // Sollzeit NUR f√ºr normale Arbeitstage (nicht Urlaub, Krankheit, unbezahlt)
                if (!isWeekend && !(isFT && ftBezahlt)) {
                    // Tage z√§hlen
                    if (d.tagTyp === 'urlaub') {
                        // urlaubstageVerbraucht wird kumulativ berechnet
                        // KEINE Sollzeit
                    } else if (d.tagTyp === 'krank') {
                        krankheitstageGesamt++;
                        // KEINE Sollzeit
                    } else if (d.tagTyp === 'kompensation') {
                        kompensationsTage++;
                        sollMin = sollProTag;
                        ueberzeitMinuten -= sollProTag;
                    } else if (d.tagTyp === 'unbezahlt') {
                        unbezahlteTage++;
                        // KEINE Sollzeit
                    } else {
                        // Normaler Arbeitstag
                        sollMin = sollProTag;
                    }
                }

                totalArb += arb;
                totalSoll += sollMin;
                const diff = sollMin - arb;
                if (arb > 0 || sollMin > 0) ueberzeitMinuten += (arb - sollMin);

                const values = [
                    ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][dayOfWeek],
                    `${String(day).padStart(2, '0')}.${String(m).padStart(2, '0')}.${y} `,
                    d.mk || '',
                    d.mg || '',
                    d.mittk || '',
                    d.ag || '',
                    arb > 0 ? minToTime(arb) : '',
                    sollMin > 0 ? minToTime(sollMin) : '',
                    (arb > 0 || sollMin > 0) ? ((diff < 0 ? '+' : diff > 0 ? '-' : '') + minToTime(Math.abs(diff))) : '',
                    minToTime(ueberzeitMinuten)
                ];

                values.forEach((value, i) => {
                    const cell = ws.getCell(currentRow, startCol + i);
                    cell.value = value;
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                });

                let fillColor = null;
                // Zuerst: Spezielle Tag-Typen pr√ºfen (haben h√∂chste Priorit√§t)
                if (d.tagTyp === 'urlaub') {
                    fillColor = 'FFD1FAE5';
                } else if (d.tagTyp === 'krank') {
                    fillColor = 'FFFEF3C7';
                } else if (d.tagTyp === 'unbezahlt') {
                    fillColor = 'FFFECACA';
                } else if (d.tagTyp === 'kompensation') {
                    fillColor = 'FFC4B5FD';
                } else if (d.tagTyp === 'feiertag-unbezahlt' || (isFT && !ftBezahlt)) {
                    // Unbezahlter Feiertag - Orange (Priorit√§t vor Wochenende)
                    fillColor = 'FFFED7AA';
                } else if (isFT && ftBezahlt) {
                    // Bezahlter Feiertag - Blau (Priorit√§t vor Wochenende)
                    fillColor = 'FFDBEAFE';
                } else if (isWeekend) {
                    // Wochenende - nur wenn kein Feiertag
                    fillColor = 'FFF3F4F6';
                }

                for (let i = 0; i < 10; i++) {
                    const cell = ws.getCell(currentRow, startCol + i);
                    if (fillColor) {
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
                    }
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                        right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                    };
                }

                const diffCell = ws.getCell(currentRow, startCol + 8);
                if (diff < 0) diffCell.font = { color: { argb: 'FF10B981' }, bold: true };
                else if (diff > 0) diffCell.font = { color: { argb: 'FFEF4444' }, bold: true };

                const ueberzeitCell = ws.getCell(currentRow, startCol + 9);
                if (ueberzeitMinuten > 0) ueberzeitCell.font = { color: { argb: 'FF10B981' }, bold: false, italic: true };
                else if (ueberzeitMinuten < 0) ueberzeitCell.font = { color: { argb: 'FFEF4444' }, bold: false, italic: true };

                // Notiz-Formatierung: Linksb√ºndig, wrapText, schwarze Schrift (NACH allen anderen Formatierungen!)
                if (d.notiz) {
                    const notizCell = ws.getCell(currentRow, startCol + 10);
                    notizCell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
                    notizCell.font = { color: { argb: 'FF000000' } };
                }

                currentRow++;
            });

            // Dicke graue Linie unter der letzten Datenzeile (Trennung zu Summen)
            for (let i = 0; i < headers.length; i++) {
                const cell = ws.getCell(currentRow - 1, startCol + i);
                // Bestehende Rahmen beibehalten, nur unten √§ndern
                const existingBorder = cell.border || {};
                cell.border = {
                    ...existingBorder,
                    bottom: { style: 'medium', color: { argb: 'FF9CA3AF' } } // Mittelgrau
                };
            }

            const totalDiff = totalSoll - totalArb;

            const arbValues = ['', 'Arbeitszeit', '', '', '', '', minToTime(totalArb), minToTime(totalSoll),
                (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + minToTime(Math.abs(totalDiff)),
                minToTime(ueberzeitMinuten)
            ];
            arbValues.forEach((value, i) => {
                const cell = ws.getCell(currentRow, startCol + i);
                cell.value = value;
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.font = { italic: true, bold: true };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                    left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                    bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                    right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                };
            });

            if (totalDiff < 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
            else if (totalDiff > 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };
            if (ueberzeitMinuten > 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
            else if (ueberzeitMinuten < 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };

            currentRow++;

            const indValues = ['', 'Industriezeit', '', '', '', '', (totalArb / 60).toFixed(2), (totalSoll / 60).toFixed(2),
                (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + (Math.abs(totalDiff) / 60).toFixed(2),
                (ueberzeitMinuten / 60).toFixed(2)
            ];
            indValues.forEach((value, i) => {
                const cell = ws.getCell(currentRow, startCol + i);
                cell.value = value;
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.font = { italic: true, bold: true };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                    left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                    bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                    right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                };
            });

            if (totalDiff < 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
            else if (totalDiff > 0) ws.getCell(currentRow, startCol + 8).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };
            if (ueberzeitMinuten > 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FF10B981' }, bold: true, italic: true };
            else if (ueberzeitMinuten < 0) ws.getCell(currentRow, startCol + 9).font = { color: { argb: 'FFEF4444' }, bold: true, italic: true };

            // Legende und Urlaubs√ºbersicht RECHTS neben der Tabelle platzieren
            const legendCol = 13; // Spalte M (nach leerer Spalte L)
            let legendRow = headerRow; // Startet in gleicher Zeile wie Tabellen-Header

            // Legende-Titel
            ws.getCell(legendRow, legendCol).value = 'Legende:';
            ws.getCell(legendRow, legendCol).font = { bold: true, size: 11 };
            ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
            legendRow++;

            const urlaubGesamt = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
            const urlaubRest = urlaubGesamt - urlaubstageVerbraucht;

            const legende = [
                { text: 'Urlaub', color: 'FFD1FAE5', value: `${urlaubstageVerbraucht} Tage`, desc: 'Urlaub bezogen' },
                { text: 'Krankheit', color: 'FFFEF3C7', value: `${krankheitstageGesamt} Tage`, desc: 'Krankheitstage' },
                { text: 'Feiertag (bezahlt)', color: 'FFDBEAFE', value: '', desc: 'Feiertag (bezahlt)' },
                { text: 'Feiertag (unbezahlt)', color: 'FFFED7AA', value: '', desc: 'Feiertag (unbezahlt)' }
            ];

            legende.forEach((item) => {
                const colorCell = ws.getCell(legendRow, legendCol);
                colorCell.value = item.value || '    ';
                colorCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: item.color } };
                colorCell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
                colorCell.alignment = { vertical: 'middle', horizontal: 'center' };
                // Nur "Tage"-Werte fett
                if (item.value) {
                    colorCell.font = { bold: true };
                }

                const descCell = ws.getCell(legendRow, legendCol + 1);
                descCell.value = item.desc;
                descCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };

                legendRow++;
            });

            // Leerzeile
            legendRow++;

            // Urlaubs√ºbersicht unterhalb der Legende
            ws.getCell(legendRow, legendCol).value = 'Urlaubs√ºbersicht:';
            ws.getCell(legendRow, legendCol).font = { bold: true, size: 11 };
            ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
            legendRow++;

            ws.getCell(legendRow, legendCol).value = 'Urlaubstage im Jahr:';
            ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
            ws.getCell(legendRow, legendCol + 1).value = `${urlaubGesamt} Tage`;
            ws.getCell(legendRow, legendCol + 1).font = { bold: true };
            ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'left', indent: 1 };
            legendRow++;

            ws.getCell(legendRow, legendCol).value = 'bezogene Tage:';
            ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
            ws.getCell(legendRow, legendCol + 1).value = `${urlaubstageVerbraucht} Tage`;
            ws.getCell(legendRow, legendCol + 1).font = { bold: true };
            ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'left', indent: 1 };
            legendRow++;

            ws.getCell(legendRow, legendCol).value = 'verf√ºgbare Tage:';
            ws.getCell(legendRow, legendCol).alignment = { horizontal: 'left' };
            ws.getCell(legendRow, legendCol + 1).value = `${urlaubRest} Tage`;
            ws.getCell(legendRow, legendCol + 1).font = { bold: true };
            ws.getCell(legendRow, legendCol + 1).alignment = { horizontal: 'left', indent: 1 };
            if (urlaubRest < 0) {
                ws.getCell(legendRow, legendCol + 1).font = { color: { argb: 'FFEF4444' }, bold: true };
            }

            // Spaltenbreiten f√ºr Legende anpassen
            ws.getColumn(legendCol).width = 18;
            ws.getColumn(legendCol + 1).width = 20;

            // Druckbereich festlegen: Von B bis M (Spalte 2 bis 13)
            ws.pageSetup = {
                paperSize: 9, // A4
                orientation: 'landscape',
                fitToPage: true,
                fitToWidth: 1,
                fitToHeight: 1,
                margins: {
                    left: 0.25,
                    right: 0.25,
                    top: 0.25,
                    bottom: 0.25,
                    header: 0,
                    footer: 0
                }
            };

            const buffer = await wb.xlsx.writeBuffer();
            return new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        }
        function generatePDFByMonth(resolve) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            const sollProTag = timeToMin(settings.soll);
            let isFirstPage = true;

            // √úberzeitkonto EINMAL initialisieren und √ºber alle Monate fortf√ºhren
            let ueberzeitMinutenGesamt = settings.ueberzeitStartStand || 0;

            for (let monthNum = 1; monthNum <= 12; monthNum++) {
                if (!isFirstPage) {
                    doc.addPage();
                }
                isFirstPage = false;

                // Titel
                doc.setFontSize(16);
                doc.setTextColor(99, 102, 241);
                doc.text('Arbeitszeiten', 20, 12, { align: 'left' });

                // Monat und Jahr
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`${months[monthNum - 1]} ${year} `, 20, 18, { align: 'left' });

                // Name und Personalnummer √úBER der Tabelle, rechtsb√ºndig am Ende der √úberzeitkonto-Spalte
                if (settings.name || settings.personalnummer) {
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    let yPos = 12;
                    // √úberzeitkonto-Spalte: Start bei 20 + 130mm = 150mm, Ende bei 150 + 18 = 168mm
                    const rightAlign = 168;
                    if (settings.name) {
                        doc.text(settings.name, rightAlign, yPos, { align: 'right' });
                        yPos += 4;
                    }
                    if (settings.personalnummer) {
                        doc.text('Personal.Nr. ' + settings.personalnummer, rightAlign, yPos, { align: 'right' });
                    }
                }

                doc.setTextColor(0, 0, 0);

                // Tabellendata f√ºr diesen Monat
                const tableData = [];
                let totalArb = 0, totalSoll = 0;
                let urlaubstageVerbraucht = getUrlaubBisZumMonat(monthNum);
                let krankheitstageGesamt = 0;
                let unbezahlteTage = 0;
                let kompensationsTage = 0;
                let feiertageBezahlt = 0;
                let feiertageUnbezahlt = 0;

                // Alle Daten des Monats sammeln
                const exportDates = getExportDates();
                exportDates.forEach(dateStr => {
                    const [y, m, day] = dateStr.split('-').map(Number);

                    // Nur Daten f√ºr diesen Monat
                    if (m !== monthNum || y !== parseInt(year)) return;

                    const d = data[dateStr] || {};
                    const dt = new Date(y, m - 1, day);
                    const dayOfWeek = dt.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    let arb = 0;
                    if (d.mk && d.mg) arb += timeToMin(d.mg) - timeToMin(d.mk);
                    if (d.mittk && d.ag) arb += timeToMin(d.ag) - timeToMin(d.mittk);
                    if (arb >= 360) arb -= timeToMin(settings.pause);

                    let sollMin = 0;
                    const isFT = isFeiertag(dateStr);
                    const ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;

                    let fillColor = null;

                    // Zuerst: Spezielle Tag-Typen pr√ºfen (haben h√∂chste Priorit√§t)
                    if (d.tagTyp === 'urlaub') {
                        fillColor = [209, 250, 229];
                    } else if (d.tagTyp === 'krank') {
                        fillColor = [254, 243, 199];
                        krankheitstageGesamt++;
                    } else if (d.tagTyp === 'unbezahlt') {
                        fillColor = [254, 202, 202];
                        unbezahlteTage++;
                    } else if (d.tagTyp === 'kompensation') {
                        fillColor = [196, 181, 253];
                        kompensationsTage++;
                        sollMin = sollProTag;
                        ueberzeitMinutenGesamt -= sollProTag;
                    } else if (d.tagTyp === 'feiertag-unbezahlt' || (isFT && !ftBezahlt)) {
                        // Unbezahlter Feiertag - Orange (Priorit√§t vor Wochenende)
                        fillColor = [254, 215, 170];
                        feiertageUnbezahlt++;
                    } else if (isFT && ftBezahlt) {
                        // Bezahlter Feiertag - Blau (Priorit√§t vor Wochenende)
                        fillColor = [219, 234, 254];
                        feiertageBezahlt++;
                    } else if (isWeekend) {
                        // Wochenende - nur wenn kein Feiertag
                        fillColor = [243, 244, 246];
                    }

                    // Sollzeit nur f√ºr normale Arbeitstage
                    if (!isWeekend && !(isFT && ftBezahlt) && !d.tagTyp && d.tagTyp !== 'urlaub' && d.tagTyp !== 'krank' && d.tagTyp !== 'unbezahlt') {
                        sollMin = sollProTag;
                    }

                    totalArb += arb;
                    totalSoll += sollMin;
                    const diff = sollMin - arb;
                    if (arb > 0 || sollMin > 0) ueberzeitMinutenGesamt += (arb - sollMin);

                    const rowData = [
                        ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][dayOfWeek],
                        `${String(day).padStart(2, '0')}.${String(m).padStart(2, '0')}.${y} `,
                        d.mk || '',
                        d.mg || '',
                        d.mittk || '',
                        d.ag || '',
                        arb > 0 ? minToTime(arb) : '',
                        sollMin > 0 ? minToTime(sollMin) : '',
                        {
                            content: (arb > 0 || sollMin > 0) ? ((diff < 0 ? '+' : diff > 0 ? '-' : '') + minToTime(Math.abs(diff))) : '',
                            styles: {
                                textColor: diff < 0 ? [16, 185, 129] : diff > 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: minToTime(ueberzeitMinutenGesamt),
                            styles: {
                                textColor: ueberzeitMinutenGesamt > 0 ? [16, 185, 129] : ueberzeitMinutenGesamt < 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        }
                    ];

                    tableData.push({
                        data: rowData,
                        fillColor: fillColor
                    });
                });

                // Tabelle erstellen
                doc.autoTable({
                    startY: 24,
                    head: [['Wochentag', 'Datum', 'Morgen\nKommen', 'Morgen\nGehen', 'Mittag\nKommen', 'Abend\nGehen', 'Arbeitszeit', 'Sollzeit', 'Differenz', '√úberzeitkonto']],
                    body: tableData.map(row => row.data),
                    theme: 'grid',
                    tableWidth: 165,
                    margin: { left: 20, right: 115 },
                    pageBreak: 'avoid',
                    styles: {
                        fontSize: 6,
                        cellPadding: 0.8,
                        halign: 'center',
                        valign: 'middle',
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [99, 102, 241],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        halign: 'center',
                        valign: 'middle',
                        fontSize: 6,
                        cellPadding: 0.8
                    },
                    columnStyles: {
                        0: { cellWidth: 17 },
                        1: { cellWidth: 18 },
                        2: { cellWidth: 13 },
                        3: { cellWidth: 13 },
                        4: { cellWidth: 13 },
                        5: { cellWidth: 13 },
                        6: { cellWidth: 15 },
                        7: { cellWidth: 13 },
                        8: { cellWidth: 15 },
                        9: { cellWidth: 18 }
                    },
                    didParseCell: function (data) {
                        if (data.section === 'body' && tableData[data.row.index] && tableData[data.row.index].fillColor) {
                            data.cell.styles.fillColor = tableData[data.row.index].fillColor;
                        }
                    }
                });

                // Legende RECHTS neben der Tabelle (wie in normaler PDF-Ausgabe)
                const legendX = 195;
                const legendStartY = 24 + 3;

                const legende = [
                    { text: `${urlaubstageVerbraucht} Tage`, desc: 'Urlaub bezogen', color: [209, 250, 229], show: true },
                    { text: `${krankheitstageGesamt} Tage`, desc: 'Krankheitstage', color: [254, 243, 199], show: true },
                    { text: `${unbezahlteTage} Tage`, desc: 'Unbezahlter Urlaub', color: [254, 202, 202], show: true },
                    { text: `${kompensationsTage} Tage`, desc: '√úberzeit-Kompensation', color: [196, 181, 253], show: true },
                    { text: `${feiertageBezahlt} Tage`, desc: 'Feiertag (bezahlt)', color: [219, 234, 254], show: true },
                    { text: `${feiertageUnbezahlt} Tage`, desc: 'Feiertag (unbezahlt)', color: [254, 215, 170], show: true }
                ].filter(item => item.show);

                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('Legende:', legendX, legendStartY);

                let yPos = legendStartY + 7;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);

                legende.forEach((item) => {
                    doc.setFillColor(...item.color);
                    doc.rect(legendX, yPos - 2.5, 8, 3, 'F');
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(legendX, yPos - 2.5, 8, 3, 'S');

                    if (item.text) {
                        doc.setFontSize(6);
                        doc.setFont(undefined, 'bold');
                        doc.text(item.text, legendX + 4, yPos, { align: 'center' });
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(7);
                    }

                    doc.text(item.desc, legendX + 10, yPos);
                    yPos += 4;
                });

                // Urlaubs√ºbersicht
                yPos += 2;
                const urlaubGesamt = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
                const urlaubRest = urlaubGesamt - urlaubstageVerbraucht;

                doc.setFont(undefined, 'bold');
                doc.setFontSize(8);
                doc.text('Urlaubs√ºbersicht:', legendX, yPos);
                yPos += 4;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);

                doc.text(`Urlaubstage im Jahr: ${urlaubGesamt} `, legendX, yPos);
                yPos += 4;

                doc.text(`bezogene Tage: ${urlaubstageVerbraucht} `, legendX, yPos);
                yPos += 4;

                doc.text(`verf√ºgbare Tage: ${urlaubRest} `, legendX, yPos);

                const finalY = doc.lastAutoTable.finalY || 30;
                const totalDiff = totalSoll - totalArb;

                // Summen-Zeile
                const summaryData = [
                    [
                        '',
                        'Arbeitszeit',
                        '',
                        '',
                        '',
                        '',
                        minToTime(totalArb),
                        minToTime(totalSoll),
                        {
                            content: (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + minToTime(Math.abs(totalDiff)),
                            styles: {
                                textColor: totalDiff < 0 ? [16, 185, 129] : totalDiff > 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: minToTime(ueberzeitMinutenGesamt),
                            styles: {
                                textColor: ueberzeitMinutenGesamt > 0 ? [16, 185, 129] : ueberzeitMinutenGesamt < 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        }
                    ],
                    [
                        '',
                        'Industriezeit',
                        '',
                        '',
                        '',
                        '',
                        (totalArb / 60).toFixed(2),
                        (totalSoll / 60).toFixed(2),
                        {
                            content: (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + minToDecimalHours(totalDiff),
                            styles: {
                                textColor: totalDiff < 0 ? [16, 185, 129] : totalDiff > 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: (ueberzeitMinutenGesamt / 60).toFixed(2),
                            styles: {
                                textColor: ueberzeitMinutenGesamt > 0 ? [16, 185, 129] : ueberzeitMinutenGesamt < 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        }
                    ]
                ];

                doc.autoTable({
                    startY: finalY,
                    body: summaryData,
                    theme: 'plain',
                    tableWidth: 165,
                    margin: { left: 20, right: 115 },
                    styles: {
                        fontSize: 6,
                        cellPadding: 0.8,
                        halign: 'center',
                        valign: 'middle',
                        fontStyle: 'italic'
                    },
                    columnStyles: {
                        0: { cellWidth: 17 },
                        1: { cellWidth: 18, halign: 'left' },
                        2: { cellWidth: 13 },
                        3: { cellWidth: 13 },
                        4: { cellWidth: 13 },
                        5: { cellWidth: 13 },
                        6: { cellWidth: 15, },
                        7: { cellWidth: 13, },
                        8: { cellWidth: 15, },
                        9: { cellWidth: 18, }
                    }
                });

                // Footer
                const pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                const footerY = pageHeight - 10;
                doc.text(`Seite ${monthNum} von 12`, 20, footerY);
                doc.text(`Erstellt am ${new Date().toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' })} `, 148, footerY, { align: 'center' });
            }

            const pdfBlob = doc.output('blob');
            resolve(pdfBlob);
        }

        function generatePDFBlob() {
            return new Promise((resolve) => {
                const { jsPDF } = window.jspdf;

                // Spezielle Behandlung f√ºr Jahresansicht
                if (view === 'jahr') {
                    generatePDFByMonth(resolve);
                    return;
                }

                const doc = new jsPDF('l', 'mm', 'a4');

                doc.setFontSize(16);
                doc.setTextColor(99, 102, 241);
                doc.text('Arbeitszeiten', 20, 12, { align: 'left' });

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                let subtitle = '';
                switch (view) {
                    case 'tag':
                        const [y, m, d] = date.split('-').map(Number);
                        subtitle = `${d}.${m}.${y} `;
                        break;
                    case 'woche':
                        const [yW, mW, dW] = woche.split('-').map(Number);
                        const monday = new Date(yW, mW - 1, dW);
                        const sunday = new Date(monday);
                        sunday.setDate(sunday.getDate() + 6);
                        subtitle = `KW ${getWeekNumber(monday)}     ${dW}.${mW}.- ${sunday.getDate()}.${sunday.getMonth() + 1}.${yW} `;
                        break;
                    case 'monat':
                        const [yM, mM] = month.split('-').map(Number);
                        const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                        subtitle = `${months[mM - 1]} ${yM} `;
                        break;
                    case 'jahr':
                        subtitle = `${year} `;
                        break;
                }
                doc.text(subtitle, 20, 18, { align: 'left' });

                // Name und Personalnummer √úBER der Tabelle, rechtsb√ºndig am Ende der √úberzeitkonto-Spalte
                if (settings.name || settings.personalnummer) {
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    let yPos = 12;
                    // √úberzeitkonto-Spalte: Start bei 20 + 130mm = 150mm, Ende bei 150 + 18 = 168mm
                    const rightAlign = 168;
                    if (settings.name) {
                        doc.text(settings.name, rightAlign, yPos, { align: 'right' });
                        yPos += 4;
                    }
                    if (settings.personalnummer) {
                        doc.text('Personal.Nr. ' + settings.personalnummer, rightAlign, yPos, { align: 'right' });
                    }
                }

                doc.setTextColor(0, 0, 0);

                const tableData = [];
                const exportDates = getExportDates();
                const sollProTag = timeToMin(settings.soll);

                // Berechne Urlaubstage kumulativ vom 1.1. bis zum Ende des Export-Zeitraums
                let urlaubstageVerbraucht = 0;
                if (exportDates.length > 0) {
                    const lastDateParts = exportDates[exportDates.length - 1].split('-');
                    const lastMonth = parseInt(lastDateParts[1]);
                    urlaubstageVerbraucht = getUrlaubBisZumMonat(lastMonth);
                }

                let totalArb = 0, totalSoll = 0;
                let ueberzeitMinuten = settings.ueberzeitStartStand || 0;
                let krankheitstageGesamt = 0;
                let unbezahlteTage = 0;
                let kompensationsTage = 0;
                let feiertageBezahlt = 0;
                let feiertageUnbezahlt = 0;

                exportDates.forEach(dateStr => {
                    const d = data[dateStr] || {};
                    const [y, m, day] = dateStr.split('-').map(Number);
                    const dt = new Date(y, m - 1, day);
                    const dayOfWeek = dt.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    let arb = 0;
                    if (d.mk && d.mg) arb += timeToMin(d.mg) - timeToMin(d.mk);
                    if (d.mittk && d.ag) arb += timeToMin(d.ag) - timeToMin(d.mittk);
                    if (arb >= 360) arb -= timeToMin(settings.pause);

                    let sollMin = 0;
                    const isFT = isFeiertag(dateStr);
                    const ftBezahlt = isFT ? isFeiertagBezahlt(dateStr) : false;

                    let fillColor = null;
                    // Zuerst: Spezielle Tag-Typen pr√ºfen (haben h√∂chste Priorit√§t)
                    if (d.tagTyp === 'urlaub') {
                        fillColor = [209, 250, 229];
                    } else if (d.tagTyp === 'krank') {
                        fillColor = [254, 243, 199];
                        krankheitstageGesamt++;
                    } else if (d.tagTyp === 'unbezahlt') {
                        fillColor = [254, 202, 202];
                        unbezahlteTage++;
                    } else if (d.tagTyp === 'kompensation') {
                        fillColor = [196, 181, 253];
                        kompensationsTage++;
                        sollMin = sollProTag;
                    } else if (d.tagTyp === 'feiertag-unbezahlt' || (isFT && !ftBezahlt)) {
                        fillColor = [254, 215, 170];
                        feiertageUnbezahlt++;
                    } else if (isFT && ftBezahlt) {
                        fillColor = [219, 234, 254];
                        feiertageBezahlt++;
                    } else if (isWeekend) {
                        fillColor = [243, 244, 246];
                    } else if (!isWeekend && !(isFT && ftBezahlt)) {
                        sollMin = sollProTag;
                    }

                    totalArb += arb;
                    totalSoll += sollMin;
                    const diff = sollMin - arb;
                    if (arb > 0 || sollMin > 0) ueberzeitMinuten += (arb - sollMin);

                    const rowData = [
                        ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][dayOfWeek],
                        `${String(day).padStart(2, '0')}.${String(m).padStart(2, '0')}.${y} `,
                        d.mk || '',
                        d.mg || '',
                        d.mittk || '',
                        d.ag || '',
                        arb > 0 ? minToTime(arb) : '',
                        sollMin > 0 ? minToTime(sollMin) : '',
                        {
                            content: (arb > 0 || sollMin > 0) ? ((diff < 0 ? '+' : diff > 0 ? '-' : '') + minToTime(Math.abs(diff))) : '',
                            styles: {
                                textColor: diff < 0 ? [16, 185, 129] : diff > 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: minToTime(ueberzeitMinuten),
                            styles: {
                                textColor: ueberzeitMinuten > 0 ? [16, 185, 129] : ueberzeitMinuten < 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        }
                    ];

                    tableData.push({
                        data: rowData,
                        fillColor: fillColor
                    });
                });

                doc.autoTable({
                    startY: 24,
                    head: [['Wochentag', 'Datum', 'Morgen\nKommen', 'Morgen\nGehen', 'Mittag\nKommen', 'Abend\nGehen', 'Arbeitszeit', 'Sollzeit', 'Differenz', '√úberzeitkonto']],
                    body: tableData.map(row => row.data),
                    theme: 'grid',
                    tableWidth: 165,
                    margin: { left: 20, right: 115 },
                    styles: {
                        fontSize: 6.5,
                        cellPadding: 1.2,
                        halign: 'center',
                        valign: 'top',
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [99, 102, 241],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        halign: 'center',
                        valign: 'top',
                        fontSize: 6.5,
                        valign: 'middle'
                    },
                    columnStyles: {
                        0: { cellWidth: 17 },
                        1: { cellWidth: 18 },
                        2: { cellWidth: 13 },
                        3: { cellWidth: 13 },
                        4: { cellWidth: 13 },
                        5: { cellWidth: 13 },
                        6: { cellWidth: 15 },
                        7: { cellWidth: 13 },
                        8: { cellWidth: 15 },
                        9: { cellWidth: 18 }
                    },
                    didParseCell: function (data) {
                        if (data.section === 'body' && tableData[data.row.index].fillColor) {
                            data.cell.styles.fillColor = tableData[data.row.index].fillColor;
                        }
                    }
                });

                const finalY = doc.lastAutoTable.finalY || 30;
                const totalDiff = totalSoll - totalArb;

                const summaryData = [
                    [
                        '',
                        'Arbeitszeit',
                        '',
                        '',
                        '',
                        '',
                        minToTime(totalArb),
                        minToTime(totalSoll),
                        {
                            content: (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + minToTime(Math.abs(totalDiff)),
                            styles: {
                                textColor: totalDiff < 0 ? [16, 185, 129] : totalDiff > 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: minToTime(ueberzeitMinuten),
                            styles: {
                                textColor: ueberzeitMinuten > 0 ? [16, 185, 129] : ueberzeitMinuten < 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        }
                    ],
                    [
                        '',
                        'Industriezeit',
                        '',
                        '',
                        '',
                        '',
                        (totalArb / 60).toFixed(2),
                        (totalSoll / 60).toFixed(2),
                        {
                            content: (totalDiff < 0 ? '+' : totalDiff > 0 ? '-' : '') + minToDecimalHours(totalDiff),
                            styles: {
                                textColor: totalDiff < 0 ? [16, 185, 129] : totalDiff > 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: (ueberzeitMinuten / 60).toFixed(2),
                            styles: {
                                textColor: ueberzeitMinuten > 0 ? [16, 185, 129] : ueberzeitMinuten < 0 ? [239, 68, 68] : [0, 0, 0],
                                fontStyle: 'bold'
                            }
                        }
                    ]
                ];

                doc.autoTable({
                    startY: finalY,
                    body: summaryData,
                    theme: 'plain',
                    tableWidth: 165,
                    margin: { left: 20, right: 115 },
                    styles: {
                        fontSize: 6.5,
                        cellPadding: 1.2,
                        halign: 'center',
                        valign: 'top',
                        fontStyle: 'italic'
                    },
                    columnStyles: {
                        0: { cellWidth: 17 },
                        1: { cellWidth: 18, halign: 'left' },
                        2: { cellWidth: 13 },
                        3: { cellWidth: 13 },
                        4: { cellWidth: 13 },
                        5: { cellWidth: 13 },
                        6: { cellWidth: 15, },
                        7: { cellWidth: 13, },
                        8: { cellWidth: 15, },
                        9: { cellWidth: 18, }
                    }
                });

                // Legende und Urlaubs√ºbersicht RECHTS neben der Tabelle
                const legendX = 195;

                // Berechne die Gesamth√∂he f√ºr Legende und Urlaubs√ºbersicht
                const legende = [
                    { text: `${urlaubstageVerbraucht} Tage`, desc: 'Urlaub bezogen', color: [209, 250, 229], show: true },
                    { text: `${krankheitstageGesamt} Tage`, desc: 'Krankheitstage', color: [254, 243, 199], show: true },
                    { text: `${unbezahlteTage} Tage`, desc: 'Unbezahlter Urlaub', color: [254, 202, 202], show: true },
                    { text: `${kompensationsTage} Tage`, desc: '√úberzeit-Kompensation', color: [196, 181, 253], show: true },
                    { text: `${feiertageBezahlt} Tage`, desc: 'Feiertag (bezahlt)', color: [219, 234, 254], show: true },
                    { text: `${feiertageUnbezahlt} Tage`, desc: 'Feiertag (unbezahlt)', color: [254, 215, 170], show: true }
                ].filter(item => item.show);

                // Legende-√úberschrift auf gleicher H√∂he wie Tabellen-Header
                let legendStartY = 24 + 3;

                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('Legende:', legendX, legendStartY);

                // Abstand nach √úberschrift f√ºr Ausrichtung mit Datenzeilen
                let yPos = legendStartY + 7;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);

                legende.forEach((item) => {
                    // Farbbox
                    doc.setFillColor(...item.color);
                    doc.rect(legendX, yPos - 2.5, 8, 3, 'F');
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(legendX, yPos - 2.5, 8, 3, 'S');

                    // Text in Box (nur wenn vorhanden)
                    if (item.text) {
                        doc.setFontSize(6);
                        doc.setFont(undefined, 'bold');
                        doc.text(item.text, legendX + 4, yPos, { align: 'center' });
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(7);
                    }

                    // Beschreibung
                    doc.text(item.desc, legendX + 10, yPos);
                    yPos += 4;
                });

                // Urlaubs√ºbersicht darunter
                yPos += 2;
                const urlaubGesamt = (settings.urlaubTage || 25) + (settings.resturlaubVorjahr || 0);
                const urlaubRest = urlaubGesamt - urlaubstageVerbraucht;

                doc.setFont(undefined, 'bold');
                doc.setFontSize(8);
                doc.text('Urlaubs√ºbersicht:', legendX, yPos);
                yPos += 4;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);

                // Zeile 1: Urlaubstage im Jahr - alles normal, Zahl direkt nach Doppelpunkt
                doc.text(`Urlaubstage im Jahr: ${urlaubGesamt} `, legendX, yPos);
                yPos += 4;

                // Zeile 2: bezogene Tage (Text normal)
                doc.text(`bezogene Tage: ${urlaubstageVerbraucht} `, legendX, yPos);
                yPos += 4;

                // Zeile 3: verf√ºgbare Tage (Text normal)
                doc.text(`verf√ºgbare Tage: ${urlaubRest} `, legendX, yPos);
                yPos += 4;

                const pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                const footerY = pageHeight - 10;
                doc.text(`Seite 1 von 1`, 20, footerY);
                doc.text(`Erstellt am ${new Date().toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' })} `, 148, footerY, { align: 'center' });

                const pdfBlob = doc.output('blob');
                resolve(pdfBlob);
            });
        }

        function downloadHTML() {
            const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
            saveAs(blob, `Arbeitszeitrechner_${new Date().toISOString().split('T')[0]}.html`);
            toggleExport();
        }

        function importData() {
            document.getElementById('import-file').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                if (file.name.endsWith('.csv')) {
                    importCSV(e.target.result);
                } else if (file.name.endsWith('.xlsx')) {
                    importExcel(e.target.result);
                }
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }

            toggleExport();
        }

        function importCSV(csvText) {
            const lines = csvText.split('\n').slice(1);
            let imported = 0;

            lines.forEach(line => {
                if (!line.trim()) return;
                const parts = line.split(';');
                if (parts.length < 6) return;

                const [datumStr, , mk, mg, mittk, ag] = parts;
                const [day, m, y] = datumStr.split('.').map(Number);
                const dateStr = `${y} -${String(m).padStart(2, '0')} -${String(day).padStart(2, '0')} `;

                if (mk || mg || mittk || ag) {
                    data[dateStr] = { mk, mg, mittk, ag };
                    imported++;
                }
            });

            saveToStorage();
            alert(`‚úì ${imported} Arbeitszeiteintr√§ge aus CSV importiert!\n\nHinweis: Es wurden nur Arbeitszeiten importiert.\nF√ºr einen vollst√§ndigen Import nutzen Sie "Voll-Backup einlesen".`);
            loadTag();
        }

        function importExcel(buffer) {
            const wb = new ExcelJS.Workbook();
            wb.xlsx.load(buffer).then(workbook => {
                const ws = workbook.getWorksheet(1);
                let imported = 0;

                ws.eachRow((row, rowNum) => {
                    if (rowNum === 1) return;

                    const datumStr = row.getCell(1).value;
                    if (!datumStr) return;

                    const [day, m, y] = String(datumStr).split('.').map(Number);
                    const dateStr = `${y} -${String(m).padStart(2, '0')} -${String(day).padStart(2, '0')} `;

                    const mk = row.getCell(3).value || '';
                    const mg = row.getCell(4).value || '';
                    const mittk = row.getCell(5).value || '';
                    const ag = row.getCell(6).value || '';

                    if (mk || mg || mittk || ag) {
                        data[dateStr] = { mk, mg, mittk, ag };
                        imported++;
                    }
                });

                saveToStorage();
                alert(`‚úì ${imported} Arbeitszeiteintr√§ge aus Excel importiert!\n\nHinweis: Es wurden nur Arbeitszeiten importiert.\nF√ºr einen vollst√§ndigen Import nutzen Sie "Voll-Backup einlesen".`);
                loadTag();
            });
        }

        function importFeiertage() {
            document.getElementById('feiertag-file').click();
        }

        function handleFeiertagImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);

                    if (!jsonData.feiertage || !Array.isArray(jsonData.feiertage)) {
                        alert('Ung√ºltige JSON-Datei. Bitte √ºberpr√ºfe das Format.');
                        return;
                    }

                    const kanton = settings.kanton;

                    let newFeiertage = {};
                    jsonData.feiertage.forEach(f => {
                        let shouldAdd = false;

                        if (f.kantone && f.kantone.length > 0) {

                            if (f.kantone.includes('ALL')) {
                                shouldAdd = true;
                            }

                            else if (kanton && f.kantone.includes(kanton)) {
                                shouldAdd = true;
                            }

                            else if (!kanton && f.kantone.includes('ALL')) {
                                shouldAdd = true;
                            }
                        }

                        if (shouldAdd) {
                            newFeiertage[f.datum] = {
                                name: f.name,
                                bezahlt: f.bezahlt !== undefined ? f.bezahlt : true,
                                typ: f.typ || 'feiertag'
                            };
                        }
                    });

                    Object.assign(feiertage, newFeiertage);
                    saveToStorage();

                    alert(`‚úì ${Object.keys(newFeiertage).length} Feiertage f√ºr ${jsonData.jahr || 'Jahr'} importiert!`);
                    renderEinstellungen();

                    if (view === 'monat') renderMonat();
                    if (view === 'jahr') renderJahr();

                } catch (e) {
                    alert('Fehler beim Importieren der Feiertage: ' + e.message);
                }

                event.target.value = '';
            };

            reader.readAsText(file);
        }

        let currentEditingDatum = null;

        function showAddFeiertagDialog() {
            document.getElementById('modal-title').textContent = 'Feiertag hinzuf√ºgen';
            document.getElementById('modal-datum').value = '';
            document.getElementById('modal-name').value = '';
            document.getElementById('modal-typ').value = 'feiertag';
            document.getElementById('modal-bezahlt').checked = true;
            currentEditingDatum = null;
            document.getElementById('feiertag-modal').classList.remove('hidden');
        }

        function editFeiertag(datum) {
            const ft = feiertage[datum];
            if (!ft) return;

            document.getElementById('modal-title').textContent = 'Feiertag bearbeiten';
            document.getElementById('modal-datum').value = datum;
            document.getElementById('modal-name').value = ft.name || ft;
            document.getElementById('modal-typ').value = ft.typ || 'feiertag';
            document.getElementById('modal-bezahlt').checked = ft.bezahlt !== undefined ? ft.bezahlt : true;
            currentEditingDatum = datum;
            document.getElementById('feiertag-modal').classList.remove('hidden');
        }

        function deleteFeiertag(datum) {
            const ft = feiertage[datum];
            const name = ft ? (ft.name || ft) : 'dieser Feiertag';

            if (confirm(`M√∂chtest du "${name}" wirklich l√∂schen ? `)) {
                delete feiertage[datum];
                saveToStorage();
                renderEinstellungen();

                if (view === 'monat') renderMonat();
                if (view === 'jahr') renderJahr();
            }
        }

        function closeFeiertagModal() {
            document.getElementById('feiertag-modal').classList.add('hidden');
            currentEditingDatum = null;
        }

        function saveFeiertagFromModal() {
            const datum = document.getElementById('modal-datum').value;
            const name = document.getElementById('modal-name').value.trim();
            const typ = document.getElementById('modal-typ').value;
            const bezahlt = document.getElementById('modal-bezahlt').checked;

            if (!datum || !name) {
                alert('Bitte Datum und Name eingeben!');
                return;
            }

            if (currentEditingDatum && currentEditingDatum !== datum) {
                delete feiertage[currentEditingDatum];
            }

            feiertage[datum] = {
                name: name,
                bezahlt: bezahlt,
                typ: typ
            };

            saveToStorage();
            closeFeiertagModal();
            renderEinstellungen();

            if (view === 'monat') renderMonat();
            if (view === 'jahr') renderJahr();
        }

        // ========================================
        // VOLLST√ÑNDIGES BACKUP SYSTEM
        // ========================================

        function exportVollbackup() {
            // Erstelle vollst√§ndiges Backup-Objekt mit ALLEN Daten
            const backup = {
                version: '1.0',
                exportDatum: new Date().toISOString(),
                arbeitszeitData: data,
                feiertage: feiertage,
                settings: settings,
                sollModus: sollModus,
                darkMode: document.body.classList.contains('dark')
            };

            // Erstelle JSON-String mit sch√∂ner Formatierung
            const jsonString = JSON.stringify(backup, null, 2);

            // Erstelle Blob und Download
            const blob = new Blob([jsonString], { type: 'application/json' });
            const datumStr = new Date().toISOString().split('T')[0];
            const filename = `Arbeitszeit_Vollbackup_${datumStr}.json`;

            saveAs(blob, filename);
            toggleExport();

            // Zeige styled Notification Banner
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
                color: white;
                padding: 1.5rem 2rem;
                border-radius: 0.75rem;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                max-width: 500px;
                text-align: center;
                animation: slideDown 0.3s ease-out;
            `;
            banner.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                <div style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.75rem;">Vollst√§ndiges Backup erstellt!</div>
                <div style="font-size: 0.875rem; opacity: 0.95; line-height: 1.6;">
                    Das Backup enth√§lt:<br>
                    ‚Ä¢ Alle Arbeitszeiten<br>
                    ‚Ä¢ Alle Einstellungen<br>
                    ‚Ä¢ Alle Urlaubstage<br>
                    ‚Ä¢ Alle Feiertage<br>
                    ‚Ä¢ √úberstunden-Stand<br>
                    ‚Ä¢ Personaldaten
                </div>
            `;

            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from {
                        opacity: 0;
                        transform: translateX(-50%) translateY(-20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(-50%) translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(banner);

            // Banner nach 5 Sekunden ausblenden
            setTimeout(() => {
                banner.style.transition = 'opacity 0.5s ease-out';
                banner.style.opacity = '0';
                setTimeout(() => banner.remove(), 500);
            }, 5000);
        }

        function importVollbackup() {
            // Zeige Custom Confirmation Dialog
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 0.75rem;
                padding: 2rem;
                max-width: 500px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            `;
            if (document.body.classList.contains('dark')) {
                dialog.style.background = '#1F2937';
                dialog.style.color = 'white';
            }

            dialog.innerHTML = `
                <div style="font-size: 2rem; text-align: center; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                <div style="font-size: 1.25rem; font-weight: 700; text-align: center; margin-bottom: 1rem;">ACHTUNG: Vollst√§ndiges Backup wiederherstellen?</div>
                <div style="font-size: 0.95rem; text-align: center; margin-bottom: 1.5rem; opacity: 0.8;">
                    Alle aktuellen Daten werden durch die Backup-Daten ersetzt!<br><br>
                    M√∂chten Sie fortfahren?
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="backup-cancel" style="flex: 1; padding: 0.75rem; border: none; border-radius: 0.5rem; font-size: 1rem; cursor: pointer; background: #6B7280; color: white;">Abbrechen</button>
                    <button id="backup-confirm" style="flex: 1; padding: 0.75rem; border: none; border-radius: 0.5rem; font-size: 1rem; cursor: pointer; background: #EF4444; color: white; font-weight: 600;">Fortfahren</button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            document.getElementById('backup-cancel').onclick = () => {
                overlay.remove();
            };

            document.getElementById('backup-confirm').onclick = () => {
                overlay.remove();
                document.getElementById('backup-file').click();
            };
        }

        function handleBackupImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Validiere Backup-Struktur
                    if (!backup.version || !backup.arbeitszeitData) {
                        showNotification('‚ùå Ung√ºltige Backup-Datei!', 'Die Datei ist keine g√ºltige Vollbackup-Datei.', 'error');
                        return;
                    }

                    // Stelle alle Daten wieder her
                    if (backup.arbeitszeitData) {
                        data = backup.arbeitszeitData;
                        localStorage.setItem('arbeitszeitData', JSON.stringify(data));
                    }

                    if (backup.feiertage) {
                        feiertage = backup.feiertage;
                        localStorage.setItem('feiertage', JSON.stringify(feiertage));
                    }

                    if (backup.settings) {
                        settings = backup.settings;
                        localStorage.setItem('settings', JSON.stringify(settings));

                        // Update UI mit wiederhergestellten Einstellungen
                        document.getElementById('soll').value = settings.soll || '08:24';
                        document.getElementById('pause').value = settings.pause || '00:30';
                        document.getElementById('ueberzeit-vorgabe').value = settings.ueberzeitVorgabe || '09:00';
                        document.getElementById('settings-urlaub').value = settings.urlaubTage || 25;
                        document.getElementById('settings-resturlaub').value = settings.resturlaubVorjahr || 0;
                        document.getElementById('soll-woche').value = settings.sollWoche || 42;
                        document.getElementById('settings-name').value = settings.name || '';
                        document.getElementById('settings-persnr').value = settings.personalnummer || '';

                        if (settings.ueberzeitStartDatum) {
                            document.getElementById('settings-ueberzeit-datum').value = settings.ueberzeitStartDatum;
                        }
                        if (settings.ueberzeitStartStand !== undefined) {
                            const formatted = formatOvertimeString(settings.ueberzeitStartStand);
                            document.getElementById('settings-ueberzeit-start').value = formatted;
                        }

                        updateUserInfo();
                    }

                    if (backup.sollModus !== undefined) {
                        sollModus = backup.sollModus;
                        localStorage.setItem('sollModus', sollModus);
                    }

                    if (backup.darkMode !== undefined && backup.darkMode !== document.body.classList.contains('dark')) {
                        toggleDark();
                    }

                    // Aktualisiere alle Ansichten
                    calc();
                    loadTag();



                    // Z√§hle importierte Eintr√§ge
                    const eintraegeCount = Object.keys(data).length;
                    const feiertagCount = Object.keys(feiertage).length;

                    showNotification('‚úÖ Backup erfolgreich wiederhergestellt!',
                        `‚Ä¢ ${eintraegeCount} Arbeitszeiteintr√§ge<br>‚Ä¢ ${feiertagCount} Feiertage<br>‚Ä¢ Alle Einstellungen<br>‚Ä¢ Personaldaten<br><br>Alle Daten wurden erfolgreich importiert!`,
                        'success');

                } catch (error) {
                    console.error('Backup Import Error:', error);
                    showNotification('‚ùå Fehler beim Importieren!',
                        'Die Backup-Datei konnte nicht gelesen werden.<br>Bitte √ºberpr√ºfen Sie die Datei.',
                        'error');
                }
            };

            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        document.getElementById('feiertag-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'feiertag-modal') {
                closeFeiertagModal();
            }
        });

        document.getElementById('massenurlaub-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'massenurlaub-modal') {
                closeMassenUrlaub();
            }
        });

        document.getElementById('confirm-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'confirm-modal') {
                document.getElementById('confirm-modal').classList.add('hidden');
            }
        });

        // Toggle label visibility based on input value and focus
        function toggleLabel(id) {
            const input = document.getElementById(id);
            const label = document.getElementById(`label-${id}`);

            if (input && label) {
                // Hide label if input has value OR is focused
                if (input.value || document.activeElement === input) {
                    label.style.display = 'none';
                } else {
                    label.style.display = 'block';
                }
            }

            updateClear();
        }

        // Update clear button visibility
        function updateClear() {
            ['mk', 'mg', 'mittk', 'ag'].forEach(id => {
                const input = document.getElementById(id);
                const clearBtn = document.getElementById(`c-${id}`);

                if (input && clearBtn) {
                    if (input.value) {
                        input.classList.add('has-value'); // Klasse f√ºr CSS hinzuf√ºgen
                        clearBtn.classList.add('on');
                        clearBtn.style.display = 'flex';
                    } else {
                        input.classList.remove('has-value'); // Klasse entfernen
                        clearBtn.classList.remove('on');
                        clearBtn.style.display = 'none';
                    }
                }
            });
        }

        window.addEventListener('click', (e) => {
            if (!e.target.closest('#export-menu') && !e.target.closest('.btn-sec')) {
                document.getElementById('export-menu').classList.add('hidden');
            }
        });

        init();
    </script>

    <!-- ‚è± Automatischer Reload bei neuer Version -->
    <script>
        // Hilfsfunktionen f√ºr Labels und Clear-Buttons
        function toggleLabel(id) {
            const input = document.getElementById(id);
            const label = document.getElementById(`label-${id}`);

            if (input && label) {
                if (input.value) {
                    label.classList.add('hidden');
                } else {
                    label.classList.remove('hidden');
                }
            }
            updateClear();
        }

        function updateClear() {
            ['mk', 'mg', 'mittk', 'ag'].forEach(id => {
                const clearBtn = document.getElementById(`c-${id}`);
                const input = document.getElementById(id);

                if (input && clearBtn) {
                    // Nutze visibility statt display, damit Layout stabil bleibt
                    if (input.value) {
                        input.classList.add('has-value'); // Klasse f√ºr CSS hinzuf√ºgen
                        clearBtn.style.visibility = 'visible';
                        clearBtn.classList.add('visible');
                    } else {
                        input.classList.remove('has-value'); // Klasse entfernen
                        clearBtn.style.visibility = 'hidden';
                        clearBtn.classList.remove('visible');
                    }
                    // Stelle sicher, dass display immer flex ist
                    clearBtn.style.display = 'flex';
                }
            });
        }

        // Version 1.2.72 - Manuell erh√∂hen bei        // Version
        const version = '1.2.81';

        // Initialise user info with fallback placeholders
        const userInfoEl = document.getElementById('user-info');
        if (userInfoEl) {
            const name = localStorage.getItem('user_name');
            const persNr = localStorage.getItem('user_persnr');
            let html = '';
            html += `<div class="user-info-name">${name ? name : 'Name'}</div>`;
            html += `<div class="user-info-persnr">Pers. Nr. ${persNr ? persNr : ''}</div>`;
            userInfoEl.innerHTML = html;
        }

        // Pr√ºfe Version und erzwinge Hard-Reload wenn n√∂tig
        const lastVersion = localStorage.getItem('app_version');

        if (lastVersion !== version) {
            console.log(`Update erkannt: ${lastVersion} ‚Üí ${version}`);
            localStorage.setItem('app_version', version);

            // L√∂sche alle Caches
            if ('caches' in window) {
                caches.keys().then(function (names) {
                    for (let name of names) caches.delete(name);
                });
            }

            // Reload mit Cache-Bypass
            setTimeout(() => {
                window.location.reload(true); // Hard reload
            }, 100);
        }

        // Zus√§tzlich: Pr√ºfe beim Fokus ob Update verf√ºgbar (optional)
        window.addEventListener('focus', function () {
            // Lade Seite mit Cache-Bypass-Parameter neu
            const url = new URL(window.location);
            const currentCheck = url.searchParams.get('v');
            if (!currentCheck || currentCheck !== version) {
                url.searchParams.set('v', version);
                if (currentCheck && currentCheck !== version) {
                    window.location.href = url.toString();
                }
            }
        });
    </script>

    </div>
</body>

</html>